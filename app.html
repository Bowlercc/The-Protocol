<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THE PROTOCOL ‚Äî Matterhood Archive</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&family=Special+Elite&family=Prata&family=Inter:wght@400;700;900&family=Lexend+Mega:wght@400;700&family=DM+Sans:wght@400;700&family=IBM+Plex+Mono:wght@400;600&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;700;800&family=VT323&family=Courier+Prime:wght@400;700&family=Archivo+Black&family=Cinzel:wght@400;700&family=Homemade+Apple&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root{--void:#080808;--charcoal:#121212;--bone:#E8E4DF;--cream:#F5F2ED;--bone-dim:rgba(232,228,223,0.7);--bone-faint:rgba(232,228,223,0.15);--bone-ghost:rgba(232,228,223,0.06);--alert:#C41E1E;--gold:#B8956A;--gold-dim:rgba(184,149,106,0.4);--bg:var(--void);--bg-secondary:var(--charcoal);--text:var(--bone);--text-primary:var(--cream);--border:var(--bone-faint)}
[data-theme="light"]{--void:#FAFAF8;--charcoal:#F0EDE8;--bone:#1A1A1A;--cream:#0A0A0A;--bone-dim:rgba(10,10,10,0.75);--bone-faint:rgba(10,10,10,0.18);--bone-ghost:rgba(10,10,10,0.08);--gold:#7A6545;--bg:var(--void);--bg-secondary:var(--charcoal);--text:var(--bone);--text-primary:var(--cream);--border:var(--bone-faint)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Space Mono',monospace;background:var(--void);color:var(--bone);min-height:100vh;-webkit-font-smoothing:antialiased;transition:background .3s,color .3s}
.film-grain{position:fixed;inset:0;z-index:9999;pointer-events:none;opacity:0.025;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");animation:grain .4s steps(1) infinite}
[data-theme="light"] .film-grain{opacity:0.015}
@keyframes grain{0%,100%{transform:translate(0)}25%{transform:translate(-2%,-2%)}50%{transform:translate(2%,2%)}75%{transform:translate(-2%,2%)}}

/* UI STYLES */
.container{min-height:100vh;display:flex;flex-direction:column}
header{border-bottom:1px solid var(--bone-faint);padding:.82rem 1.15rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--void);backdrop-filter:blur(12px);z-index:100;transition:background .3s}
[data-theme="light"] header{background:rgba(248,246,243,.95)}
.header-left{display:flex;align-items:center;gap:1.15rem}
.logo{font-size:.65rem;font-weight:700;letter-spacing:.3em}
.logo-sub{font-size:.46rem;letter-spacing:.15em;opacity:.3;margin-left:.55rem}
.header-actions{display:flex;align-items:center;gap:.65rem}
.icon-btn{background:transparent;color:var(--bone);border:1px solid var(--bone-faint);width:28px;height:28px;font-family:'Space Mono',monospace;font-size:.55rem;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{background:var(--bone);color:var(--void)}
.rec-indicator{display:flex;align-items:center;gap:.38rem;font-size:.5rem;letter-spacing:.15em}
.rec-dot{width:5px;height:5px;background:var(--alert);border-radius:50%;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.main-content{flex:1;display:flex}
.control-panel{width:355px;min-width:355px;border-right:1px solid var(--bone-faint);padding:1.5rem 1.15rem;display:flex;flex-direction:column;gap:1.1rem;background:var(--charcoal);overflow-y:auto;transition:background .3s}
.section-label{font-size:.46rem;letter-spacing:.2em;opacity:.4;margin-bottom:.4rem}
.input-section{display:flex;flex-direction:column;gap:.4rem}
.input-row{display:flex;gap:.5rem;align-items:flex-end}
.input-row .trigger-input{flex:1}
.surprise-btn{background:var(--bone-ghost);border:1px solid var(--bone-faint);color:var(--bone);width:36px;height:36px;font-size:1rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.surprise-btn:hover{background:var(--gold-dim);border-color:var(--gold)}
.trigger-input{background:transparent;color:var(--bone);border:none;border-bottom:1px solid var(--bone-faint);padding:.65rem 0;font-family:'Space Mono',monospace;font-size:.8rem;outline:none;transition:border-color .3s}
.trigger-input::placeholder{color:rgba(232,228,223,.2);font-style:italic}
.trigger-input:focus{border-bottom-color:var(--bone-dim)}
.triggers-section{display:flex;flex-direction:column;gap:.4rem}
.triggers-grid{display:flex;flex-wrap:wrap;gap:.28rem;max-height:120px;overflow-y:auto;padding-right:.3rem}
.triggers-grid::-webkit-scrollbar{width:4px}
.triggers-grid::-webkit-scrollbar-track{background:var(--bone-ghost);border-radius:2px}
.triggers-grid::-webkit-scrollbar-thumb{background:var(--bone-faint);border-radius:2px}
.triggers-grid::-webkit-scrollbar-thumb:hover{background:var(--bone-dim)}
.trigger-chip{background:var(--bone-ghost);border:1px solid var(--bone-faint);padding:.38rem .55rem;font-size:.62rem;cursor:pointer;transition:all .2s;color:var(--bone-dim);font-family:'Space Mono',monospace}
.trigger-chip:hover{background:var(--bone-faint);color:var(--bone)}
.config-row{display:flex;gap:.6rem;flex-wrap:wrap}
.config-group{flex:1;min-width:140px;display:flex;flex-direction:column;gap:.35rem}
.toggle-group{display:flex;gap:.2rem;flex-wrap:wrap}
.toggle-btn{background:var(--bone-ghost);border:1px solid var(--bone-faint);padding:.4rem .55rem;font-size:.6rem;cursor:pointer;transition:all .2s;color:var(--bone-dim);font-family:'Space Mono',monospace;letter-spacing:.05em}
.toggle-btn:hover{background:var(--bone-faint);color:var(--bone)}
.toggle-btn.active{background:var(--bone);color:var(--void);border-color:var(--bone)}
.spice-toggle{display:flex;gap:.2rem}
.spice-btn{flex:1;background:var(--bone-ghost);border:1px solid var(--bone-faint);padding:.4rem .3rem;font-size:.58rem;cursor:pointer;transition:all .2s;color:var(--bone-dim);font-family:'Space Mono',monospace;text-align:center}
.spice-btn:hover{background:var(--bone-faint);color:var(--bone)}
.spice-btn.active{border-color:var(--gold);color:var(--gold);background:var(--gold-dim)}
.spice-btn.active[data-spice="hot"]{border-color:var(--alert);color:var(--alert);background:rgba(196,30,30,0.15)}
.tone-section{display:flex;flex-direction:column;gap:.4rem}
.tone-buttons{display:flex;flex-direction:column;gap:.28rem}
.tone-btn{background:transparent;color:var(--bone);border:1px solid var(--bone-faint);padding:.75rem .9rem;font-family:'Space Mono',monospace;font-size:.66rem;letter-spacing:.1em;cursor:pointer;transition:all .25s;text-align:left;position:relative;display:flex;justify-content:space-between}
.tone-btn::before{content:'';position:absolute;left:0;top:0;width:2px;height:100%;background:var(--gold);transform:scaleY(0);transition:transform .25s}
.tone-btn:hover{background:var(--bone-ghost);padding-left:1rem}
.tone-btn.active{background:var(--bone);color:var(--void)}
.tone-btn.active::before{background:var(--void);transform:scaleY(1)}
.tone-desc{font-size:.46rem;opacity:.5}
.tone-btn.active .tone-desc{opacity:.7}

/* DISPLAY PANEL */
.display-panel{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.5rem;position:relative;overflow:hidden}
.scene-bg{position:absolute;inset:0;opacity:0;transition:opacity 1s;background-size:cover;background-position:center;filter:grayscale(100%) contrast(1.1)}
.scene-bg.active{opacity:1}
.scene-bg::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(10,10,10,.78) 0%,rgba(10,10,10,.6) 50%,rgba(10,10,10,.78) 100%)}
.script-display{max-width:600px;width:100%;position:relative;z-index:10}
.placeholder-card{text-align:center;padding:2.5rem 1.3rem}
.placeholder-text{font-family:'Playfair Display',serif;font-size:1.2rem;font-style:italic;opacity:.2;line-height:1.8}
.placeholder-text span{display:block}

/* SCRIPT CARD BASE */
.script-card{display:none;padding:1.8rem;background:var(--charcoal);border:1px solid var(--bone-faint);position:relative;transition:all .3s}
.script-card.active{display:block;animation:cardReveal .6s ease forwards}
@keyframes cardReveal{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.script-card::before{content:'';position:absolute;top:0;left:0;width:40px;height:2px;background:var(--gold)}

/* STYLE CLASSES */
/* ARCHIVE */
.style-archive {background: #f0f0f0; border: 1px dashed #333; color: #1a1a1a; box-shadow: 2px 2px 0px rgba(0,0,0,0.1);}
.style-archive::before { background: #C41E1E; width: 60px; height: 3px; }
.style-archive .script-meta, .style-archive .animate-meta { border-bottom: 1px solid #ccc; color: #555; }
.style-archive .script-context, .style-archive .script-trigger-label, .style-archive .script-response-label,
.style-archive .animate-context, .style-archive .animate-label, .style-archive .animate-label-gold { font-family: 'Special Elite', monospace; color: #555; letter-spacing: 0.05em; }
.style-archive .script-response-label, .style-archive .animate-label-gold { color: #C41E1E; }
.style-archive .script-spice, .style-archive .animate-spice { color: #C41E1E; }
.style-archive .script-text, .style-archive .animate-response-text { font-family: 'Special Elite', monospace; color: #111; line-height: 1.6; font-size: 1.1rem; }
.style-archive .script-trigger, .style-archive .animate-trigger-text { font-family: 'Special Elite', monospace; color: #444; }
.style-archive .script-subtext, .style-archive .animate-subtext { color: #555; font-family: 'Space Mono', monospace; }
.style-archive .script-footer, .style-archive .animate-footer { border-top: 1px solid #ccc; color: #555; }

/* NOIR */
.style-noir { background: #000; border: 4px solid #fff; color: #fff; box-shadow: none; }
.style-noir::before { display: none; }
.style-noir .script-meta, .style-noir .animate-meta { border-bottom: 1px solid #333; }
.style-noir .script-context, .style-noir .animate-context { font-family: 'Prata', serif; font-size: 0.6rem; color: #fff; }
.style-noir .script-spice, .style-noir .animate-spice { color: #fff; font-style: italic; font-family: 'Prata', serif; }
.style-noir .script-trigger, .style-noir .animate-trigger-text { color: #999; font-family: 'Prata', serif; font-style: italic; }
.style-noir .script-trigger-label, .style-noir .script-response-label, .style-noir .animate-label, .style-noir .animate-label-gold { font-family: 'Space Mono', monospace; color: #666; }
.style-noir .script-text, .style-noir .animate-response-text { font-family: 'Prata', serif; font-size: 1.8rem; line-height: 1.2; color: #fff; }
.style-noir .script-subtext, .style-noir .animate-subtext { color: #fff; opacity: 0.6; }
.style-noir .script-footer, .style-noir .animate-footer { border-top: 1px solid #333; color: #666; }

/* SWISS */
.style-swiss { background: #F2F2F2; border: none; color: #000; border-radius: 0; }
.style-swiss::before { background: #FF4400; width: 100%; height: 6px; top:0; left:0; }
.style-swiss .script-meta, .style-swiss .animate-meta { border-bottom: 2px solid #000; color: #000; }
.style-swiss .script-context, .style-swiss .animate-context { font-family: 'Inter', sans-serif; font-weight: 700; color: #000; opacity: 1; letter-spacing: -0.02em; }
.style-swiss .script-spice, .style-swiss .animate-spice { font-family: 'Inter', sans-serif; background: #FF4400; color: #fff; padding: 2px 6px; font-weight: 700; }
.style-swiss .script-trigger, .style-swiss .animate-trigger-text { font-family: 'Inter', sans-serif; color: #333; font-weight: 500; background: rgba(255,255,255,0.8); padding: 5px; }
.style-swiss .script-trigger-label, .style-swiss .script-response-label, .style-swiss .animate-label, .style-swiss .animate-label-gold { font-family: 'Inter', sans-serif; font-weight: 700; color: #000; opacity: 1; }
.style-swiss .script-text, .style-swiss .animate-response-text { font-family: 'Inter', sans-serif; font-weight: 700; letter-spacing: -0.04em; color: #000; line-height: 1.1; }
.style-swiss .script-subtext, .style-swiss .animate-subtext { color: #FF4400; font-family: 'Inter', sans-serif; font-weight: 600; }
.style-swiss .script-footer, .style-swiss .animate-footer { border-top: 2px solid #000; color: #000; font-weight: 700; opacity: 1; }

/* BRUTAL */
.style-brutal { background: #0033FF; border: 4px solid #000; color: #CCFF00; box-shadow: 8px 8px 0px #000; }
.style-brutal::before { display: none; }
.style-brutal .script-meta, .style-brutal .animate-meta { background: #CCFF00; margin: -1.8rem -1.8rem 1rem -1.8rem; padding: 1rem; border-bottom: 4px solid #000; }
.style-brutal .script-context, .style-brutal .animate-context { font-family: 'Lexend Mega', sans-serif; color: #000; opacity: 1; font-weight: 700; }
.style-brutal .script-spice, .style-brutal .animate-spice { font-family: 'Lexend Mega', sans-serif; color: #0033FF; font-weight: 700; }
.style-brutal .script-trigger, .style-brutal .animate-trigger-text { font-family: 'Lexend Mega', sans-serif; color: #CCFF00; font-size: 0.7rem; }
.style-brutal .script-trigger-label, .style-brutal .script-response-label, .style-brutal .animate-label, .style-brutal .animate-label-gold { font-family: 'Lexend Mega', sans-serif; color: #000; opacity: 1; background: #CCFF00; display: inline-block; padding: 2px 5px; }
.style-brutal .script-text, .style-brutal .animate-response-text { font-family: 'Lexend Mega', sans-serif; color: #CCFF00; text-transform: uppercase; line-height: 1.2; text-shadow: 2px 2px 0px #000; }
.style-brutal .script-subtext, .style-brutal .animate-subtext { color: #000; font-family: 'Lexend Mega', sans-serif; background: #fff; display: inline-block; padding: 2px; }
.style-brutal .script-footer, .style-brutal .animate-footer { border-top: 4px solid #000; background: #CCFF00; margin: 1rem -1.8rem -1.8rem -1.8rem; padding: 1rem; color: #000; font-family: 'Lexend Mega', sans-serif; opacity: 1; }

/* SOLAR */
.style-solar { background: #FFC857; border: 1px solid #333; color: #000; box-shadow: none; border-radius: 0; }
.style-solar::before { display: none; }
.style-solar .script-meta, .style-solar .animate-meta { border-bottom: 1px dashed #333; }
.style-solar .script-context, .style-solar .animate-context { font-family: 'IBM Plex Mono', monospace; color: #333; font-weight: 600; }
.style-solar .script-spice, .style-solar .animate-spice { font-family: 'IBM Plex Mono', monospace; color: #333; font-weight: 600; text-decoration: underline; }
.style-solar .script-trigger, .style-solar .animate-trigger-text { font-family: 'IBM Plex Mono', monospace; color: #333; }
.style-solar .script-trigger-label, .style-solar .script-response-label, .style-solar .animate-label, .style-solar .animate-label-gold { font-family: 'IBM Plex Mono', monospace; color: #555; }
.style-solar .script-text, .style-solar .animate-response-text { font-family: 'IBM Plex Mono', monospace; color: #000; line-height: 1.4; }
.style-solar .script-subtext, .style-solar .animate-subtext { color: #555; font-family: 'IBM Plex Mono', monospace; font-style: italic; }
.style-solar .script-footer, .style-solar .animate-footer { border-top: 1px dashed #333; color: #333; font-family: 'IBM Plex Mono', monospace; }

/* ESSAY */
.style-essay { background: #FAF9F6; border: none; padding: 2.5rem; color: #333; }
.style-essay::before { display: none; }
.style-essay .script-meta, .style-essay .animate-meta { border-bottom: none; justify-content: center; gap: 1rem; margin-bottom: 2rem; }
.style-essay .script-context, .style-essay .script-spice, .style-essay .animate-context, .style-essay .animate-spice { font-family: 'Libre Baskerville', serif; color: #999; font-style: italic; letter-spacing: 0; text-transform: lowercase; }
.style-essay .script-trigger, .style-essay .animate-trigger-text { font-family: 'Libre Baskerville', serif; color: #555; text-align: center; font-style: italic; }
.style-essay .script-trigger-label, .style-essay .script-response-label, .style-essay .animate-label, .style-essay .animate-label-gold { display: none; }
.style-essay .script-text, .style-essay .animate-response-text { font-family: 'Libre Baskerville', serif; color: #111; line-height: 1.8; text-align: center; font-size: 1.3rem; }
.style-essay .script-subtext, .style-essay .animate-subtext { color: #999; font-family: 'Libre Baskerville', serif; text-align: center; display: block; margin-top: 0; }
.style-essay .script-footer, .style-essay .animate-footer { border-top: none; justify-content: center; gap: 2rem; color: #ccc; font-family: 'Libre Baskerville', serif; font-size: 0.6rem; letter-spacing: 0.2em; text-transform: uppercase; margin-top: 2rem; }

/* VAPOR */
.style-vapor { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); backdrop-filter: blur(8px); color: #fff; }
.style-vapor::before { display: none; }
.style-vapor .script-meta, .style-vapor .animate-meta { border-bottom: 1px solid rgba(255,255,255,0.1); }
.style-vapor .script-context, .style-vapor .animate-context { font-family: 'DM Sans', sans-serif; color: rgba(255,255,255,0.7); letter-spacing: 1px; }
.style-vapor .script-spice, .style-vapor .animate-spice { font-family: 'DM Sans', sans-serif; background: linear-gradient(90deg, #ff8a00, #e52e71); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
.style-vapor .script-trigger, .style-vapor .animate-trigger-text { font-family: 'DM Sans', sans-serif; color: rgba(255,255,255,0.8); }
.style-vapor .script-trigger-label, .style-vapor .script-response-label, .style-vapor .animate-label, .style-vapor .animate-label-gold { font-family: 'DM Sans', sans-serif; color: #8F94FB; letter-spacing: 2px; font-size: 0.5rem; }
.style-vapor .script-text, .style-vapor .animate-response-text { font-family: 'DM Sans', sans-serif; font-weight: 400; color: #fff; line-height: 1.5; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
.style-vapor .script-subtext, .style-vapor .animate-subtext { color: #4E54C8; font-family: 'DM Sans', sans-serif; }
.style-vapor .script-footer, .style-vapor .animate-footer { border-top: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); font-family: 'DM Sans', sans-serif; }

/* NEON */
.style-neon { background: #050505; border: 2px solid #0ff; box-shadow: 0 0 15px #0ff; color: #fff; }
.style-neon::before { display: none; }
.style-neon .script-meta, .style-neon .animate-meta { border-bottom: 1px solid #0ff; }
.style-neon .script-context, .style-neon .animate-context { font-family: 'Syne', sans-serif; color: #0ff; text-transform: uppercase; font-weight: 800; }
.style-neon .script-spice, .style-neon .animate-spice { color: #f0f; font-family: 'Syne', sans-serif; font-weight: 800; text-shadow: 0 0 5px #f0f; }
.style-neon .script-trigger, .style-neon .animate-trigger-text { font-family: 'Syne', sans-serif; color: rgba(255,255,255,0.8); }
.style-neon .script-trigger-label, .style-neon .script-response-label, .style-neon .animate-label, .style-neon .animate-label-gold { font-family: 'Syne', sans-serif; color: #0ff; letter-spacing: 2px; }
.style-neon .script-text, .style-neon .animate-response-text { font-family: 'Syne', sans-serif; font-weight: 800; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
.style-neon .script-subtext, .style-neon .animate-subtext { color: #f0f; font-family: 'Syne', sans-serif; }
.style-neon .script-footer, .style-neon .animate-footer { border-top: 1px solid #0ff; color: #0ff; font-family: 'Syne', sans-serif; }

/* TERMINAL */
.style-terminal { background: #000; border: 1px solid #33ff33; color: #33ff33; font-family: 'VT323', monospace; }
.style-terminal::before { display: none; }
.style-terminal .script-meta, .style-terminal .animate-meta { border-bottom: 1px dashed #33ff33; }
.style-terminal .script-context, .style-terminal .animate-context, .style-terminal .script-spice, .style-terminal .animate-spice, .style-terminal .script-trigger-label, .style-terminal .script-response-label, .style-terminal .animate-label, .style-terminal .animate-label-gold { font-family: 'VT323', monospace; color: #33ff33; letter-spacing: 1px; font-size: 1.2rem; }
.style-terminal .script-text, .style-terminal .animate-response-text, .style-terminal .script-trigger, .style-terminal .animate-trigger-text { font-family: 'VT323', monospace; color: #33ff33; font-size: 1.5rem; line-height: 1.2; text-shadow: 0 0 5px #33ff33; }
.style-terminal .script-subtext, .style-terminal .animate-subtext { color: #33ff33; font-family: 'VT323', monospace; opacity: 0.7; font-size: 1.1rem; }
.style-terminal .script-footer, .style-terminal .animate-footer { border-top: 1px dashed #33ff33; color: #33ff33; font-family: 'VT323', monospace; font-size: 1.2rem; }

/* RECEIPT */
.style-receipt { background: #fff; border: none; color: #000; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 320px; margin: 0 auto; }
.style-receipt::before { background: repeating-linear-gradient(45deg, transparent, transparent 5px, #ccc 5px, #ccc 10px); height: 10px; width: 100%; top: -10px; left: 0; }
.style-receipt .script-meta, .style-receipt .animate-meta { border-bottom: 1px dashed #000; justify-content: center; gap: 20px; }
.style-receipt * { font-family: 'Courier Prime', monospace; text-align: center; }
.style-receipt .script-label, .style-receipt .animate-label, .style-receipt .animate-label-gold { display: block; text-align: center; border-bottom: 1px solid #000; width: 100%; margin-bottom: 5px; }
.style-receipt .script-text, .style-receipt .animate-response-text { font-size: 0.9rem; line-height: 1.4; text-transform: uppercase; }
.style-receipt .script-footer, .style-receipt .animate-footer { border-top: 1px dashed #000; padding-top: 10px; margin-top: 20px; }

/* CINEMA */
.style-cinema { background: #000; border: none; color: #ffcc00; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 3rem; }
.style-cinema::before { display: none; }
.style-cinema .script-meta, .style-cinema .animate-meta { position: absolute; top: 1rem; left: 1rem; width: 90%; border-bottom: none; opacity: 0.5; }
.style-cinema .script-label, .style-cinema .animate-label, .style-cinema .animate-label-gold { display: none; }
.style-cinema .script-text, .style-cinema .animate-response-text { font-family: 'Archivo Black', sans-serif; color: #ffcc00; text-align: center; font-size: 1.8rem; line-height: 1.2; text-shadow: 2px 2px 0 #000; -webkit-text-stroke: 1px rgba(0,0,0,0.5); }
.style-cinema .script-trigger, .style-cinema .animate-trigger-text { display: none; }
.style-cinema .script-subtext, .style-cinema .animate-subtext { color: #fff; font-family: 'Space Mono', monospace; text-align: center; font-size: 0.7rem; opacity: 0.7; margin-bottom: 1rem; }
.style-cinema .script-footer, .style-cinema .animate-footer { display: none; }

/* ZINE */
.style-zine { background: #fff; border: 3px solid #000; color: #000; transform: rotate(-1deg); }
.style-zine::before { display: none; }
.style-zine .script-meta, .style-zine .animate-meta { border-bottom: 3px solid #000; background: #000; color: #fff; padding: 5px; margin: -1.8rem -1.8rem 1rem -1.8rem; transform: rotate(1deg); }
.style-zine .script-text, .style-zine .animate-response-text { font-family: 'Archivo Black', sans-serif; font-size: 1.6rem; text-transform: uppercase; line-height: 0.9; transform: rotate(1deg); }
.style-zine .script-trigger, .style-zine .animate-trigger-text { background: #000; color: #fff; display: inline-block; padding: 2px 5px; font-family: 'Space Mono', monospace; transform: rotate(-2deg); }
.style-zine .script-footer, .style-zine .animate-footer { border-top: 3px solid #000; margin-top: 1rem; padding-top: 0.5rem; font-weight: 900; }

/* ROMANTIC */
.style-romantic { background: #ffe6ea; border: 1px solid #ffb3c1; color: #800f2f; border-radius: 5px; }
.style-romantic::before { display: none; }
.style-romantic .script-meta, .style-romantic .animate-meta { border-bottom: 1px solid #ffb3c1; }
.style-romantic * { font-family: 'Homemade Apple', cursive; }
.style-romantic .script-text, .style-romantic .animate-response-text { font-size: 1.4rem; line-height: 1.6; color: #590d22; }
.style-romantic .script-label, .style-romantic .animate-label, .style-romantic .animate-label-gold { color: #ff8fa3; font-family: 'Prata', serif; font-size: 0.6rem; letter-spacing: 2px; }
.style-romantic .script-footer, .style-romantic .animate-footer { border-top: 1px solid #ffb3c1; color: #ff8fa3; font-family: 'Prata', serif; }

/* BLUEPRINT */
.style-blueprint { background: #0044cc; border: 2px solid #fff; color: #fff; background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px; }
.style-blueprint::before { display: none; }
.style-blueprint .script-meta, .style-blueprint .animate-meta { border-bottom: 2px solid #fff; }
.style-blueprint * { font-family: 'Space Mono', monospace; }
.style-blueprint .script-text, .style-blueprint .animate-response-text { font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
.style-blueprint .script-footer, .style-blueprint .animate-footer { border-top: 2px solid #fff; }

/* CORPORATE */
.style-corporate { background: #c0c0c0; border: 2px solid #fff; border-right-color: #404040; border-bottom-color: #404040; color: #000; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
.style-corporate::before { background: #000080; height: 25px; width: 100%; top: 0; left: 0; content: 'ERROR: REALITY'; color: #fff; font-family: 'Arial', sans-serif; font-size: 12px; display: flex; align-items: center; padding-left: 5px; font-weight: bold; }
.style-corporate .script-meta, .style-corporate .animate-meta { margin-top: 15px; border-bottom: 1px solid #808080; padding-bottom: 5px; }
.style-corporate * { font-family: 'Arial', sans-serif; }
.style-corporate .script-text, .style-corporate .animate-response-text { font-family: 'Times New Roman', serif; font-size: 1.2rem; }
.style-corporate .script-footer, .style-corporate .animate-footer { border-top: 1px solid #808080; margin-top: 15px; padding-top: 5px; font-size: 10px; }

/* LUXE */
.style-luxe { background: #fdfbf7; border: 1px solid #d4af37; color: #111; }
.style-luxe::before { display: none; }
.style-luxe .script-meta, .style-luxe .animate-meta { border-bottom: 1px solid #d4af37; justify-content: center; gap: 30px; }
.style-luxe * { font-family: 'Cinzel', serif; text-align: center; }
.style-luxe .script-text, .style-luxe .animate-response-text { font-size: 1.5rem; line-height: 1.6; color: #000; }
.style-luxe .script-label, .style-luxe .animate-label, .style-luxe .animate-label-gold { color: #d4af37; letter-spacing: 3px; font-size: 0.6rem; margin-top: 15px; display: block; }
.style-luxe .script-footer, .style-luxe .animate-footer { border-top: 1px solid #d4af37; margin-top: 20px; padding-top: 15px; color: #d4af37; letter-spacing: 2px; }

/* MAGAZINE */
.style-magazine { background: #fff; border: none; color: #000; padding: 0; }
.style-magazine::before { display: none; }
.style-magazine .script-meta, .style-magazine .animate-meta { border-bottom: 4px solid #000; padding: 10px; margin-bottom: 2rem; font-weight: 900; letter-spacing: -1px; font-size: 1.5rem; font-family: 'Inter', sans-serif; }
.style-magazine .script-text, .style-magazine .animate-response-text { font-family: 'Prata', serif; font-size: 3rem; line-height: 0.9; letter-spacing: -2px; }
.style-magazine .script-label, .style-magazine .animate-label, .style-magazine .animate-label-gold { font-family: 'Inter', sans-serif; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; background: #000; color: #fff; display: inline-block; padding: 2px 6px; }
.style-magazine .script-footer, .style-magazine .animate-footer { border-top: 1px solid #000; margin-top: 3rem; padding: 10px; font-family: 'Inter', sans-serif; font-weight: 700; text-transform: uppercase; }

/* POLAROID */
.style-polaroid { background: #fff; border: 1px solid #ddd; padding: 15px 15px 60px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #000; }
.style-polaroid::before { display: none; }
.style-polaroid .script-meta, .style-polaroid .animate-meta { display: none; }
.style-polaroid .script-text, .style-polaroid .animate-response-text { font-family: 'Homemade Apple', cursive; font-size: 1.2rem; color: #333; margin-top: 20px; text-align: center; }
.style-polaroid .script-label, .style-polaroid .animate-label, .style-polaroid .animate-label-gold { display: none; }
.style-polaroid .script-footer, .style-polaroid .animate-footer { display: none; }


.script-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--bone-faint)}
.script-context{font-size:.46rem;letter-spacing:.15em;opacity:.4}
.script-spice{font-size:.46rem;letter-spacing:.1em;color:var(--gold)}
.script-spice.hot{color:var(--alert)}
.script-subtext{font-size:.5rem;letter-spacing:.08em;color:var(--gold);margin-bottom:1.1rem;font-style:italic}
.script-subtext::before{content:'SUBTEXT: ';opacity:.5;font-style:normal}
.script-trigger{font-size:.6rem;color:var(--bone-dim);letter-spacing:.05em;margin-bottom:.95rem;line-height:1.6}
.script-trigger-label{display:block;font-size:.46rem;opacity:.4;margin-bottom:.28rem;letter-spacing:.2em}
.script-response{margin-bottom:1.3rem}
.script-response-label{font-size:.46rem;color:var(--gold);margin-bottom:.55rem;letter-spacing:.2em}
.script-text{font-family:'Playfair Display',serif;font-size:clamp(1.2rem,2.3vw,1.65rem);line-height:1.4;color:var(--cream)}
.script-footer{font-size:.46rem;letter-spacing:.15em;opacity:.25;padding-top:.95rem;border-top:1px solid var(--bone-faint);display:flex;justify-content:space-between}
.controls{display:flex;gap:.35rem;justify-content:center;margin-top:1.3rem;flex-wrap:wrap}
.control-btn{background:transparent;color:var(--bone);border:1px solid var(--bone-faint);padding:.58rem .95rem;font-family:'Space Mono',monospace;font-size:.5rem;letter-spacing:.12em;cursor:pointer;transition:all .25s}
.control-btn:hover:not(:disabled){background:var(--bone-ghost);border-color:var(--bone-dim)}
.control-btn:disabled{opacity:.15;cursor:not-allowed}
.control-btn.primary{background:var(--bone);color:var(--void)}
.control-btn.primary:hover:not(:disabled){background:var(--cream)}
.export-options{display:none;position:fixed;inset:0;background:rgba(10,10,10,.95);z-index:1000;align-items:center;justify-content:center}
.export-options.active{display:flex}
.export-modal{background:var(--charcoal);border:1px solid var(--bone-faint);padding:1.8rem;max-width:400px;width:90%;transition:background .3s}
.export-title{font-family:'Playfair Display',serif;font-size:1.3rem;margin-bottom:.35rem}
.export-subtitle{font-size:.55rem;opacity:.5;margin-bottom:1.3rem;letter-spacing:.1em}
.export-formats{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1.3rem}
.export-format-btn{background:var(--bone-ghost);border:1px solid var(--bone-faint);padding:.95rem 1.1rem;cursor:pointer;transition:all .25s;display:flex;justify-content:space-between;align-items:center;font-family:'Space Mono',monospace;color:var(--bone)}
.export-format-btn:hover{background:var(--bone-faint);border-color:var(--bone-dim)}
.export-format-name{font-size:.62rem;letter-spacing:.1em}
.export-format-size{font-size:.5rem;opacity:.4}
.export-close{background:none;border:1px solid var(--bone-faint);color:var(--bone-dim);padding:.55rem 1.1rem;font-family:'Space Mono',monospace;font-size:.5rem;letter-spacing:.1em;cursor:pointer;width:100%}
.export-close:hover{border-color:var(--bone-dim);color:var(--bone)}
.export-toggles{display:flex;flex-direction:column;gap:.6rem;margin-bottom:1.3rem;padding-top:1rem;border-top:1px solid var(--bone-faint)}
.export-toggle{display:flex;align-items:center;gap:.6rem;cursor:pointer;font-size:.58rem;letter-spacing:.05em;color:var(--bone-dim)}
.export-toggle input{appearance:none;width:14px;height:14px;border:1px solid var(--bone-faint);background:transparent;cursor:pointer;position:relative}
.export-toggle input:checked{border-color:var(--gold);background:var(--gold)}
.export-toggle input:checked::after{content:'‚úì';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:9px;color:var(--void)}
.export-toggle:hover{color:var(--bone)}
.caption-section{border-top:1px solid var(--bone-faint);padding-top:1rem;margin-bottom:1rem}
.caption-label{font-size:.5rem;letter-spacing:.15em;opacity:.5;margin-bottom:.6rem}
.caption-suggestions{display:flex;flex-direction:column;gap:.4rem;margin-bottom:.6rem}
.caption-item{background:var(--bone-ghost);border:1px solid var(--bone-faint);padding:.6rem .8rem;font-size:.58rem;line-height:1.5;cursor:pointer;transition:all .2s;color:var(--bone-dim)}
.caption-item:hover{background:var(--bone-faint);color:var(--bone);border-color:var(--bone-dim)}
.caption-item.copied{border-color:var(--gold);color:var(--gold)}
.toast{position:fixed;bottom:1.3rem;left:50%;transform:translateX(-50%) translateY(150%);background:var(--void);border:1px solid var(--gold);color:var(--bone);padding:.8rem 1.1rem;font-size:.5rem;letter-spacing:.1em;z-index:1001;transition:transform .4s;text-align:center}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast a{color:var(--gold);text-decoration:none;margin-left:.35rem}
footer{position:fixed;bottom:0;left:0;right:0;border-top:1px solid var(--bone-faint);padding:.8rem 1.1rem;text-align:center;font-size:.46rem;letter-spacing:.15em;opacity:.35;background:var(--void);z-index:50}
footer a{color:var(--gold);text-decoration:none}

/* Animation Overlay - Fixed Centering & Styling */
.animate-overlay {
    position: fixed;
    inset: 0;
    background: var(--void);
    z-index: 2000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.animate-overlay.active {
    display: flex;
}

.animate-scene {
    position: relative;
    width: 100%;
    height: 100%; 
    max-width: 450px;
    aspect-ratio: 9/16;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.animate-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    opacity: 0.3;
    filter: grayscale(100%);
    z-index: 0;
}

.animate-card {
    position: relative;
    width: 88%;
    background: var(--charcoal);
    border: 1px solid var(--bone-faint);
    padding: 1.8rem;
    display: flex;
    flex-direction: column;
    z-index: 10;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    transition: all .3s;
}


.animate-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 40px;
    height: 2px;
    background: var(--gold);
}

.animate-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--bone-faint);
}

.animate-context {
    font-size: 0.46rem;
    letter-spacing: 0.15em;
    opacity: 0.4;
    text-transform: uppercase;
}

.animate-spice {
    font-size: 0.46rem;
    letter-spacing: 0.1em;
    color: var(--gold);
    text-transform: uppercase;
}

.animate-subtext {
    font-size: 0.5rem;
    letter-spacing: 0.08em;
    color: var(--gold);
    margin-bottom: 1.1rem;
    font-style: italic;
    opacity: 0;
    transform: translateY(10px);
}

.animate-subtext::before {
    content: 'SUBTEXT: ';
    opacity: 0.5;
    font-style: normal;
}

.animate-trigger-wrapper {
    margin-bottom: 0.95rem;
}

.animate-label {
    display: block;
    font-size: 0.46rem;
    opacity: 0.4;
    margin-bottom: 0.28rem;
    letter-spacing: 0.2em;
    color: var(--bone);
    text-transform: uppercase;
}

.animate-trigger-text {
    font-family: 'Space Mono', monospace;
    font-size: 0.6rem;
    color: var(--bone-dim);
    letter-spacing: 0.05em;
    line-height: 1.6;
    opacity: 0;
    display: block;
}

.animate-response-wrapper {
    margin-bottom: 1.3rem;
}

.animate-label-gold {
    font-size: 0.46rem;
    color: var(--gold);
    margin-bottom: 0.55rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
}

.animate-response-text {
    font-family: 'Playfair Display', serif;
    font-size: clamp(1.2rem, 2.3vw, 1.65rem);
    line-height: 1.4;
    color: var(--cream);
    min-height: 2.8rem;
}

/* Word wrapping logic */
.animate-response-text .word {
    display: inline-block;
    white-space: nowrap;
    margin-right: 0.25em;
}

.animate-response-text .char {
    opacity: 0;
    display: inline-block;
}

.animate-footer {
    font-size: 0.46rem;
    letter-spacing: 0.15em;
    opacity: 0.25;
    padding-top: 0.95rem;
    border-top: 1px solid var(--bone-faint);
    display: flex;
    justify-content: space-between;
}

.animate-controls {
    position: absolute;
    bottom: 2rem;
    display: flex;
    gap: 1rem;
    z-index: 20;
    transition: opacity 0.5s ease;
}

.animate-hint {
    position: absolute;
    bottom: 5rem;
    font-size: 0.6rem;
    letter-spacing: 0.15em;
    color: var(--bone-dim);
    opacity: 0.5;
    z-index: 20;
    text-transform: uppercase;
    transition: opacity 0.5s ease;
}

/* Clean mode for recording */
.animate-overlay.clean-mode .animate-controls,
.animate-overlay.clean-mode .animate-hint {
    opacity: 0;
    pointer-events: none;
}

/* Animations */
.animate-subtext.show, .animate-trigger-text.show {
    animation: fadeUp 0.6s ease forwards;
}

.animate-response-text .char.show {
    animation: charIn 0.05s ease forwards;
}

@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes charIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

@media(max-width:900px){
.logo-sub{display:none}
.main-content{flex-direction:column}
.control-panel{width:100%;min-width:0;border-right:none;border-bottom:1px solid var(--bone-faint);padding:1.1rem;max-height:none}
.control-panel.hidden{display:none}
.config-row{flex-direction:column;gap:.5rem}
.config-group{min-width:100%}
.triggers-grid{max-height:none;overflow-y:visible}
.tone-buttons{flex-direction:row;flex-wrap:wrap}
.tone-btn{flex:1 1 calc(50% - .15rem);text-align:center;padding:.6rem .35rem;font-size:.62rem;flex-direction:column;gap:.15rem}
.tone-desc{display:none}
.display-panel{padding:1.1rem;min-height:50vh}
.display-panel.hidden{display:none}
.script-card{padding:1.3rem 1.1rem}
.back-btn{position:absolute;top:.8rem;left:.8rem;z-index:20}
.controls{flex-direction:column;width:100%}
.control-btn{width:100%}
}
@media(min-width:901px){.mobile-only{display:none!important}}
.script-card:not(.active){display:none}
</style>
</head>
<body>
<div class="film-grain"></div>
<div class="tutorial-overlay" id="tutorialOverlay">
<div class="tutorial-content">
<div class="tutorial-step active" data-step="1">
<div class="tutorial-title">The Protocol</div>
<div class="tutorial-text">Scripts for the moments you didn't ask for.<br><br>When someone intrudes on your fertility, your family, or your choices ‚Äî this tool helps you rewrite the scene.</div>
<button class="tutorial-btn" onclick="goToStep(2)">BEGIN</button>
<button class="tutorial-skip" onclick="completeTutorial()">Skip intro</button>
</div>
<div class="tutorial-step" data-step="2">
<div class="tutorial-title">The Trigger</div>
<div class="tutorial-text">Enter what they said, choose a common trigger, or hit üé≤ for a random scenario.</div>
<div class="tutorial-example">
<div class="tutorial-example-label">THEY SAID:</div>
<div class="tutorial-example-text">"You just need to relax and it will happen."</div>
</div>
<button class="tutorial-btn" onclick="goToStep(3)">NEXT</button>
</div>
<div class="tutorial-step" data-step="3">
<div class="tutorial-title">The Calibration</div>
<div class="tutorial-text">Tell us who said it, how spicy you want to go, and whether you speak as "I" or "We".</div>
<div class="tutorial-example">
<div class="tutorial-example-label">SETTINGS:</div>
<div class="tutorial-example-text">Context: Family / Stranger / Colleague / Medical<br>Spice: Mild / Medium / Hot<br>Perspective: I / We</div>
</div>
<button class="tutorial-btn" onclick="goToStep(4)">NEXT</button>
</div>
<div class="tutorial-step" data-step="4">
<div class="tutorial-title">The Voice</div>
<div class="tutorial-text">Choose your tone. Diplomat deflects gracefully. Critic cuts clean. Absurdist finds the dark humour. Realist speaks plain truth.</div>
<div class="tutorial-example">
<div class="tutorial-example-label">THE VOICES:</div>
<div class="tutorial-example-text">Diplomat ‚Äî Graceful boundary<br>Critic ‚Äî Sharp truth<br>Absurdist ‚Äî Deadpan weird<br>Realist ‚Äî Honest acceptance</div>
</div>
<button class="tutorial-btn" onclick="goToStep(5)">NEXT</button>
</div>
<div class="tutorial-step" data-step="5">
<div class="tutorial-title">The Export</div>
<div class="tutorial-text">Export as an image, or hit <strong>ANIMATE</strong> to create a video for your Story. Use "New Take" for variations.</div>
<button class="tutorial-btn" onclick="completeTutorial()">START</button>
</div>
<div class="tutorial-dots">
<div class="tutorial-dot active" data-dot="1"></div>
<div class="tutorial-dot" data-dot="2"></div>
<div class="tutorial-dot" data-dot="3"></div>
<div class="tutorial-dot" data-dot="4"></div>
<div class="tutorial-dot" data-dot="5"></div>
</div>
</div>
</div>
<div class="container">
<header>
<div class="header-left"><div class="logo">THE PROTOCOL<span class="logo-sub">MATTERHOOD</span></div></div>
<div class="header-actions">
<button class="icon-btn" id="themeToggle" title="Toggle light/dark mode">‚òÄ</button>
<button class="icon-btn" onclick="showTutorial()" title="Help">?</button>
<div class="rec-indicator"><div class="rec-dot"></div><span>REC</span></div>
</div>
</header>
<div class="main-content">
<div class="control-panel" id="controlPanel">
<div class="input-section">
<div class="section-label">THEY SAID:</div>
<div class="input-row">
<input type="text" class="trigger-input" id="triggerInput" placeholder="Type what they said...">
<button class="surprise-btn" id="surpriseBtn" title="Random trigger">üé≤</button>
</div>
</div>
<div class="triggers-section">
<div class="section-label">COMMON TRIGGERS:</div>
<div class="triggers-grid" id="triggersGrid"></div>
</div>
<div class="config-row">
<div class="config-group">
<div class="section-label">THEY ARE:</div>
<div class="toggle-group" id="contextGroup">
<button class="toggle-btn active" data-context="stranger">STRANGER</button>
<button class="toggle-btn" data-context="family">FAMILY</button>
<button class="toggle-btn" data-context="colleague">COLLEAGUE</button>
<button class="toggle-btn" data-context="medical">MEDICAL</button>
</div>
</div>
</div>
<div class="config-row">
<div class="config-group">
<div class="section-label">STYLE:</div>
<div class="toggle-group" id="styleGroup" style="flex-wrap: wrap;">
<button class="toggle-btn active" data-style="protocol">PROTOCOL</button>
<button class="toggle-btn" data-style="archive">ARCHIVE</button>
<button class="toggle-btn" data-style="noir">NOIR</button>
<button class="toggle-btn" data-style="swiss">SWISS</button>
<button class="toggle-btn" data-style="brutal">BRUTAL</button>
<button class="toggle-btn" data-style="solar">SOLAR</button>
<button class="toggle-btn" data-style="essay">ESSAY</button>
<button class="toggle-btn" data-style="vapor">VAPOR</button>
<button class="toggle-btn" data-style="neon">NEON</button>
<button class="toggle-btn" data-style="terminal">TERMINAL</button>
<button class="toggle-btn" data-style="romantic">ROMANTIC</button>
<button class="toggle-btn" data-style="blueprint">BLUEPRINT</button>
<button class="toggle-btn" data-style="receipt">RECEIPT</button>
<button class="toggle-btn" data-style="cinema">CINEMA</button>
<button class="toggle-btn" data-style="zine">ZINE</button>
<button class="toggle-btn" data-style="corporate">CORPORATE</button>
<button class="toggle-btn" data-style="luxe">LUXE</button>
<button class="toggle-btn" data-style="magazine">MAGAZINE</button>
<button class="toggle-btn" data-style="polaroid">POLAROID</button>
</div>
</div>
</div>
<div class="config-row">
<div class="config-group">
<div class="section-label">SPICE LEVEL:</div>
<div class="spice-toggle" id="spiceGroup">
<button class="spice-btn" data-spice="mild">MILD</button>
<button class="spice-btn active" data-spice="medium">MEDIUM</button>
<button class="spice-btn" data-spice="hot">HOT</button>
</div>
</div>
<div class="config-group">
<div class="section-label">PERSPECTIVE:</div>
<div class="toggle-group" id="perspectiveGroup">
<button class="toggle-btn" data-perspective="i">I</button>
<button class="toggle-btn active" data-perspective="we">WE</button>
</div>
</div>
</div>
<div class="tone-section">
<div class="section-label">YOUR VOICE:</div>
<div class="tone-buttons">
<button class="tone-btn" data-tone="diplomat"><span>DIPLOMAT</span><span class="tone-desc">Graceful</span></button>
<button class="tone-btn" data-tone="critic"><span>CRITIC</span><span class="tone-desc">Sharp</span></button>
<button class="tone-btn" data-tone="absurdist"><span>ABSURDIST</span><span class="tone-desc">Deadpan</span></button>
<button class="tone-btn" data-tone="realist"><span>REALIST</span><span class="tone-desc">Honest</span></button>
</div>
</div>
</div>
<div class="display-panel" id="displayPanel">
<div class="scene-bg" id="sceneBg"></div>
<button class="control-btn mobile-only back-btn" id="backBtn" style="display:none">‚Üê BACK</button>
<div class="script-display">
<div class="placeholder-card" id="placeholderCard">
<div class="placeholder-text"><span>Enter what they said.</span><span>Calibrate your response.</span><span>Choose your voice.</span></div>
</div>
<div class="script-card" id="scriptCard">
<div class="script-meta">
<span class="script-context" id="contextDisplay">STRANGER</span>
<span class="script-spice" id="spiceDisplay">MEDIUM</span>
</div>
<div class="script-subtext" id="subtextDisplay"></div>
<div class="script-trigger"><span class="script-trigger-label">THEY SAID:</span><span id="triggerDisplay"></span></div>
<div class="script-response"><div class="script-response-label">YOU SAY:</div><div class="script-text" id="scriptText"></div></div>
<div class="script-footer"><span>THE PROTOCOL</span><span>MATTERHOOD</span></div>
</div>
<div class="controls">
<button class="control-btn" id="newTakeBtn" disabled>NEW TAKE</button>
<button class="control-btn" id="copyBtn" disabled>COPY</button>
<button class="control-btn" id="animateBtn" disabled>ANIMATE</button>
<button class="control-btn primary" id="exportBtn" disabled>EXPORT</button>
</div>
</div>
</div>
</div>
<div class="export-options" id="exportOptions">
<div class="export-modal">
<div class="export-title">Export Scene</div>
<div class="export-subtitle">Choose your format</div>
<div class="export-formats">
<button class="export-format-btn" data-format="story"><span class="export-format-name">STORY</span><span class="export-format-size">1080 √ó 1920</span></button>
<button class="export-format-btn" data-format="square"><span class="export-format-name">SQUARE</span><span class="export-format-size">1080 √ó 1080</span></button>
<button class="export-format-btn" data-format="wide"><span class="export-format-name">WIDE</span><span class="export-format-size">1200 √ó 675</span></button>
</div>
<div class="export-toggles">
<label class="export-toggle"><input type="checkbox" id="toggleQR" checked><span class="toggle-label">Include QR code</span></label>
<label class="export-toggle"><input type="checkbox" id="toggleDual"><span class="toggle-label">Add "Why this hurts" card</span></label>
</div>
<div class="caption-section">
<div class="caption-label">CAPTION (tap to copy)</div>
<div class="caption-suggestions" id="captionSuggestions"></div>
</div>
<button class="export-close" id="exportClose">CANCEL</button>
</div>
</div>
<div class="toast" id="toast">EXPORTED</div>
<div class="animate-overlay" id="animateOverlay">
  <div class="animate-scene" id="animateScene">
    <div class="animate-bg" id="animateBg"></div>
    
    <div class="animate-card" id="animateCard">
      <div class="animate-meta">
        <span class="animate-context" id="animContext">STRANGER</span>
        <span class="animate-spice" id="animSpice">HOT</span>
      </div>
      
      <div class="animate-subtext" id="animSubtext"></div>
      
      <div class="animate-trigger-wrapper">
        <span class="animate-label">THEY SAID:</span>
        <span class="animate-trigger-text" id="animTrigger"></span>
      </div>
      
      <div class="animate-response-wrapper">
        <div class="animate-label-gold">YOU SAY:</div>
        <div class="animate-response-text" id="animResponse"></div>
      </div>
      
      <div class="animate-footer">
        <span>THE PROTOCOL</span>
        <span>MATTERHOOD</span>
      </div>
    </div>
  </div>

  <div class="animate-hint">Screen record this for your story</div>
  
  <div class="animate-controls">
    <button class="control-btn" id="replayBtn">REPLAY</button>
    <button class="control-btn" id="animCloseBtn">CLOSE</button>
  </div>
</div>
</div>
<footer>CRAIG & COURTNEY ‚Äî <a href="#">BUY US A CHIP</a></footer>
<script>
// THE PROTOCOL v2.1 ‚Äî Expanded Variation Engine
// Triggers loaded from external JSON

let TRIGGERS = [];

// Tutorial (global scope for onclick handlers)
function goToStep(n){document.querySelectorAll('.tutorial-step').forEach(s=>s.classList.remove('active'));document.querySelector(`.tutorial-step[data-step="${n}"]`)?.classList.add('active');document.querySelectorAll('.tutorial-dot').forEach(d=>d.classList.remove('active'));document.querySelector(`.tutorial-dot[data-dot="${n}"]`)?.classList.add('active');}
function completeTutorial(){localStorage.setItem('protocol_tutorial_v4','true');document.getElementById('tutorialOverlay').classList.add('hidden');}
function showTutorial(){document.getElementById('tutorialOverlay').classList.remove('hidden');goToStep(1);}

// Load triggers from JSON
async function loadTriggers() {
  try {
    const response = await fetch('triggers.json');
    TRIGGERS = await response.json();
    console.log(`Loaded ${TRIGGERS.length} triggers`);
    initApp();
  } catch (err) {
    console.error('Failed to load triggers:', err);
    document.body.innerHTML = '<div style="padding:2rem;color:#c41e1e;">Failed to load response data. Please refresh.</div>';
  }
}

function initApp() {

// ============================================================================
// COMMON TRIGGERS DISPLAY + ENGINE
// ============================================================================

const COMMON_TRIGGERS=["Just relax","Why don't you adopt?","Have you tried IVF?","Everything happens for a reason","My cousin stopped trying","At least you have freedom","Who's the problem?","Tick tock","You'll regret it","You wouldn't understand","Must be nice to sleep in","At least you have each other"];
const CONTEXT_LABELS={stranger:"STRANGER",family:"FAMILY",colleague:"COLLEAGUE",medical:"MEDICAL"};
const SPICE_LABELS={mild:"MILD",medium:"MEDIUM",hot:"HOT"};

let currentTone=null,currentTrigger=null,currentResponse=null,currentImageUrl='',currentSubtext='',currentMatchedTrigger=null;
let context='stranger',spice='medium',perspective='we',currentStyle='protocol';
let usedResponses={};

// Check tutorial on init
if(localStorage.getItem('protocol_tutorial_v4'))document.getElementById('tutorialOverlay').classList.add('hidden');

// Matching - Fuzzy search with multiple strategies
function normalize(t){return t.toLowerCase().replace(/['']/g,"'").replace(/[""]/g,'"').replace(/[?!.,;:]/g,'').replace(/\s+/g,' ').trim();}

// Common filler words to ignore when matching
const FILLER_WORDS=new Set(['a','an','the','you','your','i','my','we','our','just','really','actually','maybe','perhaps','ever','even','so','very','like','know','think','well','oh','um','uh','hey','but','and','or','if','then','have','has','had','do','does','did','should','could','would','can','will','been','being','gonna','gotta','wanna','dont','didnt','cant','wont','youre','youve','youll','ive','im','were','weve','thats','its','hes','shes','theyre','theyve']);

// Remove filler words from text
function removeFillers(text){
  return text.split(' ').filter(w=>!FILLER_WORDS.has(w)).join(' ');
}

// Calculate similarity between two strings (0-1)
function similarity(a,b){
  if(a===b)return 1;
  if(a.length<2||b.length<2)return 0;
  
  // Bigram similarity
  const bigramsA=new Map();
  for(let i=0;i<a.length-1;i++){
    const bg=a.substring(i,i+2);
    bigramsA.set(bg,(bigramsA.get(bg)||0)+1);
  }
  
  let matches=0;
  for(let i=0;i<b.length-1;i++){
    const bg=b.substring(i,i+2);
    if(bigramsA.get(bg)>0){
      matches++;
      bigramsA.set(bg,bigramsA.get(bg)-1);
    }
  }
  
  return (2*matches)/(a.length+b.length-2);
}

// Find best matching trigger
function findMatch(input){
  const n=normalize(input);
  if(!n)return null;
  
  const nNoFill=removeFillers(n);
  
  let bestMatch=null;
  let bestScore=0;
  
  for(const t of TRIGGERS){
    for(const p of t.triggers){
      const pattern=normalize(p);
      const patternNoFill=removeFillers(pattern);
      
      // Strategy 1: Exact substring match (highest confidence)
      if(n.includes(pattern)){
        return t; // Exact match, return immediately
      }
      
      // Strategy 2: Input contains pattern without fillers
      if(nNoFill.includes(patternNoFill)&&patternNoFill.length>3){
        const score=0.95;
        if(score>bestScore){bestScore=score;bestMatch=t;}
        continue;
      }
      
      // Strategy 3: Pattern contained in input (user typed more)
      if(n.includes(patternNoFill)&&patternNoFill.length>3){
        const score=0.9;
        if(score>bestScore){bestScore=score;bestMatch=t;}
        continue;
      }
      
      // Strategy 4: Word overlap scoring
      const patternWords=patternNoFill.split(' ').filter(w=>w.length>2);
      const inputWords=nNoFill.split(' ').filter(w=>w.length>2);
      
      if(patternWords.length>0){
        let wordMatches=0;
        for(const pw of patternWords){
          for(const iw of inputWords){
            // Exact word match
            if(pw===iw){wordMatches++;break;}
            // Fuzzy word match (for typos)
            if(pw.length>3&&iw.length>3&&similarity(pw,iw)>0.7){
              wordMatches+=0.8;break;
            }
          }
        }
        const score=wordMatches/patternWords.length;
        if(score>bestScore&&score>=0.5){
          bestScore=score;
          bestMatch=t;
        }
      }
      
      // Strategy 5: Overall string similarity (catches typos)
      const sim=similarity(nNoFill,patternNoFill);
      if(sim>bestScore&&sim>=0.6){
        bestScore=sim;
        bestMatch=t;
      }
    }
  }
  
  return bestMatch;
}

// Perspective swap
function swapPerspective(text){
if(perspective==='i'){
return text.replace(/\{We're\}/g,"I'm").replace(/\{we're\}/g,"I'm").replace(/\{We've\}/g,"I've").replace(/\{we've\}/g,"I've").replace(/\{We'll\}/g,"I'll").replace(/\{we'll\}/g,"I'll").replace(/\{We'd\}/g,"I'd").replace(/\{we'd\}/g,"I'd").replace(/\{We\}/g,"I").replace(/\{we\}/g,"I").replace(/\{Our\}/g,"My").replace(/\{our\}/g,"my").replace(/\{us\}/g,"me").replace(/\{Us\}/g,"Me").replace(/\{I\}'m/g,"I'm").replace(/\{I\}'ve/g,"I've").replace(/\{I\}'ll/g,"I'll").replace(/\{I\}'d/g,"I'd").replace(/\{I\}/g,"I").replace(/\{I'm\}/g,"I'm").replace(/\{My\}/g,"My").replace(/\{my\}/g,"my").replace(/\{me\}/g,"me");
}else{
return text.replace(/\{We're\}/g,"We're").replace(/\{we're\}/g,"we're").replace(/\{We've\}/g,"We've").replace(/\{we've\}/g,"we've").replace(/\{We'll\}/g,"We'll").replace(/\{we'll\}/g,"we'll").replace(/\{We'd\}/g,"We'd").replace(/\{we'd\}/g,"we'd").replace(/\{We\}/g,"We").replace(/\{we\}/g,"we").replace(/\{Our\}/g,"Our").replace(/\{our\}/g,"our").replace(/\{us\}/g,"us").replace(/\{Us\}/g,"Us").replace(/\{I\}'m/g,"We're").replace(/\{I\}'ve/g,"We've").replace(/\{I\}'ll/g,"We'll").replace(/\{I\}'d/g,"We'd").replace(/\{I\}/g,"We").replace(/\{I'm\}/g,"We're").replace(/\{My\}/g,"Our").replace(/\{my\}/g,"our").replace(/\{me\}/g,"us");
}}

// Get response key
function getResponseKey(trigger,tone,spiceLevel){return `${trigger.triggers[0]}-${tone}-${spiceLevel}`;}

// Get random response
function getRandomResponse(variants,key){
if(!usedResponses[key])usedResponses[key]=[];
const available=variants.filter((_,i)=>!usedResponses[key].includes(i));
if(available.length===0){usedResponses[key]=[];return variants[Math.floor(Math.random()*variants.length)];}
const idx=variants.indexOf(available[Math.floor(Math.random()*available.length)]);
usedResponses[key].push(idx);
return variants[idx];
}

// Scene
function setBackground(url){currentImageUrl=url;const bg=document.getElementById('sceneBg');bg.classList.remove('active');const img=new Image();img.onload=()=>{setTimeout(()=>{bg.style.backgroundImage=`url('${url}')`;bg.classList.add('active');},100);};img.src=url;}

function generateScene(tone){
const input=document.getElementById('triggerInput').value.trim();
if(!input){document.getElementById('triggerInput').focus();return;}
currentTone=tone;
const match=findMatch(input);
currentMatchedTrigger=match;
if(match){
currentSubtext=match.subtext;
const toneResponses=match.responses[tone];
const variants=toneResponses[spice]||toneResponses.medium;
const key=getResponseKey(match,tone,spice);
const rawResponse=Array.isArray(variants)?getRandomResponse(variants,key):variants;
currentResponse=swapPerspective(rawResponse);
setBackground(match.image);
}else{
currentSubtext="A question that doesn't deserve this much thought.";
const fallbacks=["Some questions don't deserve answers. This is one of them.","Not every question deserves {our} energy.","That one's not in {our} script. For good reason.","{We} don't have a rehearsed response for that."];
currentResponse=swapPerspective(fallbacks[Math.floor(Math.random()*fallbacks.length)]);
setBackground('https://images.unsplash.com/photo-1517502884422-41eaead166d4?w=1600&q=80');
}
currentTrigger=input;
document.getElementById('subtextDisplay').textContent=currentSubtext;
document.getElementById('triggerDisplay').textContent=input;
document.getElementById('scriptText').textContent=currentResponse;
document.getElementById('contextDisplay').textContent=CONTEXT_LABELS[context];
document.getElementById('spiceDisplay').textContent=SPICE_LABELS[spice];
document.getElementById('spiceDisplay').className='script-spice'+(spice==='hot'?' hot':'');
document.getElementById('placeholderCard').style.display='none';
const card=document.getElementById('scriptCard');card.classList.remove('active');void card.offsetWidth;card.classList.add('active');
document.getElementById('newTakeBtn').disabled=false;
document.getElementById('copyBtn').disabled=false;
document.getElementById('animateBtn').disabled=false;
document.getElementById('exportBtn').disabled=false;
if(window.innerWidth<=900){document.getElementById('controlPanel').classList.add('hidden');document.getElementById('displayPanel').classList.remove('hidden');document.getElementById('backBtn').style.display='block';}}

// Toggle handlers
function setupToggles(groupId,callback){
document.querySelectorAll(`#${groupId} .toggle-btn, #${groupId} .spice-btn`).forEach(btn=>{
btn.addEventListener('click',()=>{
document.querySelectorAll(`#${groupId} .toggle-btn, #${groupId} .spice-btn`).forEach(b=>b.classList.remove('active'));
btn.classList.add('active');
callback(btn.dataset.context||btn.dataset.spice||btn.dataset.perspective||btn.dataset.style);
});});}
setupToggles('contextGroup',v=>{context=v;});
setupToggles('spiceGroup',v=>{spice=v;});
setupToggles('perspectiveGroup',v=>{perspective=v;});
setupToggles('styleGroup',v=>{
    // Remove previous style from ALL styled elements
    const oldStyle = currentStyle;
    currentStyle = v;
    
    const card = document.getElementById('scriptCard');
    card.classList.remove(`style-${oldStyle}`);
    card.classList.add(`style-${v}`);
    
    const animateOverlay = document.getElementById('animateOverlay');
    animateOverlay.classList.remove(`style-${oldStyle}`);
    animateOverlay.classList.add(`style-${v}`);
    
    const animateCard = document.querySelector('.animate-card');
    animateCard.classList.remove(`style-${oldStyle}`);
    animateCard.classList.add(`style-${v}`);

    // Force re-render if visible
    if(currentTone) generateScene(currentTone);
});

// Chips
COMMON_TRIGGERS.forEach(t=>{const c=document.createElement('button');c.className='trigger-chip';c.textContent=t;c.onclick=()=>{document.getElementById('triggerInput').value=t;};document.getElementById('triggersGrid').appendChild(c);});

// Tone buttons
document.querySelectorAll('.tone-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.tone-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');generateScene(btn.dataset.tone);});});

// Controls
document.getElementById('newTakeBtn').addEventListener('click',()=>{if(currentTone)generateScene(currentTone);});
document.getElementById('copyBtn').addEventListener('click',()=>{if(currentResponse){navigator.clipboard.writeText(currentResponse).then(()=>showToast('COPIED'));}});
document.getElementById('exportBtn').addEventListener('click',()=>{
  generateCaptions();
  document.getElementById('exportOptions').classList.add('active');
});
document.getElementById('exportClose').addEventListener('click',()=>document.getElementById('exportOptions').classList.remove('active'));

// Animation mode
let animationTimeout = null;
let uiTimeout = null;

function playAnimation(){
  // Clear any running animation
  if(animationTimeout)clearTimeout(animationTimeout);
  if(uiTimeout)clearTimeout(uiTimeout);
  
  // Enter clean mode (hide UI)
  const overlay = document.getElementById('animateOverlay');
  overlay.classList.add('clean-mode');
  
  // Set up scene
  document.getElementById('animateBg').style.backgroundImage=`url('${currentImageUrl}')`;
  document.getElementById('animContext').textContent=CONTEXT_LABELS[context];
  document.getElementById('animSpice').textContent=SPICE_LABELS[spice];
  document.getElementById('animSubtext').textContent=currentSubtext; // Prefix handled by CSS
  document.getElementById('animTrigger').textContent=currentTrigger;
  
  // Wrap response in words, then character spans
  const responseEl = document.getElementById('animResponse');
  const words = currentResponse.split(' ');
  const html = words.map(word => {
    const chars = word.split('').map(c => `<span class="char">${c}</span>`).join('');
    return `<span class="word">${chars}</span>`;
  }).join(' ');
  
  responseEl.innerHTML = html;
  
  // Reset states
  document.getElementById('animSubtext').classList.remove('show');
  document.getElementById('animTrigger').classList.remove('show');
  responseEl.querySelectorAll('.char').forEach(c=>c.classList.remove('show'));
  
  // Animate sequence
  setTimeout(()=>document.getElementById('animSubtext').classList.add('show'),300);
  setTimeout(()=>document.getElementById('animTrigger').classList.add('show'),900);
  
  // Type out response
  const chars=responseEl.querySelectorAll('.char');
  chars.forEach((char,i)=>{
    animationTimeout=setTimeout(()=>char.classList.add('show'),1400+i*35);
  });

  // Exit clean mode after animation + buffer
  const totalDuration = 1400 + (chars.length * 35) + 1500;
  uiTimeout = setTimeout(() => {
    overlay.classList.remove('clean-mode');
  }, totalDuration);
}

document.getElementById('animateBtn').addEventListener('click',()=>{
  const overlay = document.getElementById('animateOverlay');
  overlay.classList.add('active');
  // Ensure the current style is applied
  overlay.classList.remove(...Array.from(overlay.classList).filter(c => c.startsWith('style-')));
  overlay.classList.add(`style-${currentStyle}`);
  playAnimation();
});
document.getElementById('replayBtn').addEventListener('click',playAnimation);
document.getElementById('animCloseBtn').addEventListener('click',()=>{
  document.getElementById('animateOverlay').classList.remove('active');
  if(animationTimeout)clearTimeout(animationTimeout);
  if(uiTimeout)clearTimeout(uiTimeout);
  document.getElementById('animateOverlay').classList.remove('clean-mode');
});
document.getElementById('exportOptions').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('active');});

// Surprise me button
document.getElementById('surpriseBtn').addEventListener('click',()=>{
  const randomTrigger=TRIGGERS[Math.floor(Math.random()*TRIGGERS.length)];
  const randomPhrase=randomTrigger.triggers[Math.floor(Math.random()*randomTrigger.triggers.length)];
  document.getElementById('triggerInput').value=randomPhrase;
  
  // Randomize context
  const contexts=['stranger','family','colleague','medical'];
  const randomContext=contexts[Math.floor(Math.random()*contexts.length)];
  context=randomContext;
  document.querySelectorAll('#contextGroup .toggle-btn').forEach(b=>{
    b.classList.toggle('active',b.dataset.context===randomContext);
  });
  
  // Randomize spice
  const spices=['mild','medium','hot'];
  const randomSpice=spices[Math.floor(Math.random()*spices.length)];
  spice=randomSpice;
  document.querySelectorAll('#spiceGroup .spice-btn').forEach(b=>{
    b.classList.toggle('active',b.dataset.spice===randomSpice);
  });
  
  // Randomize style
  const styles=['protocol','archive','noir','swiss','brutal','solar','essay','vapor','neon','terminal','romantic','blueprint','receipt','cinema','zine','corporate','luxe','magazine','polaroid'];
  const randomStyle=styles[Math.floor(Math.random()*styles.length)];
  // Use the setupToggles callback logic directly
  document.querySelectorAll('#styleGroup .toggle-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.style === randomStyle);
  });
  // Manually trigger the style update
  const oldStyle = currentStyle;
  currentStyle = randomStyle;
  
  const card = document.getElementById('scriptCard');
  card.classList.remove(`style-${oldStyle}`);
  card.classList.add(`style-${randomStyle}`);
  
  const animateOverlay = document.getElementById('animateOverlay');
  animateOverlay.classList.remove(`style-${oldStyle}`);
  animateOverlay.classList.add(`style-${randomStyle}`);
  
  const animateCard = document.querySelector('.animate-card');
  animateCard.classList.remove(`style-${oldStyle}`);
  animateCard.classList.add(`style-${randomStyle}`);
  
  // Randomize perspective
  const perspectives=['i','we'];
  const randomPerspective=perspectives[Math.floor(Math.random()*perspectives.length)];
  perspective=randomPerspective;
  document.querySelectorAll('#perspectiveGroup .toggle-btn').forEach(b=>{
    b.classList.toggle('active',b.dataset.perspective===randomPerspective);
  });
  
  // Randomize tone and generate
  const tones=['diplomat','critic','absurdist','realist'];
  const randomTone=tones[Math.floor(Math.random()*tones.length)];
  document.querySelectorAll('.tone-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector(`.tone-btn[data-tone="${randomTone}"]`).classList.add('active');
  generateScene(randomTone);
});

// Caption suggestions
const CAPTIONS=[
  "Things people actually say to us. Here's what we wish we'd said back.",
  "Filed under: comments that don't help.",
  "For everyone who's heard this one before.",
  "Words we've been saving.",
  "What I wanted to say vs. what I said: finally aligned.",
  "This one's for the well-meaning but clueless.",
  "Boundaries, but make it articulate.",
  "The script I needed years ago.",
  "Not all comments deserve a polite response.",
  "Sharing because someone needs to hear this isn't okay."
];

const CAPTIONS_EDUCATIONAL=[
  "Sharing this to help people understand, not to call anyone out.",
  "For those who want to support someone going through this‚Äîhere's what actually helps.",
  "Swipe to see why this comment hurts more than it helps.",
  "Well-meaning doesn't always mean helpful. Here's what to know.",
  "If you've said this, you're not alone. Here's how to do better."
];

function generateCaptions(){
  const isDual=document.getElementById('toggleDual').checked;
  const captionPool=isDual?[...CAPTIONS_EDUCATIONAL,...CAPTIONS.slice(0,3)]:CAPTIONS;
  
  // Pick 3 random captions
  const shuffled=[...captionPool].sort(()=>Math.random()-0.5);
  const selected=shuffled.slice(0,3);
  
  const container=document.getElementById('captionSuggestions');
  container.innerHTML=selected.map((c,i)=>`<div class="caption-item" data-caption-index="${i}">${c}</div>`).join('');
  
  // Store captions for copying
  container.captionData=selected;
  
  // Add click handlers
  container.querySelectorAll('.caption-item').forEach((el,i)=>{
    el.addEventListener('click',()=>{
      const text=selected[i]+' #matterhood';
      navigator.clipboard.writeText(text).then(()=>{
        container.querySelectorAll('.caption-item').forEach(c=>c.classList.remove('copied'));
        el.classList.add('copied');
        showToast('CAPTION COPIED');
      });
    });
  });
}

// Regenerate captions when dual toggle changes
document.getElementById('toggleDual').addEventListener('change',generateCaptions);

// Export formats
document.querySelectorAll('.export-format-btn').forEach(btn=>{
btn.addEventListener('click',async()=>{
const format=btn.dataset.format;
const dims={story:{w:1080,h:1920},square:{w:1080,h:1080},wide:{w:1200,h:675}}[format];
await exportImage(dims.w,dims.h,format);
document.getElementById('exportOptions').classList.remove('active');
});});

async function exportImage(w,h,format){
const isLight=document.documentElement.dataset.theme==='light';
const includeQR=document.getElementById('toggleQR').checked;
const includeDual=document.getElementById('toggleDual').checked;

// THEME CONFIGURATION
const THEMES = {
    protocol: {
        bgColor: isLight?'#FAFAF8':'#080808',
        frameBg: isLight?'#F0EDE8':'#121212',
        textColor: isLight?'#0A0A0A':'#F5F2ED',
        textDim: isLight?'rgba(10,10,10,0.7)':'rgba(232,228,223,0.7)',
        labelColor: isLight?'rgba(10,10,10,0.4)':'rgba(232,228,223,0.4)',
        borderColor: isLight?'rgba(10,10,10,0.15)':'rgba(232,228,223,0.15)',
        goldColor: isLight?'#7A6545':'#B8956A',
        fontMain: "'Space Mono', monospace",
        fontSerif: "'Playfair Display', serif",
        goldBar: true,
        borderWidth: 1,
        borderStyle: [],
        shadow: false
    },
    archive: {
        bgColor: '#e0e0e0', // Desk background
        frameBg: '#f4f4f0', // Paper color
        textColor: '#1a1a1a', // Ink color
        textDim: '#444444',
        labelColor: '#666666',
        borderColor: '#333333',
        goldColor: '#C41E1E', // Red stamp color
        fontMain: "'Special Elite', monospace",
        fontSerif: "'Special Elite', monospace",
        goldBar: true, // Used as red mark
        borderWidth: 1,
        borderStyle: [5, 5], // Dashed border
        shadow: true
    },
    noir: {
        bgColor: '#000000',
        frameBg: '#000000',
        textColor: '#ffffff',
        textDim: '#cccccc',
        labelColor: '#666666',
        borderColor: '#ffffff',
        goldColor: '#ffffff', // White accents in noir
        fontMain: "'Prata', serif", // Use Prata for "Space Mono" spots
        fontSerif: "'Prata', serif",
        goldBar: false,
        borderWidth: 4,
        borderStyle: [],
        shadow: false
    },
    swiss: {
        bgColor: '#F2F2F2',
        frameBg: '#F2F2F2',
        textColor: '#000000',
        textDim: '#333333',
        labelColor: '#000000',
        borderColor: '#000000',
        goldColor: '#FF4400',
        fontMain: "'Inter', sans-serif",
        fontSerif: "'Inter', sans-serif",
        goldBar: false,
        borderWidth: 2,
        borderStyle: [],
        shadow: false
    },
    brutal: {
        bgColor: '#0033FF',
        frameBg: '#0033FF',
        textColor: '#CCFF00', // Neon green text
        textDim: '#CCFF00',
        labelColor: '#000000',
        borderColor: '#000000',
        goldColor: '#000000',
        fontMain: "'Lexend Mega', sans-serif",
        fontSerif: "'Lexend Mega', sans-serif",
        goldBar: false,
        borderWidth: 4,
        borderStyle: [],
        shadow: true
    },
    solar: {
        bgColor: '#FFC857',
        frameBg: '#FFC857',
        textColor: '#000000',
        textDim: '#333333',
        labelColor: '#444444',
        borderColor: '#333333',
        goldColor: '#333333',
        fontMain: "'IBM Plex Mono', monospace",
        fontSerif: "'IBM Plex Mono', monospace",
        goldBar: false,
        borderWidth: 1,
        borderStyle: [2, 2], // Dot/Dash
        shadow: false
    },
    essay: {
        bgColor: '#FAF9F6',
        frameBg: '#FAF9F6',
        textColor: '#111111',
        textDim: '#666666',
        labelColor: '#999999',
        borderColor: 'transparent',
        goldColor: '#999999',
        fontMain: "'Libre Baskerville', serif",
        fontSerif: "'Libre Baskerville', serif",
        goldBar: false,
        borderWidth: 0,
        borderStyle: [],
        shadow: false
    },
    vapor: {
        bgColor: '#16213e',
        frameBg: 'rgba(255,255,255,0.1)', // Glass
        textColor: '#ffffff',
        textDim: 'rgba(255,255,255,0.7)',
        labelColor: '#8F94FB',
        borderColor: 'rgba(255,255,255,0.2)',
        goldColor: '#e52e71',
        fontMain: "'DM Sans', sans-serif",
        fontSerif: "'DM Sans', sans-serif",
        goldBar: false,
        borderWidth: 1,
        borderStyle: [],
        shadow: false
    },
    neon: {
        bgColor: '#050505',
        frameBg: '#050505',
        textColor: '#ffffff',
        textDim: '#cccccc',
        labelColor: '#00ffff',
        borderColor: '#00ffff',
        goldColor: '#ff00ff',
        fontMain: "'Syne', sans-serif",
        fontSerif: "'Syne', sans-serif",
        goldBar: false,
        borderWidth: 2,
        borderStyle: [],
        shadow: false
    },
    terminal: {
        bgColor: '#000000',
        frameBg: '#000000',
        textColor: '#33ff33',
        textDim: '#33ff33',
        labelColor: '#33ff33',
        borderColor: '#33ff33',
        goldColor: '#33ff33',
        fontMain: "'VT323', monospace",
        fontSerif: "'VT323', monospace",
        goldBar: false,
        borderWidth: 1,
        borderStyle: [5, 5],
        shadow: false
    },
    receipt: {
        bgColor: '#ffffff',
        frameBg: '#ffffff',
        textColor: '#000000',
        textDim: '#444444',
        labelColor: '#000000',
        borderColor: 'transparent', // serrated drawn specially
        goldColor: '#000000',
        fontMain: "'Courier Prime', monospace",
        fontSerif: "'Courier Prime', monospace",
        goldBar: false,
        borderWidth: 0,
        borderStyle: [],
        shadow: true
    },
    cinema: {
        bgColor: '#000000',
        frameBg: 'transparent',
        textColor: '#ffcc00', // Subtitle yellow
        textDim: '#ffffff',
        labelColor: 'transparent',
        borderColor: 'transparent',
        goldColor: 'transparent',
        fontMain: "'Archivo Black', sans-serif",
        fontSerif: "'Archivo Black', sans-serif",
        goldBar: false,
        borderWidth: 0,
        borderStyle: [],
        shadow: false
    },
    zine: {
        bgColor: '#ffffff',
        frameBg: '#ffffff',
        textColor: '#000000',
        textDim: '#000000',
        labelColor: '#000000',
        borderColor: '#000000',
        goldColor: '#000000',
        fontMain: "'Space Mono', monospace",
        fontSerif: "'Archivo Black', sans-serif",
        goldBar: false,
        borderWidth: 3,
        borderStyle: [],
        shadow: false
    },
    romantic: {
        bgColor: '#ffe6ea',
        frameBg: '#ffe6ea',
        textColor: '#590d22',
        textDim: '#800f2f',
        labelColor: '#ff8fa3',
        borderColor: '#ffb3c1',
        goldColor: '#ff8fa3',
        fontMain: "'Prata', serif",
        fontSerif: "'Homemade Apple', cursive",
        goldBar: false,
        borderWidth: 1,
        borderStyle: [],
        shadow: false
    },
    blueprint: {
        bgColor: '#0044cc',
        frameBg: '#0044cc',
        textColor: '#ffffff',
        textDim: '#ffffff',
        labelColor: '#ffffff',
        borderColor: '#ffffff',
        goldColor: '#ffffff',
        fontMain: "'Space Mono', monospace",
        fontSerif: "'Space Mono', monospace",
        goldBar: false,
        borderWidth: 2,
        borderStyle: [],
        shadow: false
    },
    corporate: {
        bgColor: '#c0c0c0',
        frameBg: '#c0c0c0',
        textColor: '#000000',
        textDim: '#404040',
        labelColor: '#000080',
        borderColor: '#ffffff',
        goldColor: '#000080',
        fontMain: "'Arial', sans-serif",
        fontSerif: "'Times New Roman', serif",
        goldBar: false,
        borderWidth: 2,
        borderStyle: [],
        shadow: true
    },
    luxe: {
        bgColor: '#fdfbf7',
        frameBg: '#fdfbf7',
        textColor: '#000000',
        textDim: '#333333',
        labelColor: '#d4af37',
        borderColor: '#d4af37',
        goldColor: '#d4af37',
        fontMain: "'Cinzel', serif",
        fontSerif: "'Cinzel', serif",
        goldBar: false,
        borderWidth: 1,
        borderStyle: [],
        shadow: false
    },
    magazine: {
        bgColor: '#ffffff',
        frameBg: '#ffffff',
        textColor: '#000000',
        textDim: '#000000',
        labelColor: '#000000',
        borderColor: 'transparent',
        goldColor: '#000000',
        fontMain: "'Inter', sans-serif",
        fontSerif: "'Prata', serif",
        goldBar: false,
        borderWidth: 0,
        borderStyle: [],
        shadow: false
    },
    polaroid: {
        bgColor: '#ffffff',
        frameBg: '#ffffff',
        textColor: '#333333',
        textDim: '#555555',
        labelColor: 'transparent',
        borderColor: '#dddddd',
        goldColor: 'transparent',
        fontMain: "'Homemade Apple', cursive",
        fontSerif: "'Homemade Apple', cursive",
        goldBar: false,
        borderWidth: 1,
        borderStyle: [],
        shadow: true
    }
};

const theme = THEMES[currentStyle] || THEMES.protocol;
const alertColor='#C41E1E';

// Scale factor for different formats
const baseScale=format==='story'?1:format==='square'?1:1.1;
const scale=w/1080*baseScale;

// Sizes matching website (converted from rem, ~16px base)
const metaSize=Math.round(11*scale);
const subtextSize=Math.round(12*scale);
const triggerLabelSize=Math.round(11*scale);
const triggerSize=Math.round(14*scale);
const responseLabelSize=Math.round(11*scale);
const responseSize=Math.round(format==='wide'?32*scale:38*scale);
const footerSize=Math.round(11*scale);
const padding=Math.round(50*scale);
const qrSize=Math.round(80*scale);
const textW=Math.round(format==='wide'?w*0.65:w*0.72);

// Generate QR code
let qrDataUrl=null;
if(includeQR){
  const qrDiv=document.createElement('div');
  document.body.appendChild(qrDiv);
  new QRCode(qrDiv,{text:window.location.origin,width:qrSize*3,height:qrSize*3,colorDark: theme.textColor, colorLight:'transparent', correctLevel:QRCode.CorrectLevel.M});
  await new Promise(r=>setTimeout(r,150));
  const qrCanvas=qrDiv.querySelector('canvas');
  if(qrCanvas)qrDataUrl=qrCanvas.toDataURL();
  document.body.removeChild(qrDiv);
}

// Helper to create a canvas with background
async function createBaseCanvas(){
  const canvas=document.createElement('canvas');
  canvas.width=w;canvas.height=h;
  const ctx=canvas.getContext('2d');
  
  if (currentStyle === 'vapor') {
      const grad = ctx.createLinearGradient(0, 0, w, h);
      grad.addColorStop(0, '#1a1a2e');
      grad.addColorStop(1, '#16213e');
      ctx.fillStyle = grad;
  } else if (currentStyle === 'blueprint') {
      ctx.fillStyle = theme.bgColor;
      ctx.fillRect(0,0,w,h);
      // Grid pattern for blueprint
      ctx.strokeStyle = "rgba(255,255,255,0.2)";
      ctx.lineWidth = 1;
      const gridSize = 40 * scale;
      for (let x=0; x<w; x+=gridSize) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
      for (let y=0; y<h; y+=gridSize) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke(); }
  } else {
      ctx.fillStyle = theme.bgColor;
      ctx.fillRect(0,0,w,h);
  }
  
  if(currentImageUrl){
    try{
      const img=new Image();img.crossOrigin='anonymous';
      await new Promise((res,rej)=>{img.onload=res;img.onerror=rej;img.src=currentImageUrl;});
      const imgScale=Math.max(w/img.width,h/img.height);
      const sw=img.width*imgScale,sh=img.height*imgScale;
      
      // Theme specific image filters
      if(currentStyle === 'noir') {
          ctx.filter='grayscale(100%) contrast(1.5) brightness(0.7)';
          ctx.globalAlpha=0.4;
      } else if (currentStyle === 'archive') {
          ctx.filter='sepia(50%) contrast(0.9) brightness(1.1)';
          ctx.globalAlpha=0.15;
      } else if (currentStyle === 'swiss') {
          ctx.filter='grayscale(100%) contrast(1.2)';
          ctx.globalAlpha=0.2;
      } else if (currentStyle === 'brutal') {
          ctx.filter='grayscale(100%) contrast(1.5)';
          ctx.globalAlpha=0.1; // Subtle texture
      } else if (currentStyle === 'vapor') {
           ctx.filter='contrast(1.1) brightness(0.8) hue-rotate(15deg)';
           ctx.globalAlpha=0.3;
      } else if (currentStyle === 'neon') {
           ctx.filter='grayscale(100%) contrast(1.2) brightness(0.5)';
           ctx.globalAlpha=0.3;
      } else if (currentStyle === 'cinema') {
           ctx.filter='grayscale(100%) contrast(1.1) brightness(0.6)';
           ctx.globalAlpha=0.8;
      } else if (currentStyle === 'zine') {
           ctx.filter='grayscale(100%) contrast(3.0) brightness(1.2)'; // Photocopy look
           ctx.globalAlpha=0.15;
      } else if (currentStyle === 'polaroid') {
           ctx.filter='contrast(1.2) saturation(1.2) sepia(20%)';
           ctx.globalAlpha=1.0;
           // Draw photo inside frame later
           return {canvas, ctx}; 
      } else {
          ctx.globalAlpha=isLight?0.12:0.25;
          ctx.filter='grayscale(100%) contrast(1.1)';
      }
      
      if (currentStyle !== 'polaroid') {
        ctx.drawImage(img,(w-sw)/2,(h-sh)/2,sw,sh);
      }
      ctx.globalAlpha=1;ctx.filter='none';
    }catch(e){}
  }
  return {canvas,ctx};
}

// Helper to draw response card
async function drawResponseCard(ctx,areaW,areaH){
  // Polaroid is special case - draws photo instead of card
  if (currentStyle === 'polaroid') {
       if (currentImageUrl) {
            const img=new Image();img.crossOrigin='anonymous';
            await new Promise((res)=>{img.onload=res;img.src=currentImageUrl;});
            // Draw photo area
            const photoMargin = 60 * scale;
            const photoW = w - (photoMargin * 2);
            const photoH = w - (photoMargin * 2); // Square photo
            const photoX = photoMargin;
            const photoY = photoMargin;
            
            // Draw image cropped to square
            ctx.save();
            ctx.beginPath();
            ctx.rect(photoX, photoY, photoW, photoH);
            ctx.clip();
            const imgScale=Math.max(photoW/img.width, photoH/img.height);
            ctx.drawImage(img, photoX, photoY, img.width*imgScale, img.height*imgScale);
            ctx.restore();
            
            // Draw text at bottom
            ctx.fillStyle = "#333";
            ctx.textAlign = "center";
            ctx.font = `24px 'Homemade Apple', cursive`;
            ctx.fillText(currentResponse, w/2, h - 80 * scale);
       }
       return;
  }

  // Calculate content height first
  let contentH=0;
  if (currentStyle === 'brutal') contentH += padding; 
  if (currentStyle === 'receipt') contentH += padding * 2;

  contentH+=metaSize+padding*0.5+padding*0.4;
  
  ctx.font=`italic ${subtextSize}px ${theme.fontMain}`;
  if(['swiss','brutal','solar','terminal','blueprint','corporate'].includes(currentStyle)) ctx.font=`${subtextSize}px ${theme.fontMain}`;
  
  const subtextLines=wrapText(ctx,'SUBTEXT: '+currentSubtext,textW);
  contentH+=subtextLines.length*subtextSize*1.6+padding*0.6;
  
  // Trigger section
  if (currentStyle !== 'cinema' && currentStyle !== 'luxe' && currentStyle !== 'magazine') {
      contentH+=triggerLabelSize+padding*0.15;
      ctx.font=`${triggerSize}px ${theme.fontMain}`;
      if(currentStyle === 'noir') ctx.font=`italic ${triggerSize}px ${theme.fontMain}`;
      if(currentStyle === 'essay') ctx.font=`italic ${triggerSize}px ${theme.fontSerif}`;
      
      const triggerLines=wrapText(ctx,currentTrigger,textW);
      contentH+=triggerLines.length*triggerSize*1.6+padding*0.5;
  }
  
  // Response section
  contentH+=responseLabelSize+padding*0.35;
  ctx.font=`400 ${responseSize}px ${theme.fontSerif}`;
  if(['swiss','brutal','solar','terminal','blueprint'].includes(currentStyle)) ctx.font=`700 ${responseSize}px ${theme.fontSerif}`;
  if(currentStyle === 'magazine') ctx.font=`400 ${responseSize * 1.5}px ${theme.fontSerif}`;

  const responseLines=wrapText(ctx,currentResponse,textW);
  contentH+=responseLines.length*responseSize*1.35+padding*0.7;
  
  if(includeQR)contentH+=qrSize+padding*0.4;
  contentH+=padding*0.5+footerSize;

  const frameW=textW+padding*2;
  const frameH=contentH+padding*2;
  const frameX=(areaW-frameW)/2;
  const frameY=(areaH-frameH)/2;

  // 1. SHADOWS
  if(currentStyle === 'brutal') {
      ctx.fillStyle = "#000";
      ctx.fillRect(frameX + 15, frameY + 15, frameW, frameH);
  }
  if(currentStyle === 'corporate') {
      // Windows 95 shadow
      ctx.fillStyle = "#404040";
      ctx.fillRect(frameX + 4, frameY + 4, frameW, frameH);
  }

  // 2. FRAME BACKGROUND
  ctx.fillStyle=theme.frameBg;
  if(currentStyle === 'cinema') ctx.fillStyle = "transparent";
  
  // Zine Rotation logic
  if(currentStyle === 'zine') {
      ctx.save();
      ctx.translate(w/2, h/2);
      ctx.rotate(-2 * Math.PI / 180);
      ctx.translate(-w/2, -h/2);
      ctx.fillStyle = "#fff";
      ctx.fillRect(frameX, frameY, frameW, frameH);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 3;
      ctx.strokeRect(frameX, frameY, frameW, frameH);
      ctx.restore();
  } else {
      if (currentStyle !== 'polaroid') ctx.fillRect(frameX,frameY,frameW,frameH);
  }
  
  // 3. BORDERS
  if(theme.borderWidth > 0 && currentStyle !== 'zine' && currentStyle !== 'cinema') {
      ctx.strokeStyle=theme.borderColor;
      ctx.lineWidth=theme.borderWidth;
      if(theme.borderStyle.length) ctx.setLineDash(theme.borderStyle);
      
      // Receipt serrated edge
      if(currentStyle === 'receipt') {
          // Draw standard rect
      } else if (currentStyle === 'corporate') {
          // Bevel border
          ctx.lineWidth = 2;
          ctx.strokeStyle = "#fff"; // Top/Left light
          ctx.beginPath(); ctx.moveTo(frameX+frameW, frameY); ctx.lineTo(frameX, frameY); ctx.lineTo(frameX, frameY+frameH); ctx.stroke();
          ctx.strokeStyle = "#404040"; // Bottom/Right dark
          ctx.beginPath(); ctx.moveTo(frameX+frameW, frameY); ctx.lineTo(frameX+frameW, frameY+frameH); ctx.lineTo(frameX, frameY+frameH); ctx.stroke();
          
          // Blue Title Bar
          ctx.fillStyle = "#000080";
          ctx.fillRect(frameX+4, frameY+4, frameW-8, 30);
          ctx.fillStyle = "#fff";
          ctx.font = "bold 14px Arial";
          ctx.fillText("ERROR: REALITY", frameX + 10, frameY + 24);
      } else {
          ctx.strokeRect(frameX,frameY,frameW,frameH);
      }
      ctx.setLineDash([]);
  }
  
  // Gold accent bar
  if(theme.goldBar) {
      ctx.fillStyle=theme.goldColor;
      ctx.fillRect(frameX,frameY,Math.round(40*scale),3); 
  }

  // Neon glow
  if(currentStyle === 'neon') {
      ctx.shadowColor = "#0ff";
      ctx.shadowBlur = 20;
      ctx.strokeStyle = "#0ff";
      ctx.lineWidth = 2;
      ctx.strokeRect(frameX, frameY, frameW, frameH);
      ctx.shadowBlur = 0;
  }

  // --- CONTENT DRAWING ---
  
  let contentX=frameX+padding;
  let contentRight=frameX+frameW-padding;
  let y=frameY+padding;
  
  // Adjust Y for Corporate header
  if(currentStyle === 'corporate') y += 30;

  // Zine Rotation Context
  if(currentStyle === 'zine') {
      ctx.save();
      ctx.translate(w/2, h/2);
      ctx.rotate(-1 * Math.PI / 180);
      ctx.translate(-w/2, -h/2);
  }

  // === META ROW ===
  // Skip meta for clean styles
  if(!['polaroid', 'cinema', 'magazine', 'luxe'].includes(currentStyle)) {
      // Brutal Header
      if(currentStyle === 'brutal') {
          ctx.fillStyle = "#CCFF00"; 
          ctx.fillRect(frameX, frameY, frameW, metaSize * 4);
          ctx.strokeStyle = "#000";
          ctx.lineWidth = 4;
          ctx.beginPath();
          ctx.moveTo(frameX, frameY + metaSize * 4);
          ctx.lineTo(frameX + frameW, frameY + metaSize * 4);
          ctx.stroke();
          y += padding * 0.5;
      }

      ctx.font=`${metaSize}px ${theme.fontMain}`;
      if(currentStyle === 'swiss') ctx.font=`700 ${metaSize}px ${theme.fontMain}`;

      ctx.textAlign='left';
      ctx.fillStyle=theme.labelColor;
      if(currentStyle === 'brutal') ctx.fillStyle = "#000"; 
      if(currentStyle === 'swiss') ctx.fillStyle = "#fff";

      ctx.fillText(CONTEXT_LABELS[context],contentX,y+metaSize);
      
      ctx.textAlign='right';
      ctx.fillStyle=spice==='hot'?alertColor:theme.goldColor;
      if(['noir', 'terminal', 'blueprint', 'corporate', 'neon'].includes(currentStyle)) ctx.fillStyle = theme.goldColor;
      if(currentStyle === 'brutal') ctx.fillStyle = '#0033FF'; 
      if(currentStyle === 'swiss') {
          const spiceW = ctx.measureText(SPICE_LABELS[spice]).width;
          ctx.fillStyle = "#fff";
          ctx.fillRect(contentRight - spiceW - 10, y, spiceW + 20, metaSize + 4);
          ctx.fillStyle = "#000";
          ctx.fillText(SPICE_LABELS[spice],contentRight - 5,y+metaSize);
      } else {
          ctx.fillText(SPICE_LABELS[spice],contentRight,y+metaSize);
      }
      
      y+=metaSize+padding*0.5;
      
      // Meta border-bottom
      if(!['brutal', 'receipt', 'essay', 'corporate'].includes(currentStyle)) {
          ctx.strokeStyle=theme.borderColor;
          ctx.lineWidth = currentStyle === 'swiss' ? 2 : theme.borderWidth;
          if(currentStyle === 'solar' || currentStyle === 'terminal' || currentStyle === 'receipt') ctx.setLineDash([4, 4]);
          ctx.beginPath();
          ctx.moveTo(contentX,y);
          ctx.lineTo(contentRight,y);
          ctx.stroke();
          ctx.setLineDash([]);
      }
      y+=padding*0.4;
  }

  // === SUBTEXT ===
  if(currentStyle !== 'essay') {
    ctx.textAlign='left';
    ctx.fillStyle=theme.goldColor;
    if(['noir', 'swiss', 'terminal', 'blueprint', 'neon'].includes(currentStyle)) ctx.fillStyle = theme.textColor;
    if(currentStyle === 'brutal') ctx.fillStyle = "#fff"; // Bg block
  } else {
    ctx.textAlign='center';
    ctx.fillStyle = theme.labelColor;
  }
  
  ctx.font=`italic ${subtextSize}px ${theme.fontMain}`;
  if(['swiss', 'brutal', 'solar', 'terminal', 'blueprint'].includes(currentStyle)) ctx.font=`${subtextSize}px ${theme.fontMain}`;
  if(currentStyle === 'essay') ctx.font=`${subtextSize}px ${theme.fontSerif}`;
  if(currentStyle === 'cinema') { ctx.fillStyle = "#fff"; ctx.textAlign = "center"; contentX = frameX + frameW/2; }

  subtextLines.forEach((line,i)=>{
    if(currentStyle === 'brutal') {
         const w = ctx.measureText(line).width;
         ctx.fillStyle = "#fff";
         ctx.fillRect(contentX, y, w + 10, subtextSize + 10);
         ctx.fillStyle = "#000";
         ctx.fillText(line,contentX + 5,y+subtextSize + 5);
    } else if(currentStyle === 'essay' || currentStyle === 'cinema') {
         ctx.fillText(line, frameX + frameW/2, y+subtextSize);
    } else {
        ctx.fillText(line,contentX,y+subtextSize);
    }
    y+=subtextSize*1.6;
  });
  y+=padding*0.6;

  // === THEY SAID ===
  // Hidden for minimal styles
  if(!['essay', 'cinema', 'luxe', 'magazine'].includes(currentStyle)) {
      ctx.textAlign = 'left';
      ctx.fillStyle=theme.labelColor;
      if(currentStyle === 'brutal') { ctx.fillStyle = "#000"; ctx.fillRect(contentX, y, 120, triggerLabelSize + 8); ctx.fillStyle = "#CCFF00"; } 
      if(currentStyle === 'swiss') ctx.fillStyle = "#fff"; 
      if(currentStyle === 'zine') { ctx.fillStyle = "#000"; ctx.fillRect(contentX, y-10, 100, triggerLabelSize + 4); ctx.fillStyle = "#fff"; }

      ctx.font=`${triggerLabelSize}px ${theme.fontMain}`;
      if(currentStyle === 'swiss') ctx.font=`700 ${triggerLabelSize}px ${theme.fontMain}`;

      ctx.fillText('THEY SAID:',contentX + (currentStyle==='brutal'?5:0),y+triggerLabelSize + (currentStyle==='brutal'?4:0));
      y+=triggerLabelSize+padding*0.15;
  }
  
  if(currentStyle !== 'cinema') {
      ctx.fillStyle=theme.textDim;
      ctx.font=`${triggerSize}px ${theme.fontMain}`;
      if(currentStyle === 'noir') ctx.font=`italic ${triggerSize}px ${theme.fontMain}`;
      if(currentStyle === 'brutal') { ctx.fillStyle = "#CCFF00"; }
      if(currentStyle === 'swiss') { ctx.fillStyle = "#000"; ctx.font=`500 ${triggerSize}px ${theme.fontMain}`; }
      if(currentStyle === 'essay') { ctx.textAlign = 'center'; ctx.font=`italic ${triggerSize}px ${theme.fontSerif}`; ctx.fillStyle = theme.labelColor; }
      if(currentStyle === 'zine') { ctx.font=`${triggerSize}px 'Space Mono', monospace`; ctx.fillStyle = "#000"; }

      triggerLines.forEach(line=>{
        if(currentStyle === 'swiss') {
            const w = ctx.measureText(line).width;
            ctx.fillStyle = "rgba(255,255,255,0.9)";
            ctx.fillRect(contentX - 5, y - triggerSize + 5, w + 10, triggerSize + 10);
            ctx.fillStyle = "#000";
        }
        if(currentStyle === 'essay') {
            ctx.fillText(`"${line}"`, frameX + frameW/2, y+triggerSize);
        } else {
            ctx.fillText(line,contentX,y+triggerSize);
        }
        y+=triggerSize*1.6;
      });
      y+=padding*0.5;
  }

  // === YOU SAY ===
  if(!['essay', 'cinema', 'magazine', 'luxe'].includes(currentStyle)) {
      ctx.textAlign = 'left';
      ctx.fillStyle=theme.goldColor;
      if(currentStyle === 'brutal') { ctx.fillStyle = "#000"; ctx.fillRect(contentX, y, 100, responseLabelSize + 8); ctx.fillStyle = "#CCFF00"; }
      if(currentStyle === 'swiss') { ctx.fillStyle = "#fff"; }
      if(currentStyle === 'zine') { ctx.fillStyle = "#000"; ctx.fillRect(contentX, y-10, 80, responseLabelSize + 4); ctx.fillStyle = "#fff"; }

      ctx.font=`${responseLabelSize}px ${theme.fontMain}`;
      if(currentStyle === 'swiss') ctx.font=`700 ${responseLabelSize}px ${theme.fontMain}`;

      ctx.fillText('YOU SAY:',contentX + (currentStyle==='brutal'?5:0),y+responseLabelSize + (currentStyle==='brutal'?4:0));
      y+=responseLabelSize+padding*0.35;
  } else if (currentStyle === 'luxe') {
       ctx.textAlign = 'center';
       ctx.fillStyle = theme.goldColor;
       ctx.font = `${responseLabelSize}px ${theme.fontSerif}`;
       ctx.fillText('‚Äî RESPONSE ‚Äî', frameX + frameW/2, y+responseLabelSize);
       y+=responseLabelSize+padding*0.5;
  }
  
  ctx.fillStyle=theme.textColor;
  ctx.font=`400 ${responseSize}px ${theme.fontSerif}`;
  if(['swiss','brutal','solar','terminal','blueprint'].includes(currentStyle)) ctx.font=`700 ${responseSize}px ${theme.fontSerif}`;
  if(currentStyle === 'brutal') { ctx.font=`700 ${responseSize}px ${theme.fontMain}`; ctx.fillStyle = "#CCFF00"; }
  if(currentStyle === 'solar') { ctx.font=`400 ${responseSize}px ${theme.fontMain}`; }
  if(currentStyle === 'essay' || currentStyle === 'luxe' || currentStyle === 'magazine' || currentStyle === 'cinema') { ctx.textAlign = 'center'; }
  if(currentStyle === 'zine') { ctx.font=`900 ${responseSize*1.2}px 'Archivo Black', sans-serif`; ctx.fillStyle = "#000"; }
  if(currentStyle === 'magazine') { ctx.font=`400 ${responseSize * 1.5}px ${theme.fontSerif}`; ctx.fillStyle="#000"; }
  if(currentStyle === 'cinema') { ctx.font=`900 ${responseSize * 1.3}px 'Archivo Black', sans-serif`; ctx.fillStyle="#FFCC00"; ctx.shadowColor="rgba(0,0,0,0.8)"; ctx.shadowBlur=10; }

  responseLines.forEach(line=>{
      if(currentStyle === 'brutal') {
          // Hard shadow for text
          ctx.fillStyle = "#000";
          ctx.fillText(line,contentX + 2,y+responseSize*0.85 + 2);
          ctx.fillStyle = "#CCFF00";
      }
      if(['essay', 'luxe', 'magazine', 'cinema'].includes(currentStyle)) {
          ctx.fillText(line, frameX + frameW/2, y+responseSize*0.85);
      } else {
          ctx.fillText(line,contentX,y+responseSize*0.85);
      }
      y+=responseSize*1.35;
  });
  y+=padding*0.7;

  // Restore Zine rotation
  if(currentStyle === 'zine') ctx.restore();

  // === QR CODE ===
  if(includeQR&&qrDataUrl){
    const qrImg=new Image();
    await new Promise(r=>{qrImg.onload=r;qrImg.src=qrDataUrl;});
    
    let qrX = contentRight-qrSize;
    if(['essay', 'cinema', 'luxe', 'magazine', 'receipt'].includes(currentStyle)) qrX = frameX + (frameW - qrSize)/2; // Center QR for centered layouts
    
    ctx.drawImage(qrImg,qrX,y,qrSize,qrSize);
    y+=qrSize+padding*0.4;
  }

  // === FOOTER ===
  if(currentStyle === 'brutal') {
      ctx.fillStyle = "#CCFF00";
      ctx.fillRect(frameX, y, frameW, 60);
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(frameX, y);
      ctx.lineTo(frameX + frameW, y);
      ctx.stroke();
      y += 20;
      ctx.fillStyle = "#000";
  } else if (!['essay', 'cinema', 'magazine', 'luxe'].includes(currentStyle)) {
    ctx.strokeStyle=theme.borderColor;
    if(currentStyle === 'swiss') ctx.lineWidth = 2;
    if(['solar', 'terminal', 'receipt'].includes(currentStyle)) ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(contentX,y);
    ctx.lineTo(contentRight,y);
    ctx.stroke();
    ctx.setLineDash([]);
    y+=padding*0.5;
    ctx.fillStyle=theme.labelColor;
    if(currentStyle === 'swiss') ctx.fillStyle = "#fff";
  }
  
  if(['essay', 'cinema', 'magazine', 'luxe', 'receipt'].includes(currentStyle)) {
      ctx.textAlign = 'center';
      ctx.font = `italic ${footerSize}px ${theme.fontSerif}`;
      if(currentStyle === 'cinema') { ctx.fillStyle = "rgba(255,255,255,0.5)"; ctx.font = `${footerSize}px 'Space Mono', monospace`; }
      else if (currentStyle === 'luxe') { ctx.fillStyle = theme.goldColor; ctx.font = `${footerSize}px ${theme.fontSerif}`; }
      else if (currentStyle === 'magazine') { ctx.fillStyle = "#000"; ctx.font = `900 ${footerSize}px 'Inter', sans-serif`; }
      else ctx.fillStyle = theme.labelColor;
      
      ctx.fillText('THE PROTOCOL ¬∑ MATTERHOOD', frameX + frameW/2, y+footerSize);
  } else {
      ctx.font=`${footerSize}px ${theme.fontMain}`;
      if(currentStyle === 'swiss' || currentStyle === 'brutal') ctx.font=`700 ${footerSize}px ${theme.fontMain}`;
      
      ctx.textAlign='left';
      ctx.fillText('THE PROTOCOL',contentX,y+footerSize);
      ctx.textAlign='right';
      ctx.fillText('MATTERHOOD',contentRight,y+footerSize);
  }
}

// Draw based on updated logic
const {canvas:canvas1,ctx:ctx1}=await createBaseCanvas();
await drawResponseCard(ctx1,w,h);
const link1=document.createElement('a');
link1.download=`protocol-${currentStyle}-${format}-response-${Date.now()}.png`;
link1.href=canvas1.toDataURL('image/png');
link1.click();

// Export education card if dual mode
if(includeDual){
  await new Promise(r=>setTimeout(r,500)); // Delay between downloads
  const {canvas:canvas2,ctx:ctx2}=await createBaseCanvas();
  await drawEducationCard(ctx2,w,h);
  const link2=document.createElement('a');
  link2.download=`protocol-${format}-why-${Date.now()}.png`;
  link2.href=canvas2.toDataURL('image/png');
  link2.click();
  showToast('EXPORTED 2 IMAGES');
}else{
  showToast('EXPORTED');
}
}

function wrapText(ctx,text,maxW){const words=text.split(' '),lines=[];let line='';for(const word of words){const test=line?line+' '+word:word;if(ctx.measureText(test).width>maxW&&line){lines.push(line);line=word;}else{line=test;}}if(line)lines.push(line);return lines;}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// Mobile
document.getElementById('backBtn').addEventListener('click',()=>{document.getElementById('controlPanel').classList.remove('hidden');document.getElementById('displayPanel').classList.add('hidden');document.getElementById('backBtn').style.display='none';});

// Theme toggle
const themeToggle=document.getElementById('themeToggle');
function setTheme(theme){
document.documentElement.dataset.theme=theme;
themeToggle.textContent=theme==='light'?'‚òæ':'‚òÄ';
localStorage.setItem('protocol_theme',theme);
}
themeToggle.addEventListener('click',()=>{
const current=document.documentElement.dataset.theme;
setTheme(current==='light'?'dark':'light');
});
const savedTheme=localStorage.getItem('protocol_theme')||'dark';
setTheme(savedTheme);

// Enter key
document.getElementById('triggerInput').addEventListener('keydown',e=>{if(e.key==='Enter'){const activeTone=document.querySelector('.tone-btn.active');if(activeTone){generateScene(activeTone.dataset.tone);}else{document.querySelector('.tone-btn[data-tone="diplomat"]').click();}}});
}

// Start the app
loadTriggers();
</script>
</body>
</html>