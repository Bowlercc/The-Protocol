<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THE PROTOCOL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root{--white:#FFFFFF;--black:#000000;--gray-50:#FAFAFA;--gray-100:#F5F5F5;--gray-200:#E5E5E5;--gray-300:#D4D4D4;--gray-400:#A3A3A3;--gray-500:#737373;--gray-600:#525252;--gray-800:#262626;--gray-900:#171717}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--white);color:var(--black);min-height:100vh;-webkit-font-smoothing:antialiased}
header{position:fixed;top:0;left:0;right:0;z-index:100;display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:var(--white);border-bottom:1px solid var(--gray-200)}
.logo{font-size:.7rem;font-weight:600;letter-spacing:.15em;text-transform:uppercase}
.logo a{color:inherit;text-decoration:none}
.header-actions{display:flex;gap:.5rem}
.icon-btn{width:32px;height:32px;border:1px solid var(--gray-200);background:var(--white);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.8rem;transition:all .15s}
.icon-btn:hover{background:var(--gray-100);border-color:var(--gray-300)}
.main-content{display:flex;min-height:100vh;padding-top:57px}
.control-panel{width:380px;min-width:380px;border-right:1px solid var(--gray-200);padding:2rem;display:flex;flex-direction:column;gap:2rem;overflow-y:auto;background:var(--gray-50)}
.section-label{font-size:.65rem;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--gray-400);margin-bottom:.75rem}
.input-row{display:flex;gap:.5rem}
.trigger-input{flex:1;padding:.875rem 0;border:none;border-bottom:1px solid var(--gray-300);background:transparent;font-family:inherit;font-size:1rem;outline:none;transition:border-color .15s}
.trigger-input::placeholder{color:var(--gray-400)}
.trigger-input:focus{border-color:var(--black)}
.surprise-btn{width:44px;height:44px;border:1px solid var(--gray-200);background:var(--white);cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:all .15s}
.surprise-btn:hover{background:var(--gray-100);border-color:var(--gray-300)}
.triggers-grid{display:flex;flex-wrap:wrap;gap:.5rem;max-height:140px;overflow-y:auto}
.trigger-chip{padding:.5rem .875rem;border:1px solid var(--gray-200);background:var(--white);font-family:inherit;font-size:.75rem;cursor:pointer;transition:all .15s}
.trigger-chip:hover{background:var(--gray-100);border-color:var(--gray-300)}
.toggle-group{display:flex;gap:.25rem;flex-wrap:wrap}
.toggle-btn{padding:.625rem 1rem;border:1px solid var(--gray-200);background:var(--white);font-family:inherit;font-size:.7rem;font-weight:500;letter-spacing:.05em;text-transform:uppercase;cursor:pointer;transition:all .15s}
.toggle-btn:hover{background:var(--gray-100)}
.toggle-btn.active{background:var(--black);color:var(--white);border-color:var(--black)}
.spice-toggle{display:flex;gap:.25rem}
.spice-btn{flex:1;padding:.625rem .5rem;border:1px solid var(--gray-200);background:var(--white);font-family:inherit;font-size:.7rem;font-weight:500;letter-spacing:.05em;text-transform:uppercase;cursor:pointer;transition:all .15s;text-align:center}
.spice-btn:hover{background:var(--gray-100)}
.spice-btn.active{background:var(--black);color:var(--white);border-color:var(--black)}
.config-row{display:flex;gap:1.5rem}
.config-group{flex:1}
.tone-buttons{display:flex;flex-direction:column;gap:.5rem}
.tone-btn{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border:1px solid var(--gray-200);background:var(--white);font-family:inherit;cursor:pointer;transition:all .15s;text-align:left}
.tone-btn:hover{background:var(--gray-100);border-color:var(--gray-300)}
.tone-btn.active{background:var(--black);color:var(--white);border-color:var(--black)}
.tone-btn span:first-child{font-size:.7rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase}
.tone-desc{font-size:.75rem;color:var(--gray-500)}
.tone-btn.active .tone-desc{color:var(--gray-400)}
.display-panel{flex:1;display:flex;align-items:center;justify-content:center;padding:3rem;position:relative;background:var(--white)}
.placeholder-card{text-align:center;color:var(--gray-400)}
.placeholder-card span{display:block;font-size:.85rem;margin-bottom:.5rem}
.script-card{width:100%;max-width:520px;border:1px solid var(--gray-200);padding:2.5rem;display:none;animation:fadeIn .3s ease}
.script-card.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.script-meta{display:flex;justify-content:space-between;font-size:.65rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);padding-bottom:1.25rem;margin-bottom:1.25rem;border-bottom:1px solid var(--gray-200)}
.script-spice{color:var(--gray-600)}
.script-spice.hot{color:var(--gray-900);font-weight:600}
.script-subtext{font-size:.85rem;font-style:italic;color:var(--gray-500);margin-bottom:1.5rem;line-height:1.6}
.script-trigger{margin-bottom:1.5rem}
.script-trigger-label{font-size:.65rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);display:block;margin-bottom:.5rem}
#triggerDisplay{font-size:1rem;color:var(--gray-600)}
.script-response{margin-bottom:2rem}
.script-response-label{font-size:.65rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);margin-bottom:.75rem}
.script-text{font-size:1.5rem;line-height:1.4;letter-spacing:-.01em}
.script-footer{display:flex;justify-content:space-between;font-size:.6rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);padding-top:1.25rem;border-top:1px solid var(--gray-200)}
.controls{display:flex;gap:.5rem;margin-top:2rem}
.control-btn{flex:1;padding:.875rem 1.5rem;border:1px solid var(--gray-200);background:var(--white);font-family:inherit;font-size:.7rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .15s}
.control-btn:hover:not(:disabled){background:var(--gray-100);border-color:var(--gray-300)}
.control-btn:disabled{opacity:.4;cursor:not-allowed}
.control-btn.primary{background:var(--black);color:var(--white);border-color:var(--black)}
.control-btn.primary:hover:not(:disabled){opacity:.8}
.export-options{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000}
.export-options.active{display:flex}
.export-modal{background:var(--white);padding:2.5rem;width:90%;max-width:440px}
.export-title{font-size:1.5rem;font-weight:400;margin-bottom:.5rem}
.export-subtitle{font-size:.85rem;color:var(--gray-500);margin-bottom:2rem}
.export-formats{display:flex;gap:.5rem;margin-bottom:1.5rem}
.export-format-btn{flex:1;padding:1.25rem 1rem;border:1px solid var(--gray-200);background:var(--white);cursor:pointer;text-align:center;transition:all .15s}
.export-format-btn:hover{background:var(--gray-100);border-color:var(--gray-300)}
.export-format-name{display:block;font-size:.7rem;font-weight:600;letter-spacing:.1em;text-transform:uppercase;margin-bottom:.25rem}
.export-format-size{font-size:.7rem;color:var(--gray-400)}
.export-toggles{display:flex;flex-direction:column;gap:.75rem;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid var(--gray-200)}
.export-toggle{display:flex;align-items:center;gap:.75rem;font-size:.8rem;color:var(--gray-600);cursor:pointer}
.export-toggle input{width:16px;height:16px}
.caption-section{margin-bottom:1.5rem}
.caption-label{font-size:.65rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);margin-bottom:.75rem}
.caption-suggestions{display:flex;flex-direction:column;gap:.5rem}
.caption-item{padding:.75rem 1rem;border:1px solid var(--gray-200);font-size:.8rem;color:var(--gray-600);cursor:pointer;transition:all .15s;line-height:1.5}
.caption-item:hover{background:var(--gray-100);border-color:var(--gray-300)}
.caption-item.copied{background:var(--gray-100);border-color:var(--black)}
.export-close{width:100%;padding:.875rem;border:1px solid var(--gray-200);background:var(--white);font-family:inherit;font-size:.7rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;transition:all .15s}
.export-close:hover{background:var(--gray-100)}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:var(--black);color:var(--white);padding:.875rem 1.5rem;font-size:.7rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;transition:transform .3s;z-index:1001}
.toast.show{transform:translateX(-50%) translateY(0)}
.animate-overlay{position:fixed;inset:0;background:var(--black);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center}
.animate-overlay.active{display:flex}
.animate-scene{width:100%;max-width:400px;aspect-ratio:9/16;background:var(--white);position:relative;overflow:hidden}
.animate-card{position:absolute;inset:2rem;display:flex;flex-direction:column;padding:2rem;border:1px solid var(--gray-200)}
.animate-meta{display:flex;justify-content:space-between;font-size:.6rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);padding-bottom:1rem;margin-bottom:1rem;border-bottom:1px solid var(--gray-200)}
.animate-subtext{font-size:.8rem;font-style:italic;color:var(--gray-500);margin-bottom:1.5rem;opacity:0;transform:translateY(10px)}
.animate-subtext.show{animation:fadeUp .5s ease forwards}
.animate-trigger-wrapper{margin-bottom:1.5rem}
.animate-label{font-size:.6rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);display:block;margin-bottom:.5rem}
.animate-trigger-text{font-size:.9rem;color:var(--gray-600);opacity:0}
.animate-trigger-text.show{animation:fadeUp .4s ease forwards}
.animate-response-wrapper{flex:1}
.animate-response-text{font-size:1.25rem;line-height:1.4}
.animate-response-text .word{display:inline-block;white-space:nowrap;margin-right:.25em}
.animate-response-text .char{opacity:0;display:inline-block}
.animate-response-text .char.show{animation:charIn .04s ease forwards}
.animate-footer{display:flex;justify-content:space-between;font-size:.55rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gray-400);padding-top:1rem;border-top:1px solid var(--gray-200)}
.animate-controls{display:flex;gap:1rem;margin-top:1.5rem}
.animate-hint{font-size:.7rem;color:var(--gray-500);margin-top:1rem;letter-spacing:.05em}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes charIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
.tutorial-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:3000;display:flex;align-items:center;justify-content:center}
.tutorial-overlay.hidden{display:none}
@media(max-width:900px){.main-content{flex-direction:column}.control-panel{width:100%;min-width:0;border-right:none;border-bottom:1px solid var(--gray-200);max-height:none;padding:1.5rem}.control-panel.hidden{display:none}.display-panel{padding:1.5rem;min-height:60vh}.display-panel.hidden{display:none}.config-row{flex-direction:column;gap:1.5rem}.tone-buttons{flex-direction:row;flex-wrap:wrap}.tone-btn{flex:1 1 calc(50% - .25rem);flex-direction:column;align-items:flex-start;gap:.25rem;padding:.875rem 1rem}.tone-desc{display:none}.controls{flex-direction:column}.back-btn{margin-bottom:1rem}}
@media(min-width:901px){.mobile-only{display:none!important}}
</style>
</head>
<body>
<header>
<div class="logo"><a href="index.html">The Protocol</a></div>
<div class="header-actions"><button class="icon-btn" onclick="showTutorial()" title="Help">?</button></div>
</header>
<div class="main-content">
<div class="control-panel" id="controlPanel">
<div><div class="section-label">They Said</div><div class="input-row"><input type="text" class="trigger-input" id="triggerInput" placeholder="Enter the audacity..."><button class="surprise-btn" id="surpriseBtn" title="Random">üé≤</button></div></div>
<div><div class="section-label">Greatest Hits</div><div class="triggers-grid" id="triggersGrid"></div></div>
<div class="config-row"><div class="config-group"><div class="section-label">The Offender</div><div class="toggle-group" id="contextGroup"><button class="toggle-btn active" data-context="stranger">Stranger</button><button class="toggle-btn" data-context="family">Family</button><button class="toggle-btn" data-context="colleague">Colleague</button><button class="toggle-btn" data-context="medical">Medical</button></div></div></div>
<div class="config-row"><div class="config-group"><div class="section-label">Damage Level</div><div class="spice-toggle" id="spiceGroup"><button class="spice-btn" data-spice="mild">Civil</button><button class="spice-btn active" data-spice="medium">Risky</button><button class="spice-btn" data-spice="hot">Nuclear</button></div></div><div class="config-group"><div class="section-label">Perspective</div><div class="toggle-group" id="perspectiveGroup"><button class="toggle-btn" data-perspective="i">I</button><button class="toggle-btn active" data-perspective="we">We</button></div></div></div>
<div><div class="section-label">Choose Your Weapon</div><div class="tone-buttons"><button class="tone-btn" data-tone="diplomat"><span>Diplomat</span><span class="tone-desc">Kill them with kindness</span></button><button class="tone-btn" data-tone="critic"><span>Critic</span><span class="tone-desc">Actually, you're wrong</span></button><button class="tone-btn" data-tone="absurdist"><span>Absurdist</span><span class="tone-desc">Confuse them into silence</span></button><button class="tone-btn" data-tone="realist"><span>Realist</span><span class="tone-desc">Trauma, served straight</span></button></div></div>
</div>
<div class="display-panel" id="displayPanel">
<div>
<button class="control-btn mobile-only back-btn" id="backBtn" style="display:none">‚Üê Back</button>
<div class="placeholder-card" id="placeholderCard"><span>Enter the audacity.</span><span>Choose your damage level.</span><span>Pick your weapon.</span></div>
<div class="script-card" id="scriptCard">
<div class="script-meta"><span class="script-context" id="contextDisplay">STRANGER</span><span class="script-spice" id="spiceDisplay">RISKY</span></div>
<div class="script-subtext" id="subtextDisplay"></div>
<div class="script-trigger"><span class="script-trigger-label">They Said:</span><span id="triggerDisplay"></span></div>
<div class="script-response"><div class="script-response-label">You Say:</div><div class="script-text" id="scriptText"></div></div>
<div class="script-footer"><span>The Protocol</span><span>Matterhood</span></div>
</div>
<div class="controls"><button class="control-btn" id="newTakeBtn" disabled>Another</button><button class="control-btn" id="copyBtn" disabled>Copy</button><button class="control-btn" id="animateBtn" disabled>Dramatize</button><button class="control-btn primary" id="exportBtn" disabled>Get Receipts</button></div>
</div>
</div>
</div>
<div class="export-options" id="exportOptions">
<div class="export-modal">
<div class="export-title">Get Your Receipts</div>
<div class="export-subtitle">Choose your format</div>
<div class="export-formats"><button class="export-format-btn" data-format="story"><span class="export-format-name">Story</span><span class="export-format-size">1080 √ó 1920</span></button><button class="export-format-btn" data-format="square"><span class="export-format-name">Square</span><span class="export-format-size">1080 √ó 1080</span></button><button class="export-format-btn" data-format="wide"><span class="export-format-name">Wide</span><span class="export-format-size">1200 √ó 675</span></button></div>
<div class="export-toggles"><label class="export-toggle"><input type="checkbox" id="toggleQR" checked><span>Add QR code</span></label><label class="export-toggle"><input type="checkbox" id="toggleDual"><span>Add "Why this hurts" card</span></label></div>
<div class="caption-section"><div class="caption-label">Caption (tap to copy)</div><div class="caption-suggestions" id="captionSuggestions"></div></div>
<button class="export-close" id="exportClose">Cancel</button>
</div>
</div>
<div class="toast" id="toast"></div>
<div class="animate-overlay" id="animateOverlay">
<div class="animate-scene" id="animateScene"><div class="animate-card">
<div class="animate-meta"><span id="animContext">STRANGER</span><span id="animSpice">RISKY</span></div>
<div class="animate-subtext" id="animSubtext"></div>
<div class="animate-trigger-wrapper"><span class="animate-label">They Said:</span><span class="animate-trigger-text" id="animTrigger"></span></div>
<div class="animate-response-wrapper"><div class="animate-label">You Say:</div><div class="animate-response-text" id="animResponse"></div></div>
<div class="animate-footer"><span>The Protocol</span><span>Matterhood</span></div>
</div></div>
<div class="animate-controls"><button class="control-btn" id="replayBtn">Replay</button><button class="control-btn" id="animCloseBtn">Close</button></div>
<div class="animate-hint">Screen record this for your story</div>
</div>
<div class="tutorial-overlay hidden" id="tutorialOverlay">
<div style="background:white;padding:3rem;max-width:500px;text-align:center;">
<h2 style="font-size:1.5rem;margin-bottom:1rem;">The Protocol</h2>
<p style="color:#525252;margin-bottom:2rem;line-height:1.7;">Enter what they said. Choose your damage level. Pick your weapon. Get your receipts.</p>
<button onclick="completeTutorial()" style="padding:.875rem 2rem;background:black;color:white;border:none;font-family:inherit;font-size:.7rem;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;">Got It</button>
</div>
</div>
<script>
let TRIGGERS=[];
function goToStep(n){}
function completeTutorial(){localStorage.setItem('protocol_tutorial_v5','true');document.getElementById('tutorialOverlay').classList.add('hidden');}
function showTutorial(){document.getElementById('tutorialOverlay').classList.remove('hidden');}
async function loadTriggers(){try{const response=await fetch('triggers.json');TRIGGERS=await response.json();console.log(`Loaded ${TRIGGERS.length} triggers`);initApp();}catch(err){console.error('Failed to load triggers:',err);document.body.innerHTML='<div style="padding:3rem;text-align:center;">Failed to load data. Please refresh.</div>';}}
function initApp(){
const COMMON_TRIGGERS=["Just relax","Why don't you adopt?","Have you tried IVF?","Everything happens for a reason","My cousin stopped trying","At least you have freedom","Who's the problem?","Tick tock","You'll regret it","You wouldn't understand","Must be nice to sleep in","At least you have each other"];
const CONTEXT_LABELS={stranger:"STRANGER",family:"FAMILY",colleague:"COLLEAGUE",medical:"MEDICAL"};
const SPICE_LABELS={mild:"CIVIL",medium:"RISKY",hot:"NUCLEAR"};
let currentTone=null,currentTrigger=null,currentResponse=null,currentImageUrl='',currentSubtext='',currentMatchedTrigger=null;
let context='stranger',spice='medium',perspective='we';
let usedResponses={};
if(localStorage.getItem('protocol_tutorial_v5'))document.getElementById('tutorialOverlay').classList.add('hidden');
function normalize(t){return t.toLowerCase().replace(/['']/g,"'").replace(/[""]/g,'"').replace(/[?!.,;:]/g,'').replace(/\s+/g,' ').trim();}
const FILLER_WORDS=new Set(['a','an','the','you','your','i','my','we','our','just','really','actually','maybe','perhaps','ever','even','so','very','like','know','think','well','oh','um','uh','hey','but','and','or','if','then','have','has','had','do','does','did','should','could','would','can','will','been','being','gonna','gotta','wanna','dont','didnt','cant','wont','youre','youve','youll','ive','im','were','weve','thats','its','hes','shes','theyre','theyve']);
function removeFillers(text){return text.split(' ').filter(w=>!FILLER_WORDS.has(w)).join(' ');}
function similarity(a,b){if(a===b)return 1;if(a.length<2||b.length<2)return 0;const bigramsA=new Map();for(let i=0;i<a.length-1;i++){const bg=a.substring(i,i+2);bigramsA.set(bg,(bigramsA.get(bg)||0)+1);}let matches=0;for(let i=0;i<b.length-1;i++){const bg=b.substring(i,i+2);if(bigramsA.get(bg)>0){matches++;bigramsA.set(bg,bigramsA.get(bg)-1);}}return(2*matches)/(a.length+b.length-2);}
function findMatch(input){const n=normalize(input);if(!n)return null;const nNoFill=removeFillers(n);let bestMatch=null,bestScore=0;for(const t of TRIGGERS){for(const p of t.triggers){const pattern=normalize(p),patternNoFill=removeFillers(pattern);if(n.includes(pattern))return t;if(nNoFill.includes(patternNoFill)&&patternNoFill.length>3){if(0.95>bestScore){bestScore=0.95;bestMatch=t;}continue;}if(n.includes(patternNoFill)&&patternNoFill.length>3){if(0.9>bestScore){bestScore=0.9;bestMatch=t;}continue;}const patternWords=patternNoFill.split(' ').filter(w=>w.length>2),inputWords=nNoFill.split(' ').filter(w=>w.length>2);if(patternWords.length>0){let wordMatches=0;for(const pw of patternWords){for(const iw of inputWords){if(pw===iw){wordMatches++;break;}if(pw.length>3&&iw.length>3&&similarity(pw,iw)>0.7){wordMatches+=0.8;break;}}}const score=wordMatches/patternWords.length;if(score>bestScore&&score>=0.5){bestScore=score;bestMatch=t;}}const sim=similarity(nNoFill,patternNoFill);if(sim>bestScore&&sim>=0.6){bestScore=sim;bestMatch=t;}}}return bestMatch;}
function swapPerspective(text){if(perspective==='i'){return text.replace(/\{We're\}/g,"I'm").replace(/\{we're\}/g,"I'm").replace(/\{We've\}/g,"I've").replace(/\{we've\}/g,"I've").replace(/\{We'll\}/g,"I'll").replace(/\{we'll\}/g,"I'll").replace(/\{We'd\}/g,"I'd").replace(/\{we'd\}/g,"I'd").replace(/\{We\}/g,"I").replace(/\{we\}/g,"I").replace(/\{Our\}/g,"My").replace(/\{our\}/g,"my").replace(/\{us\}/g,"me").replace(/\{Us\}/g,"Me").replace(/\{I\}'m/g,"I'm").replace(/\{I\}'ve/g,"I've").replace(/\{I\}'ll/g,"I'll").replace(/\{I\}'d/g,"I'd").replace(/\{I\}/g,"I").replace(/\{I'm\}/g,"I'm").replace(/\{My\}/g,"My").replace(/\{my\}/g,"my").replace(/\{me\}/g,"me");}return text.replace(/\{We're\}/g,"We're").replace(/\{we're\}/g,"we're").replace(/\{We've\}/g,"We've").replace(/\{we've\}/g,"we've").replace(/\{We'll\}/g,"We'll").replace(/\{we'll\}/g,"we'll").replace(/\{We'd\}/g,"We'd").replace(/\{we'd\}/g,"we'd").replace(/\{We\}/g,"We").replace(/\{we\}/g,"we").replace(/\{Our\}/g,"Our").replace(/\{our\}/g,"our").replace(/\{us\}/g,"us").replace(/\{Us\}/g,"Us").replace(/\{I\}'m/g,"We're").replace(/\{I\}'ve/g,"We've").replace(/\{I\}'ll/g,"We'll").replace(/\{I\}'d/g,"We'd").replace(/\{I\}/g,"We").replace(/\{I'm\}/g,"We're").replace(/\{My\}/g,"Our").replace(/\{my\}/g,"our").replace(/\{me\}/g,"us");}
function getResponseKey(trigger,tone,spiceLevel){return `${trigger.triggers[0]}-${tone}-${spiceLevel}`;}
function getRandomResponse(variants,key){if(!usedResponses[key])usedResponses[key]=[];const available=variants.filter((_,i)=>!usedResponses[key].includes(i));if(available.length===0){usedResponses[key]=[];return variants[Math.floor(Math.random()*variants.length)];}const idx=variants.indexOf(available[Math.floor(Math.random()*available.length)]);usedResponses[key].push(idx);return variants[idx];}
function generateScene(tone){const input=document.getElementById('triggerInput').value.trim();if(!input){document.getElementById('triggerInput').focus();return;}currentTone=tone;const match=findMatch(input);currentMatchedTrigger=match;if(match){currentSubtext=match.subtext;currentImageUrl=match.image;const toneResponses=match.responses[tone];const variants=toneResponses[spice]||toneResponses.medium;const key=getResponseKey(match,tone,spice);const rawResponse=Array.isArray(variants)?getRandomResponse(variants,key):variants;currentResponse=swapPerspective(rawResponse);}else{currentSubtext="A question that doesn't deserve this much thought.";currentImageUrl='';const fallbacks=["Some questions don't deserve answers.","Not every comment deserves a response.","That one's not in the script."];currentResponse=swapPerspective(fallbacks[Math.floor(Math.random()*fallbacks.length)]);}currentTrigger=input;document.getElementById('subtextDisplay').textContent=currentSubtext;document.getElementById('triggerDisplay').textContent=input;document.getElementById('scriptText').textContent=currentResponse;document.getElementById('contextDisplay').textContent=CONTEXT_LABELS[context];document.getElementById('spiceDisplay').textContent=SPICE_LABELS[spice];document.getElementById('spiceDisplay').className='script-spice'+(spice==='hot'?' hot':'');document.getElementById('placeholderCard').style.display='none';const card=document.getElementById('scriptCard');card.classList.remove('active');void card.offsetWidth;card.classList.add('active');document.getElementById('newTakeBtn').disabled=false;document.getElementById('copyBtn').disabled=false;document.getElementById('animateBtn').disabled=false;document.getElementById('exportBtn').disabled=false;if(window.innerWidth<=900){document.getElementById('controlPanel').classList.add('hidden');document.getElementById('displayPanel').classList.remove('hidden');document.getElementById('backBtn').style.display='block';}}
function setupToggles(groupId,callback){document.querySelectorAll(`#${groupId} .toggle-btn, #${groupId} .spice-btn`).forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll(`#${groupId} .toggle-btn, #${groupId} .spice-btn`).forEach(b=>b.classList.remove('active'));btn.classList.add('active');callback(btn.dataset.context||btn.dataset.spice||btn.dataset.perspective);});});}
setupToggles('contextGroup',v=>{context=v;});
setupToggles('spiceGroup',v=>{spice=v;});
setupToggles('perspectiveGroup',v=>{perspective=v;});
COMMON_TRIGGERS.forEach(t=>{const c=document.createElement('button');c.className='trigger-chip';c.textContent=t;c.onclick=()=>{document.getElementById('triggerInput').value=t;};document.getElementById('triggersGrid').appendChild(c);});
document.querySelectorAll('.tone-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.tone-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');generateScene(btn.dataset.tone);});});
document.getElementById('newTakeBtn').addEventListener('click',()=>{if(currentTone)generateScene(currentTone);});
document.getElementById('copyBtn').addEventListener('click',()=>{if(currentResponse){navigator.clipboard.writeText(currentResponse).then(()=>showToast('copy'));}});
document.getElementById('exportBtn').addEventListener('click',()=>{generateCaptions();document.getElementById('exportOptions').classList.add('active');});
document.getElementById('exportClose').addEventListener('click',()=>document.getElementById('exportOptions').classList.remove('active'));
document.getElementById('exportOptions').addEventListener('click',e=>{if(e.target===e.currentTarget)e.currentTarget.classList.remove('active');});
document.getElementById('surpriseBtn').addEventListener('click',()=>{const randomTrigger=TRIGGERS[Math.floor(Math.random()*TRIGGERS.length)];const randomPhrase=randomTrigger.triggers[Math.floor(Math.random()*randomTrigger.triggers.length)];document.getElementById('triggerInput').value=randomPhrase;const contexts=['stranger','family','colleague','medical'];const randomContext=contexts[Math.floor(Math.random()*contexts.length)];context=randomContext;document.querySelectorAll('#contextGroup .toggle-btn').forEach(b=>{b.classList.toggle('active',b.dataset.context===randomContext);});const spices=['mild','medium','hot'];const randomSpice=spices[Math.floor(Math.random()*spices.length)];spice=randomSpice;document.querySelectorAll('#spiceGroup .spice-btn').forEach(b=>{b.classList.toggle('active',b.dataset.spice===randomSpice);});const perspectives=['i','we'];const randomPerspective=perspectives[Math.floor(Math.random()*perspectives.length)];perspective=randomPerspective;document.querySelectorAll('#perspectiveGroup .toggle-btn').forEach(b=>{b.classList.toggle('active',b.dataset.perspective===randomPerspective);});const tones=['diplomat','critic','absurdist','realist'];const randomTone=tones[Math.floor(Math.random()*tones.length)];document.querySelectorAll('.tone-btn').forEach(b=>b.classList.remove('active'));document.querySelector(`.tone-btn[data-tone="${randomTone}"]`).classList.add('active');generateScene(randomTone);});
const CAPTIONS=["Things people actually say. Here's what we wish we'd said.","Filed under: audacity.","For everyone who's heard this one too many times.","The script I needed at Thanksgiving.","Finally saying what I actually meant.","For the well-meaning but wildly unhelpful.","Boundaries. In writing.","Not all comments deserve grace.","This one's been in the drafts for years.","Receipts: collected."];
const CAPTIONS_EDUCATIONAL=["Sharing this to educate, not to start a war.","For those who want to do better.","Swipe for why this comment missed the mark.","Good intentions ‚â† good impact.","If you've said this, here's your redemption arc."];
function generateCaptions(){const isDual=document.getElementById('toggleDual').checked;const captionPool=isDual?[...CAPTIONS_EDUCATIONAL,...CAPTIONS.slice(0,3)]:CAPTIONS;const shuffled=[...captionPool].sort(()=>Math.random()-0.5);const selected=shuffled.slice(0,3);const container=document.getElementById('captionSuggestions');container.innerHTML=selected.map((c,i)=>`<div class="caption-item" data-caption-index="${i}">${c}</div>`).join('');container.querySelectorAll('.caption-item').forEach((el,i)=>{el.addEventListener('click',()=>{const text=selected[i]+' #matterhood';navigator.clipboard.writeText(text).then(()=>{container.querySelectorAll('.caption-item').forEach(c=>c.classList.remove('copied'));el.classList.add('copied');showToast('caption');});});});}
document.getElementById('toggleDual').addEventListener('change',generateCaptions);
let animationTimeout=null;
function playAnimation(){if(animationTimeout)clearTimeout(animationTimeout);document.getElementById('animContext').textContent=CONTEXT_LABELS[context];document.getElementById('animSpice').textContent=SPICE_LABELS[spice];document.getElementById('animSubtext').textContent=currentSubtext;document.getElementById('animTrigger').textContent=currentTrigger;const responseEl=document.getElementById('animResponse');const words=currentResponse.split(' ');responseEl.innerHTML=words.map(word=>`<span class="word">${word.split('').map(c=>`<span class="char">${c}</span>`).join('')}</span>`).join('');document.getElementById('animSubtext').classList.remove('show');document.getElementById('animTrigger').classList.remove('show');responseEl.querySelectorAll('.char').forEach(c=>c.classList.remove('show'));setTimeout(()=>document.getElementById('animSubtext').classList.add('show'),300);setTimeout(()=>document.getElementById('animTrigger').classList.add('show'),800);const chars=responseEl.querySelectorAll('.char');chars.forEach((char,i)=>{animationTimeout=setTimeout(()=>char.classList.add('show'),1200+i*30);});}
document.getElementById('animateBtn').addEventListener('click',()=>{document.getElementById('animateOverlay').classList.add('active');playAnimation();});
document.getElementById('replayBtn').addEventListener('click',playAnimation);
document.getElementById('animCloseBtn').addEventListener('click',()=>{document.getElementById('animateOverlay').classList.remove('active');if(animationTimeout)clearTimeout(animationTimeout);});
document.querySelectorAll('.export-format-btn').forEach(btn=>{btn.addEventListener('click',async()=>{const format=btn.dataset.format;const dims={story:{w:1080,h:1920},square:{w:1080,h:1080},wide:{w:1200,h:675}}[format];await exportImage(dims.w,dims.h,format);document.getElementById('exportOptions').classList.remove('active');});});
async function exportImage(w,h,format){const includeQR=document.getElementById('toggleQR').checked;const includeDual=document.getElementById('toggleDual').checked;const scale=w/1080;const bgColor='#FFFFFF';const textColor='#000000';const labelColor='#A3A3A3';const borderColor='#E5E5E5';const metaSize=Math.round(12*scale);const subtextSize=Math.round(14*scale);const triggerLabelSize=Math.round(11*scale);const triggerSize=Math.round(16*scale);const responseLabelSize=Math.round(11*scale);const responseSize=Math.round(format==='wide'?28*scale:32*scale);const footerSize=Math.round(11*scale);const padding=Math.round(50*scale);const qrSize=Math.round(70*scale);const textW=Math.round(format==='wide'?w*0.6:w*0.7);let qrDataUrl=null;if(includeQR){const qrDiv=document.createElement('div');document.body.appendChild(qrDiv);new QRCode(qrDiv,{text:window.location.origin,width:qrSize*3,height:qrSize*3,colorDark:'#000000',colorLight:'transparent',correctLevel:QRCode.CorrectLevel.M});await new Promise(r=>setTimeout(r,150));const qrCanvas=qrDiv.querySelector('canvas');if(qrCanvas)qrDataUrl=qrCanvas.toDataURL();document.body.removeChild(qrDiv);}function wrapText(ctx,text,maxW){const words=text.split(' '),lines=[];let line='';for(const w of words){const test=line?line+' '+w:w;if(ctx.measureText(test).width>maxW&&line){lines.push(line);line=w;}else{line=test;}}if(line)lines.push(line);return lines;}async function createCanvas(){const canvas=document.createElement('canvas');canvas.width=w;canvas.height=h;const ctx=canvas.getContext('2d');ctx.fillStyle=bgColor;ctx.fillRect(0,0,w,h);return{canvas,ctx};}async function drawCard(ctx,areaW,areaH,isEducation=false){let contentH=0;const whyText=currentMatchedTrigger?.why_it_hurts||"This comment, though well-meaning, can minimize the deep emotional weight of what someone is going through.";const whatText=currentMatchedTrigger?.what_to_know||"Instead of offering advice, try listening. Sometimes presence matters more than solutions.";if(isEducation){contentH+=Math.round(responseSize*0.7)+padding*0.5;contentH+=triggerLabelSize+padding*0.15+triggerSize+padding*0.4;ctx.font=`${triggerSize}px Inter, sans-serif`;contentH+=triggerLabelSize+padding*0.15;const whyLines=wrapText(ctx,whyText,textW);contentH+=whyLines.length*triggerSize*1.6+padding*0.4;contentH+=triggerLabelSize+padding*0.15;const whatLines=wrapText(ctx,whatText,textW);contentH+=whatLines.length*triggerSize*1.6+padding*0.4;}else{contentH+=metaSize+padding*0.5+padding*0.3;ctx.font=`italic ${subtextSize}px Inter, sans-serif`;const subtextLines=wrapText(ctx,currentSubtext,textW);contentH+=subtextLines.length*subtextSize*1.6+padding*0.5;contentH+=triggerLabelSize+padding*0.15;ctx.font=`${triggerSize}px Inter, sans-serif`;const triggerLines=wrapText(ctx,currentTrigger,textW);contentH+=triggerLines.length*triggerSize*1.6+padding*0.4;contentH+=responseLabelSize+padding*0.3;ctx.font=`${responseSize}px Inter, sans-serif`;const responseLines=wrapText(ctx,currentResponse,textW);contentH+=responseLines.length*responseSize*1.35+padding*0.5;if(includeQR)contentH+=qrSize+padding*0.3;}contentH+=padding*0.4+footerSize;const frameW=textW+padding*2;const frameH=contentH+padding*2;const frameX=(areaW-frameW)/2;const frameY=(areaH-frameH)/2;ctx.fillStyle=bgColor;ctx.fillRect(frameX,frameY,frameW,frameH);ctx.strokeStyle=borderColor;ctx.lineWidth=1;ctx.strokeRect(frameX,frameY,frameW,frameH);const contentX=frameX+padding;const contentRight=frameX+frameW-padding;let y=frameY+padding;if(isEducation){ctx.font=`500 ${Math.round(responseSize*0.7)}px Inter, sans-serif`;ctx.textAlign='left';ctx.fillStyle=textColor;ctx.fillText('Why This Hurts',contentX,y+Math.round(responseSize*0.7)*0.85);y+=Math.round(responseSize*0.7)+padding*0.5;ctx.fillStyle=labelColor;ctx.font=`500 ${triggerLabelSize}px Inter, sans-serif`;ctx.fillText('WHEN THEY SAY:',contentX,y+triggerLabelSize);y+=triggerLabelSize+padding*0.15;ctx.fillStyle='#525252';ctx.font=`${triggerSize}px Inter, sans-serif`;ctx.fillText(`"${currentTrigger}"`,contentX,y+triggerSize);y+=triggerSize+padding*0.4;ctx.fillStyle=labelColor;ctx.font=`500 ${triggerLabelSize}px Inter, sans-serif`;ctx.fillText('THE IMPACT:',contentX,y+triggerLabelSize);y+=triggerLabelSize+padding*0.15;ctx.fillStyle='#525252';ctx.font=`${triggerSize}px Inter, sans-serif`;const whyLines=wrapText(ctx,whyText,textW);whyLines.forEach(line=>{ctx.fillText(line,contentX,y+triggerSize);y+=triggerSize*1.6;});y+=padding*0.4;ctx.fillStyle=labelColor;ctx.font=`500 ${triggerLabelSize}px Inter, sans-serif`;ctx.fillText('WHAT HELPS:',contentX,y+triggerLabelSize);y+=triggerLabelSize+padding*0.15;ctx.fillStyle='#525252';ctx.font=`${triggerSize}px Inter, sans-serif`;const whatLines=wrapText(ctx,whatText,textW);whatLines.forEach(line=>{ctx.fillText(line,contentX,y+triggerSize);y+=triggerSize*1.6;});y+=padding*0.4;}else{ctx.font=`500 ${metaSize}px Inter, sans-serif`;ctx.textAlign='left';ctx.fillStyle=labelColor;ctx.fillText(CONTEXT_LABELS[context],contentX,y+metaSize);ctx.textAlign='right';ctx.fillStyle=spice==='hot'?'#171717':labelColor;ctx.fillText(SPICE_LABELS[spice],contentRight,y+metaSize);y+=metaSize+padding*0.5;ctx.strokeStyle=borderColor;ctx.beginPath();ctx.moveTo(contentX,y);ctx.lineTo(contentRight,y);ctx.stroke();y+=padding*0.3;ctx.textAlign='left';ctx.fillStyle='#525252';ctx.font=`italic ${subtextSize}px Inter, sans-serif`;const subtextLines=wrapText(ctx,currentSubtext,textW);subtextLines.forEach(line=>{ctx.fillText(line,contentX,y+subtextSize);y+=subtextSize*1.6;});y+=padding*0.5;ctx.fillStyle=labelColor;ctx.font=`500 ${triggerLabelSize}px Inter, sans-serif`;ctx.fillText('THEY SAID:',contentX,y+triggerLabelSize);y+=triggerLabelSize+padding*0.15;ctx.fillStyle='#525252';ctx.font=`${triggerSize}px Inter, sans-serif`;const triggerLines=wrapText(ctx,currentTrigger,textW);triggerLines.forEach(line=>{ctx.fillText(line,contentX,y+triggerSize);y+=triggerSize*1.6;});y+=padding*0.4;ctx.fillStyle=labelColor;ctx.font=`500 ${responseLabelSize}px Inter, sans-serif`;ctx.fillText('YOU SAY:',contentX,y+responseLabelSize);y+=responseLabelSize+padding*0.3;ctx.fillStyle=textColor;ctx.font=`${responseSize}px Inter, sans-serif`;const responseLines=wrapText(ctx,currentResponse,textW);responseLines.forEach(line=>{ctx.fillText(line,contentX,y+responseSize*0.85);y+=responseSize*1.35;});y+=padding*0.5;if(includeQR&&qrDataUrl){const qrImg=new Image();await new Promise(r=>{qrImg.onload=r;qrImg.src=qrDataUrl;});ctx.drawImage(qrImg,contentRight-qrSize,y,qrSize,qrSize);y+=qrSize+padding*0.3;}}ctx.strokeStyle=borderColor;ctx.beginPath();ctx.moveTo(contentX,y);ctx.lineTo(contentRight,y);ctx.stroke();y+=padding*0.4;ctx.fillStyle=labelColor;ctx.font=`500 ${footerSize}px Inter, sans-serif`;ctx.textAlign='left';ctx.fillText('THE PROTOCOL',contentX,y+footerSize);ctx.textAlign='right';ctx.fillText('MATTERHOOD',contentRight,y+footerSize);}const{canvas:canvas1,ctx:ctx1}=await createCanvas();await drawCard(ctx1,w,h,false);function download(canvas,suffix=''){const link=document.createElement('a');link.download=`protocol-${format}${suffix}.png`;link.href=canvas.toDataURL('image/png');link.click();}download(canvas1);if(includeDual){const{canvas:canvas2,ctx:ctx2}=await createCanvas();await drawCard(ctx2,w,h,true);setTimeout(()=>download(canvas2,'-education'),500);showToast('export');}else{showToast('export');}}
const SNARKY_TOASTS={copy:['WEAPONIZED','LOCKED & LOADED','MIC DROP READY','SAVED FOR LATER','AMMUNITION STORED'],export:['RECEIPTS ACQUIRED','EVIDENCE SECURED','GO RUIN DINNER','CHOOSE VIOLENCE','READY TO DEPLOY'],caption:['CAPTION ARMED','WORDS WEAPONIZED','READY TO FIRE']};
function showToast(type){const t=document.getElementById('toast');const messages=SNARKY_TOASTS[type]||[type];t.textContent=messages[Math.floor(Math.random()*messages.length)];t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
document.getElementById('backBtn').addEventListener('click',()=>{document.getElementById('controlPanel').classList.remove('hidden');document.getElementById('displayPanel').classList.add('hidden');document.getElementById('backBtn').style.display='none';});
document.getElementById('triggerInput').addEventListener('keydown',e=>{if(e.key==='Enter'){const activeTone=document.querySelector('.tone-btn.active');if(activeTone){generateScene(activeTone.dataset.tone);}else{document.querySelector('.tone-btn[data-tone="diplomat"]').click();}}});
}
loadTriggers();
</script>
</body>
</html>
