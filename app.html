<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THE PROTOCOL ‚Äî Matterhood Archive</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root {
  --black: #0A0A0A;
  --white: #FFFFFF;
  --off-white: #F8F8F6;
  --gray: #6B6B6B;
  --gray-light: #E0E0E0;
  --gray-dark: #2A2A2A;
  
  /* Bold card colors */
  --card-yellow: #FFE14D;
  --card-pink: #FF6B9D;
  --card-blue: #4ECDC4;
  --card-orange: #FF8C42;
  --card-purple: #7B4FD3;
  --card-red: #E84855;
  --card-green: #5DBB63;
  --card-mint: #98DFAF;
  
  --bg: var(--white);
  --bg-alt: var(--off-white);
  --text: var(--black);
  --text-dim: var(--gray);
  --border: var(--black);
  --border-light: var(--gray-light);
}

[data-theme="dark"] {
  --bg: #0A0A0A;
  --bg-alt: #141414;
  --text: #F5F5F5;
  --text-dim: #999999;
  --border: #F5F5F5;
  --border-light: #333333;
  --white: #0A0A0A;
  --black: #F5F5F5;
  --off-white: #141414;
  --gray: #999999;
  --gray-light: #333333;
  --gray-dark: #E0E0E0;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Space Mono', monospace;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  transition: background 0.3s, color 0.3s;
}

/* ============================================
   TUTORIAL
   ============================================ */
.tutorial-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: opacity 0.5s;
}

.tutorial-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.tutorial-content {
  max-width: 500px;
  padding: 2rem;
  text-align: center;
}

.tutorial-step {
  display: none;
  animation: fadeUp 0.5s ease forwards;
}

.tutorial-step.active { display: block; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.tutorial-title {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  margin-bottom: 1rem;
}

.tutorial-text {
  font-size: 0.8rem;
  line-height: 1.8;
  color: var(--text-dim);
  margin-bottom: 1.5rem;
}

.tutorial-example {
  background: var(--bg-alt);
  border: 2px solid var(--border);
  padding: 1rem;
  margin: 1.25rem 0;
  text-align: left;
}

.tutorial-example-label {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.2em;
  color: var(--text-dim);
  margin-bottom: 0.4rem;
}

.tutorial-example-text {
  font-family: 'Playfair Display', serif;
  font-size: 0.95rem;
  font-style: italic;
  line-height: 1.6;
}

.tutorial-btn {
  background: var(--black);
  color: var(--white);
  border: 2px solid var(--black);
  padding: 0.75rem 1.5rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.6rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  cursor: pointer;
  transition: all 0.15s;
}

.tutorial-btn:hover {
  background: var(--card-yellow);
  color: #0A0A0A;
  border-color: var(--black);
}

.tutorial-skip {
  display: block;
  margin-top: 1rem;
  background: none;
  border: none;
  color: var(--text-dim);
  font-family: 'Space Mono', monospace;
  font-size: 0.55rem;
  cursor: pointer;
}

.tutorial-skip:hover { color: var(--text); }

.tutorial-dots {
  display: flex;
  justify-content: center;
  gap: 0.4rem;
  margin-top: 1.25rem;
}

.tutorial-dot {
  width: 6px;
  height: 6px;
  background: var(--border-light);
}

.tutorial-dot.active {
  background: var(--black);
}

/* ============================================
   HEADER
   ============================================ */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1.25rem;
  background: var(--bg);
  border-bottom: 2px solid var(--border);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.logo {
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.25em;
}

.logo-sub {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  color: var(--text-dim);
  margin-left: 0.5rem;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.icon-btn {
  background: transparent;
  color: var(--text);
  border: 2px solid var(--border);
  width: 32px;
  height: 32px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.icon-btn:hover {
  background: var(--black);
  color: var(--white);
}

.rec-indicator {
  display: flex;
  align-items: center;
  gap: 0.35rem;
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
}

.rec-dot {
  width: 6px;
  height: 6px;
  background: var(--card-red);
  border-radius: 50%;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ============================================
   MAIN LAYOUT
   ============================================ */
.container {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.main-content {
  flex: 1;
  display: flex;
}

/* ============================================
   CONTROL PANEL
   ============================================ */
.control-panel {
  width: 340px;
  min-width: 340px;
  border-right: 2px solid var(--border);
  padding: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  background: var(--bg-alt);
  overflow-y: auto;
}

.section-label {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.2em;
  color: var(--text-dim);
  margin-bottom: 0.4rem;
}

.input-section {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

/* Input row - aligned heights */
.input-row {
  display: flex;
  gap: 0.5rem;
  align-items: stretch; /* Key for equal heights */
}

.input-row .trigger-input {
  flex: 1;
  height: 44px; /* Fixed height */
}

.trigger-input {
  background: var(--bg);
  color: var(--text);
  border: 2px solid var(--border);
  padding: 0 0.75rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.8rem;
  outline: none;
  transition: all 0.15s;
}

.trigger-input::placeholder {
  color: var(--text-dim);
  font-style: italic;
}

.trigger-input:focus {
  box-shadow: 3px 3px 0 var(--black);
}

/* Random button - same height as input */
.surprise-btn {
  background: var(--bg);
  border: 2px solid var(--border);
  color: var(--text);
  width: 44px;
  height: 44px; /* Match input height */
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.surprise-btn:hover {
  background: var(--card-yellow);
  border-color: #0A0A0A;
}

.triggers-section {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.triggers-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;
  max-height: 110px;
  overflow-y: auto;
  padding-right: 0.3rem;
}

.triggers-grid::-webkit-scrollbar { width: 4px; }
.triggers-grid::-webkit-scrollbar-track { background: var(--border-light); }
.triggers-grid::-webkit-scrollbar-thumb { background: var(--text-dim); }

.trigger-chip {
  background: var(--bg);
  border: 1px solid var(--border-light);
  padding: 0.35rem 0.5rem;
  font-size: 0.6rem;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--text-dim);
  font-family: 'Space Mono', monospace;
}

.trigger-chip:hover {
  border-color: var(--border);
  color: var(--text);
  background: var(--card-yellow);
}

.config-row {
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
}

.config-group {
  flex: 1;
  min-width: 130px;
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

.toggle-group {
  display: flex;
  gap: 0.25rem;
  flex-wrap: wrap;
}

.toggle-btn {
  background: var(--bg);
  border: 2px solid var(--border-light);
  padding: 0.4rem 0.5rem;
  font-size: 0.55rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--text-dim);
  font-family: 'Space Mono', monospace;
  letter-spacing: 0.05em;
}

.toggle-btn:hover {
  border-color: var(--border);
  color: var(--text);
}

.toggle-btn.active {
  background: var(--black);
  color: var(--white);
  border-color: var(--black);
}

.spice-toggle {
  display: flex;
  gap: 0.25rem;
}

.spice-btn {
  flex: 1;
  background: var(--bg);
  border: 2px solid var(--border-light);
  padding: 0.4rem 0.3rem;
  font-size: 0.55rem;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--text-dim);
  font-family: 'Space Mono', monospace;
  text-align: center;
}

.spice-btn:hover {
  border-color: var(--border);
  color: var(--text);
}

.spice-btn.active {
  background: var(--black);
  color: var(--white);
  border-color: var(--black);
}

.spice-btn.active[data-spice="hot"] {
  background: var(--card-red);
  border-color: var(--card-red);
  color: #FFFFFF;
}

.tone-section {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.tone-buttons {
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.tone-btn {
  background: var(--bg);
  color: var(--text);
  border: 2px solid var(--border-light);
  padding: 0.7rem 0.85rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
  transition: all 0.15s;
  text-align: left;
  display: flex;
  justify-content: space-between;
}

.tone-btn:hover {
  border-color: var(--border);
  box-shadow: 3px 3px 0 var(--border-light);
}

.tone-btn.active {
  background: var(--black);
  color: var(--white);
  border-color: var(--black);
  box-shadow: 4px 4px 0 var(--border-light);
}

.tone-desc {
  font-size: 0.5rem;
  font-weight: 400;
  color: var(--text-dim);
}

.tone-btn.active .tone-desc {
  color: rgba(255,255,255,0.6);
}

/* ============================================
   DISPLAY PANEL - Abstract Pattern Background
   ============================================ */
.display-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1.5rem;
  position: relative;
  overflow: hidden;
  background: var(--bg);
}

/* Abstract geometric pattern background */
.pattern-bg {
  position: absolute;
  inset: 0;
  opacity: 0.04;
  pointer-events: none;
  background-image: 
    /* Large circles */
    radial-gradient(circle at 20% 30%, var(--text) 1px, transparent 1px),
    radial-gradient(circle at 80% 70%, var(--text) 1px, transparent 1px),
    /* Grid dots */
    radial-gradient(circle, var(--text) 1px, transparent 1px);
  background-size: 
    400px 400px,
    400px 400px,
    24px 24px;
  background-position:
    0 0,
    200px 200px,
    0 0;
}

/* Floating quote marks decoration */
.quote-decoration {
  position: absolute;
  font-family: 'Playfair Display', serif;
  font-size: 15rem;
  opacity: 0.03;
  pointer-events: none;
  color: var(--text);
  line-height: 1;
}

.quote-decoration.top-left {
  top: -2rem;
  left: 5%;
}

.quote-decoration.bottom-right {
  bottom: -4rem;
  right: 5%;
  transform: rotate(180deg);
}

.script-display {
  max-width: 550px;
  width: 100%;
  position: relative;
  z-index: 10;
}

.placeholder-card {
  text-align: center;
  padding: 2.5rem 1rem;
}

.placeholder-text {
  font-family: 'Playfair Display', serif;
  font-size: 1.2rem;
  font-style: italic;
  color: var(--text-dim);
  line-height: 2;
}

.placeholder-text span { display: block; }

/* ============================================
   THE RESPONSE CARD - Bold Colored
   All text on colored backgrounds is BLACK
   ============================================ */
.script-card {
  display: none;
  border: 3px solid #0A0A0A;
  position: relative;
  transition: transform 0.2s, box-shadow 0.2s;
}

[data-theme="dark"] .script-card {
  border-color: #F5F5F5;
}

.script-card.active {
  display: block;
  animation: cardReveal 0.5s ease forwards;
}

.script-card:hover {
  box-shadow: 6px 6px 0 var(--border-light);
}

@keyframes cardReveal {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Card top - colored section - ALWAYS black text */
.script-card-top {
  padding: 1.5rem;
  background: var(--card-yellow);
  color: #0A0A0A !important;
  position: relative;
}

/* Card color variants - all have black text */
.script-card.color-yellow .script-card-top { background: var(--card-yellow); }
.script-card.color-pink .script-card-top { background: var(--card-pink); }
.script-card.color-blue .script-card-top { background: var(--card-blue); }
.script-card.color-orange .script-card-top { background: var(--card-orange); }
.script-card.color-purple .script-card-top { background: var(--card-purple); }
.script-card.color-red .script-card-top { background: var(--card-red); }
.script-card.color-green .script-card-top { background: var(--card-green); }
.script-card.color-mint .script-card-top { background: var(--card-mint); }

/* Force all text in colored top to be black */
.script-card-top,
.script-card-top * {
  color: #0A0A0A !important;
}

.script-stamp {
  position: absolute;
  top: 1rem;
  right: 1rem;
  font-size: 0.4rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  padding: 0.25rem 0.5rem;
  border: 1.5px solid #0A0A0A;
  opacity: 0.7;
}

.script-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.script-context {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  opacity: 0.7;
}

.script-trigger-section {
  margin-bottom: 0.5rem;
}

.script-trigger-label {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  opacity: 0.6;
  margin-bottom: 0.3rem;
}

.script-trigger-text {
  font-family: 'Playfair Display', serif;
  font-size: 1.4rem;
  font-style: italic;
  line-height: 1.3;
  padding-right: 3rem;
}

.script-subtext {
  font-size: 0.6rem;
  font-style: italic;
  opacity: 0.7;
  margin-top: 0.75rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.15);
}

.script-subtext::before {
  content: 'SUBTEXT: ';
  font-style: normal;
  font-weight: 700;
  opacity: 0.6;
}

/* Card bottom - response section */
.script-card-bottom {
  padding: 1.25rem 1.5rem;
  background: var(--bg);
  border-top: 3px solid #0A0A0A;
}

[data-theme="dark"] .script-card-bottom {
  border-top-color: #F5F5F5;
}

.script-response-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.script-response-label {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text);
}

.script-response-type {
  background: var(--black);
  color: var(--white);
  padding: 0.2rem 0.5rem;
  font-size: 0.45rem;
}

.script-spice {
  font-size: 0.9rem;
  letter-spacing: -0.05em;
}

.script-text {
  font-family: 'Playfair Display', serif;
  font-size: clamp(1.1rem, 2.2vw, 1.5rem);
  line-height: 1.45;
  color: var(--text);
}

.script-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1rem;
  padding-top: 0.75rem;
  border-top: 1px solid var(--border-light);
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: var(--text-dim);
}

/* ============================================
   CONTROLS
   ============================================ */
.controls {
  display: flex;
  gap: 0.4rem;
  justify-content: center;
  margin-top: 1.25rem;
  flex-wrap: wrap;
}

.control-btn {
  background: var(--bg);
  color: var(--text);
  border: 2px solid var(--border);
  padding: 0.6rem 1rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.55rem;
  font-weight: 700;
  letter-spacing: 0.12em;
  cursor: pointer;
  transition: all 0.15s;
}

.control-btn:hover:not(:disabled) {
  box-shadow: 3px 3px 0 var(--border-light);
}

.control-btn:disabled {
  opacity: 0.2;
  cursor: not-allowed;
}

.control-btn.primary {
  background: var(--black);
  color: var(--white);
}

.control-btn.primary:hover:not(:disabled) {
  background: var(--card-yellow);
  color: #0A0A0A;
  border-color: #0A0A0A;
}

/* ============================================
   EXPORT MODAL
   ============================================ */
.export-options {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(10,10,10,0.9);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.export-options.active { display: flex; }

.export-modal {
  background: var(--bg);
  border: 3px solid #0A0A0A;
  padding: 1.75rem;
  max-width: 400px;
  width: 90%;
}

[data-theme="dark"] .export-modal {
  border-color: #F5F5F5;
}

.export-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem;
  margin-bottom: 0.3rem;
}

.export-subtitle {
  font-size: 0.55rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: var(--text-dim);
  margin-bottom: 1.25rem;
}

.export-formats {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-bottom: 1.25rem;
}

.export-format-btn {
  background: var(--bg-alt);
  border: 2px solid var(--border-light);
  padding: 0.9rem 1rem;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-family: 'Space Mono', monospace;
  color: var(--text);
}

.export-format-btn:hover {
  border-color: var(--border);
  box-shadow: 3px 3px 0 var(--border-light);
}

.export-format-name {
  font-size: 0.65rem;
  font-weight: 700;
  letter-spacing: 0.1em;
}

.export-format-size {
  font-size: 0.5rem;
  color: var(--text-dim);
}

.export-toggles {
  display: flex;
  flex-direction: column;
  gap: 0.6rem;
  margin-bottom: 1.25rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border-light);
}

.export-toggle {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  cursor: pointer;
  font-size: 0.6rem;
  letter-spacing: 0.05em;
  color: var(--text-dim);
}

.export-toggle input {
  appearance: none;
  width: 16px;
  height: 16px;
  border: 2px solid var(--border-light);
  background: transparent;
  cursor: pointer;
  position: relative;
}

.export-toggle input:checked {
  border-color: #0A0A0A;
  background: #0A0A0A;
}

[data-theme="dark"] .export-toggle input:checked {
  border-color: #F5F5F5;
  background: #F5F5F5;
}

.export-toggle input:checked::after {
  content: '‚úì';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 10px;
  color: var(--white);
}

[data-theme="dark"] .export-toggle input:checked::after {
  color: #0A0A0A;
}

.export-toggle:hover { color: var(--text); }

.caption-section {
  border-top: 1px solid var(--border-light);
  padding-top: 1rem;
  margin-bottom: 1rem;
}

.caption-label {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  color: var(--text-dim);
  margin-bottom: 0.6rem;
}

.caption-suggestions {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.caption-item {
  background: var(--bg-alt);
  border: 1px solid var(--border-light);
  padding: 0.6rem 0.8rem;
  font-size: 0.6rem;
  line-height: 1.5;
  cursor: pointer;
  transition: all 0.15s;
  color: var(--text-dim);
}

.caption-item:hover {
  border-color: var(--border);
  color: var(--text);
}

.caption-item.copied {
  border-color: var(--card-green);
  background: var(--card-green);
  color: #0A0A0A;
}

.export-close {
  width: 100%;
  background: none;
  border: 2px solid var(--border-light);
  color: var(--text-dim);
  padding: 0.6rem 1rem;
  font-family: 'Space Mono', monospace;
  font-size: 0.55rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  cursor: pointer;
}

.export-close:hover {
  border-color: var(--border);
  color: var(--text);
}

/* ============================================
   TOAST
   ============================================ */
.toast {
  position: fixed;
  bottom: 1.25rem;
  left: 50%;
  transform: translateX(-50%) translateY(150%);
  background: #0A0A0A;
  color: #F5F5F5;
  padding: 0.75rem 1.25rem;
  font-size: 0.55rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  z-index: 1001;
  transition: transform 0.3s;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
}

/* ============================================
   FOOTER
   ============================================ */
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  border-top: 2px solid var(--border);
  padding: 0.75rem 1rem;
  text-align: center;
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  background: var(--bg);
  z-index: 50;
}

footer a {
  color: var(--text);
  text-decoration: none;
}

footer a:hover {
  text-decoration: underline;
}

/* ============================================
   ANIMATION OVERLAY
   ============================================ */
.animate-overlay {
  position: fixed;
  inset: 0;
  background: var(--bg);
  z-index: 2000;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.animate-overlay.active { display: flex; }

.animate-scene {
  position: relative;
  width: 100%;
  height: 100%;
  max-width: 450px;
  aspect-ratio: 9/16;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* Pattern background for animation too */
.animate-pattern {
  position: absolute;
  inset: 0;
  opacity: 0.03;
  background-image: 
    radial-gradient(circle at 20% 30%, var(--text) 1px, transparent 1px),
    radial-gradient(circle, var(--text) 1px, transparent 1px);
  background-size: 
    300px 300px,
    20px 20px;
}

.animate-card {
  position: relative;
  width: 88%;
  border: 3px solid #0A0A0A;
  z-index: 10;
  box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}

[data-theme="dark"] .animate-card {
  border-color: #F5F5F5;
}

/* Animation card top - always black text */
.animate-card-top {
  background: var(--card-yellow);
  padding: 1.5rem;
  position: relative;
}

.animate-card-top,
.animate-card-top * {
  color: #0A0A0A !important;
}

.animate-stamp {
  position: absolute;
  top: 1rem;
  right: 1rem;
  font-size: 0.4rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  padding: 0.25rem 0.5rem;
  border: 1.5px solid #0A0A0A;
  opacity: 0.7;
}

.animate-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.animate-context {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  opacity: 0.7;
}

.animate-trigger-wrapper {
  margin-bottom: 0.5rem;
}

.animate-label {
  display: block;
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  opacity: 0.6;
  margin-bottom: 0.3rem;
}

.animate-trigger-text {
  font-family: 'Playfair Display', serif;
  font-size: 1.2rem;
  font-style: italic;
  line-height: 1.4;
  opacity: 0;
}

.animate-subtext {
  font-size: 0.55rem;
  font-style: italic;
  opacity: 0;
  margin-top: 0.75rem;
  padding-top: 0.75rem;
  border-top: 1px solid rgba(0,0,0,0.15);
  transform: translateY(10px);
}

.animate-subtext::before {
  content: 'SUBTEXT: ';
  font-style: normal;
  font-weight: 700;
  opacity: 0.6;
}

.animate-card-bottom {
  background: var(--bg);
  border-top: 3px solid #0A0A0A;
  padding: 1.25rem 1.5rem;
}

[data-theme="dark"] .animate-card-bottom {
  border-top-color: #F5F5F5;
}

.animate-response-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.animate-response-label {
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text);
}

.animate-response-type {
  background: var(--black);
  color: var(--white);
  padding: 0.2rem 0.5rem;
  font-size: 0.45rem;
}

.animate-spice {
  font-size: 0.9rem;
}

.animate-response-text {
  font-family: 'Playfair Display', serif;
  font-size: clamp(1rem, 2vw, 1.4rem);
  line-height: 1.45;
  color: var(--text);
  min-height: 2.5rem;
}

.animate-response-text .word {
  display: inline-block;
  white-space: nowrap;
  margin-right: 0.25em;
}

.animate-response-text .char {
  opacity: 0;
  display: inline-block;
}

.animate-footer {
  display: flex;
  justify-content: space-between;
  margin-top: 1rem;
  padding-top: 0.75rem;
  border-top: 1px solid var(--border-light);
  font-size: 0.5rem;
  font-weight: 700;
  letter-spacing: 0.1em;
  color: var(--text-dim);
}

.animate-controls {
  position: absolute;
  bottom: 2rem;
  display: flex;
  gap: 1rem;
  z-index: 20;
  transition: opacity 0.5s ease;
}

.animate-hint {
  position: absolute;
  bottom: 5rem;
  font-size: 0.6rem;
  font-weight: 700;
  letter-spacing: 0.15em;
  color: var(--text-dim);
  z-index: 20;
  transition: opacity 0.5s ease;
}

.animate-overlay.clean-mode .animate-controls,
.animate-overlay.clean-mode .animate-hint {
  opacity: 0;
  pointer-events: none;
}

.animate-subtext.show,
.animate-trigger-text.show {
  animation: fadeUp 0.6s ease forwards;
}

.animate-response-text .char.show {
  animation: charIn 0.05s ease forwards;
}

@keyframes charIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 900px) {
  .logo-sub { display: none; }
  
  .main-content { flex-direction: column; }
  
  .control-panel {
    width: 100%;
    min-width: 0;
    border-right: none;
    border-bottom: 2px solid var(--border);
    padding: 1rem;
    max-height: none;
  }
  
  .control-panel.hidden { display: none; }
  
  .config-row {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .config-group { min-width: 100%; }
  
  .triggers-grid {
    max-height: none;
    overflow-y: visible;
  }
  
  .tone-buttons {
    flex-direction: row;
    flex-wrap: wrap;
  }
  
  .tone-btn {
    flex: 1 1 calc(50% - 0.15rem);
    text-align: center;
    padding: 0.6rem 0.35rem;
    font-size: 0.6rem;
    flex-direction: column;
    gap: 0.15rem;
  }
  
  .tone-desc { display: none; }
  
  .display-panel {
    padding: 1rem;
    min-height: 55vh;
  }
  
  .display-panel.hidden { display: none; }
  
  .script-card-top { padding: 1.25rem; }
  .script-card-bottom { padding: 1rem 1.25rem; }
  
  .back-btn {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    z-index: 20;
  }
  
  .controls {
    flex-direction: column;
    width: 100%;
  }
  
  .control-btn { width: 100%; }
  
  .quote-decoration { display: none; }
}

@media (min-width: 901px) {
  .mobile-only { display: none !important; }
}

.script-card:not(.active) { display: none; }
</style>
</head>
<body>

<div class="tutorial-overlay" id="tutorialOverlay">
  <div class="tutorial-content">
    <div class="tutorial-step active" data-step="1">
      <div class="tutorial-title">The Protocol</div>
      <div class="tutorial-text">Scripts for the moments you didn't ask for.<br><br>When someone intrudes on your fertility, your family, or your choices ‚Äî this tool helps you rewrite the scene.</div>
      <button class="tutorial-btn" onclick="goToStep(2)">BEGIN</button>
      <button class="tutorial-skip" onclick="completeTutorial()">Skip intro</button>
    </div>
    <div class="tutorial-step" data-step="2">
      <div class="tutorial-title">The Trigger</div>
      <div class="tutorial-text">Enter what they said ‚Äî or choose from common triggers.</div>
      <div class="tutorial-example">
        <div class="tutorial-example-label">THEY SAID:</div>
        <div class="tutorial-example-text">"You just need to relax and it will happen."</div>
      </div>
      <button class="tutorial-btn" onclick="goToStep(3)">NEXT</button>
    </div>
    <div class="tutorial-step" data-step="3">
      <div class="tutorial-title">The Calibration</div>
      <div class="tutorial-text">Tell us who said it, how spicy you want to go, and whether you speak as "I" or "We".</div>
      <div class="tutorial-example">
        <div class="tutorial-example-label">SETTINGS:</div>
        <div class="tutorial-example-text">Context: Family / Stranger / Colleague / Medical<br>Spice: üå∂Ô∏è Mild / üå∂Ô∏èüå∂Ô∏è Medium / üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è Hot<br>Perspective: I / We</div>
      </div>
      <button class="tutorial-btn" onclick="goToStep(4)">NEXT</button>
    </div>
    <div class="tutorial-step" data-step="4">
      <div class="tutorial-title">The Voice</div>
      <div class="tutorial-text">Choose your tone. Diplomat deflects gracefully. Critic cuts clean. Absurdist finds the dark humour. Realist speaks plain truth.</div>
      <div class="tutorial-example">
        <div class="tutorial-example-label">THE VOICES:</div>
        <div class="tutorial-example-text">Diplomat ‚Äî Graceful boundary<br>Critic ‚Äî Sharp truth<br>Absurdist ‚Äî Deadpan weird<br>Realist ‚Äî Honest acceptance</div>
      </div>
      <button class="tutorial-btn" onclick="goToStep(5)">NEXT</button>
    </div>
    <div class="tutorial-step" data-step="5">
      <div class="tutorial-title">The Export</div>
      <div class="tutorial-text">Save your scene as an image. Hit "New Take" for variations. Instagram Stories, feed posts, or just for you.</div>
      <button class="tutorial-btn" onclick="completeTutorial()">START</button>
    </div>
    <div class="tutorial-dots">
      <div class="tutorial-dot active" data-dot="1"></div>
      <div class="tutorial-dot" data-dot="2"></div>
      <div class="tutorial-dot" data-dot="3"></div>
      <div class="tutorial-dot" data-dot="4"></div>
      <div class="tutorial-dot" data-dot="5"></div>
    </div>
  </div>
</div>

<div class="container">
  <header>
    <div class="header-left">
      <div class="logo">THE PROTOCOL<span class="logo-sub">MATTERHOOD</span></div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="themeToggle" title="Toggle light/dark mode">‚òæ</button>
      <button class="icon-btn" onclick="showTutorial()" title="Help">?</button>
      <div class="rec-indicator"><div class="rec-dot"></div><span>REC</span></div>
    </div>
  </header>

  <div class="main-content">
    <div class="control-panel" id="controlPanel">
      <div class="input-section">
        <div class="section-label">THEY SAID:</div>
        <div class="input-row">
          <input type="text" class="trigger-input" id="triggerInput" placeholder="Type what they said...">
          <button class="surprise-btn" id="surpriseBtn" title="Random trigger">üé≤</button>
        </div>
      </div>

      <div class="triggers-section">
        <div class="section-label">COMMON TRIGGERS:</div>
        <div class="triggers-grid" id="triggersGrid"></div>
      </div>

      <div class="config-row">
        <div class="config-group">
          <div class="section-label">THEY ARE:</div>
          <div class="toggle-group" id="contextGroup">
            <button class="toggle-btn active" data-context="stranger">STRANGER</button>
            <button class="toggle-btn" data-context="family">FAMILY</button>
            <button class="toggle-btn" data-context="colleague">COLLEAGUE</button>
            <button class="toggle-btn" data-context="medical">MEDICAL</button>
          </div>
        </div>
      </div>

      <div class="config-row">
        <div class="config-group">
          <div class="section-label">SPICE LEVEL:</div>
          <div class="spice-toggle" id="spiceGroup">
            <button class="spice-btn" data-spice="mild">üå∂Ô∏è</button>
            <button class="spice-btn active" data-spice="medium">üå∂Ô∏èüå∂Ô∏è</button>
            <button class="spice-btn" data-spice="hot">üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è</button>
          </div>
        </div>
        <div class="config-group">
          <div class="section-label">PERSPECTIVE:</div>
          <div class="toggle-group" id="perspectiveGroup">
            <button class="toggle-btn" data-perspective="i">I</button>
            <button class="toggle-btn active" data-perspective="we">WE</button>
          </div>
        </div>
      </div>

      <div class="tone-section">
        <div class="section-label">YOUR VOICE:</div>
        <div class="tone-buttons">
          <button class="tone-btn" data-tone="diplomat"><span>DIPLOMAT</span><span class="tone-desc">Graceful</span></button>
          <button class="tone-btn" data-tone="critic"><span>CRITIC</span><span class="tone-desc">Sharp</span></button>
          <button class="tone-btn" data-tone="absurdist"><span>ABSURDIST</span><span class="tone-desc">Deadpan</span></button>
          <button class="tone-btn" data-tone="realist"><span>REALIST</span><span class="tone-desc">Honest</span></button>
        </div>
      </div>
    </div>

    <div class="display-panel" id="displayPanel">
      <!-- Abstract pattern background -->
      <div class="pattern-bg"></div>
      
      <!-- Decorative quote marks -->
      <div class="quote-decoration top-left">"</div>
      <div class="quote-decoration bottom-right">"</div>
      
      <button class="control-btn mobile-only back-btn" id="backBtn" style="display:none">‚Üê BACK</button>

      <div class="script-display">
        <div class="placeholder-card" id="placeholderCard">
          <div class="placeholder-text">
            <span>Enter what they said.</span>
            <span>Calibrate your response.</span>
            <span>Choose your voice.</span>
          </div>
        </div>

        <div class="script-card" id="scriptCard">
          <div class="script-card-top">
            <span class="script-stamp">MATTERHOOD</span>
            <div class="script-meta">
              <span class="script-context" id="contextDisplay">STRANGER</span>
            </div>
            <div class="script-trigger-section">
              <div class="script-trigger-label">THEY SAID:</div>
              <div class="script-trigger-text" id="triggerDisplay"></div>
            </div>
            <div class="script-subtext" id="subtextDisplay"></div>
          </div>
          <div class="script-card-bottom">
            <div class="script-response-header">
              <div class="script-response-label">
                RESPONSE <span class="script-response-type" id="toneDisplay">DIPLOMAT</span>
              </div>
              <span class="script-spice" id="spiceDisplay">üå∂Ô∏èüå∂Ô∏è</span>
            </div>
            <div class="script-text" id="scriptText"></div>
            <div class="script-footer">
              <span>THE PROTOCOL</span>
              <span>+11 MORE ‚Üí</span>
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="control-btn" id="newTakeBtn" disabled>NEW TAKE</button>
          <button class="control-btn" id="copyBtn" disabled>COPY</button>
          <button class="control-btn" id="animateBtn" disabled>ANIMATE</button>
          <button class="control-btn primary" id="exportBtn" disabled>EXPORT</button>
        </div>
      </div>
    </div>
  </div>

  <div class="export-options" id="exportOptions">
    <div class="export-modal">
      <div class="export-title">Export Scene</div>
      <div class="export-subtitle">CHOOSE YOUR FORMAT</div>
      <div class="export-formats">
        <button class="export-format-btn" data-format="story"><span class="export-format-name">STORY</span><span class="export-format-size">1080 √ó 1920</span></button>
        <button class="export-format-btn" data-format="square"><span class="export-format-name">SQUARE</span><span class="export-format-size">1080 √ó 1080</span></button>
        <button class="export-format-btn" data-format="wide"><span class="export-format-name">WIDE</span><span class="export-format-size">1200 √ó 675</span></button>
      </div>
      <div class="export-toggles">
        <label class="export-toggle"><input type="checkbox" id="toggleQR" checked><span>Include QR code</span></label>
        <label class="export-toggle"><input type="checkbox" id="toggleDual"><span>Add "Why this hurts" card</span></label>
      </div>
      <div class="caption-section">
        <div class="caption-label">CAPTION (TAP TO COPY)</div>
        <div class="caption-suggestions" id="captionSuggestions"></div>
      </div>
      <button class="export-close" id="exportClose">CANCEL</button>
    </div>
  </div>

  <div class="animate-overlay" id="animateOverlay">
    <div class="animate-scene" id="animateScene">
      <div class="animate-pattern"></div>
      <div class="animate-card">
        <div class="animate-card-top" id="animCardTop">
          <span class="animate-stamp">MATTERHOOD</span>
          <div class="animate-meta">
            <span class="animate-context" id="animContext">STRANGER</span>
          </div>
          <div class="animate-trigger-wrapper">
            <span class="animate-label">THEY SAID:</span>
            <span class="animate-trigger-text" id="animTrigger"></span>
          </div>
          <div class="animate-subtext" id="animSubtext"></div>
        </div>
        <div class="animate-card-bottom">
          <div class="animate-response-header">
            <div class="animate-response-label">
              RESPONSE <span class="animate-response-type" id="animTone">DIPLOMAT</span>
            </div>
            <span class="animate-spice" id="animSpice">üå∂Ô∏èüå∂Ô∏è</span>
          </div>
          <div class="animate-response-text" id="animResponse"></div>
          <div class="animate-footer">
            <span>THE PROTOCOL</span>
            <span>MATTERHOOD</span>
          </div>
        </div>
      </div>
    </div>
    <div class="animate-hint">Screen record this for your story</div>
    <div class="animate-controls">
      <button class="control-btn" id="replayBtn">REPLAY</button>
      <button class="control-btn" id="animCloseBtn">CLOSE</button>
    </div>
  </div>
</div>

<footer>MADE WITH LOVE AND FRUSTRATION BY <a href="#">CRAIG & COURTNEY</a></footer>

<div class="toast" id="toast">EXPORTED</div>

<script>
// THE PROTOCOL v4.0 ‚Äî Bold Design System with Pattern Background
let TRIGGERS = [];

// Card colors that cycle
const CARD_COLORS = ['color-yellow', 'color-pink', 'color-blue', 'color-orange', 'color-purple', 'color-green', 'color-mint', 'color-red'];
const CARD_COLOR_VALUES = {
  'color-yellow': '#FFE14D',
  'color-pink': '#FF6B9D',
  'color-blue': '#4ECDC4',
  'color-orange': '#FF8C42',
  'color-purple': '#7B4FD3',
  'color-red': '#E84855',
  'color-green': '#5DBB63',
  'color-mint': '#98DFAF'
};
let colorIndex = 0;

// Tutorial
function goToStep(n) {
  document.querySelectorAll('.tutorial-step').forEach(s => s.classList.remove('active'));
  document.querySelector(`.tutorial-step[data-step="${n}"]`)?.classList.add('active');
  document.querySelectorAll('.tutorial-dot').forEach(d => d.classList.remove('active'));
  document.querySelector(`.tutorial-dot[data-dot="${n}"]`)?.classList.add('active');
}

function completeTutorial() {
  localStorage.setItem('protocol_tutorial_v6', 'true');
  document.getElementById('tutorialOverlay').classList.add('hidden');
}

function showTutorial() {
  document.getElementById('tutorialOverlay').classList.remove('hidden');
  goToStep(1);
}

// Load triggers
async function loadTriggers() {
  try {
    const response = await fetch('triggers.json');
    TRIGGERS = await response.json();
    console.log(`Loaded ${TRIGGERS.length} triggers`);
    initApp();
  } catch (err) {
    console.error('Failed to load triggers:', err);
    document.body.innerHTML = '<div style="padding:2rem;color:#E84855;">Failed to load response data. Please refresh.</div>';
  }
}

function initApp() {
  const COMMON_TRIGGERS = ["Just relax", "Why don't you adopt?", "Have you tried IVF?", "Everything happens for a reason", "My cousin stopped trying", "At least you have freedom", "Who's the problem?", "Tick tock", "You'll regret it", "You wouldn't understand", "Must be nice to sleep in", "At least you have each other"];
  const CONTEXT_LABELS = { stranger: "STRANGER", family: "FAMILY", colleague: "COLLEAGUE", medical: "MEDICAL" };
  const SPICE_LABELS = { mild: "üå∂Ô∏è", medium: "üå∂Ô∏èüå∂Ô∏è", hot: "üå∂Ô∏èüå∂Ô∏èüå∂Ô∏è" };
  const TONE_LABELS = { diplomat: "DIPLOMAT", critic: "CRITIC", absurdist: "ABSURDIST", realist: "REALIST" };

  let currentTone = null, currentTrigger = null, currentResponse = null, currentSubtext = '', currentMatchedTrigger = null, currentCardColor = 'color-yellow';
  let context = 'stranger', spice = 'medium', perspective = 'we';
  let usedResponses = {};

  // Check tutorial
  if (localStorage.getItem('protocol_tutorial_v6')) document.getElementById('tutorialOverlay').classList.add('hidden');

  // Matching functions
  function normalize(t) { return t.toLowerCase().replace(/['']/g, "'").replace(/[""]/g, '"').replace(/[?!.,;:]/g, '').replace(/\s+/g, ' ').trim(); }
  
  const FILLER_WORDS = new Set(['a', 'an', 'the', 'you', 'your', 'i', 'my', 'we', 'our', 'just', 'really', 'actually', 'maybe', 'perhaps', 'ever', 'even', 'so', 'very', 'like', 'know', 'think', 'well', 'oh', 'um', 'uh', 'hey', 'but', 'and', 'or', 'if', 'then', 'have', 'has', 'had', 'do', 'does', 'did', 'should', 'could', 'would', 'can', 'will', 'been', 'being', 'gonna', 'gotta', 'wanna', 'dont', 'didnt', 'cant', 'wont', 'youre', 'youve', 'youll', 'ive', 'im', 'were', 'weve', 'thats', 'its', 'hes', 'shes', 'theyre', 'theyve']);

  function removeFillers(text) { return text.split(' ').filter(w => !FILLER_WORDS.has(w)).join(' '); }

  function similarity(a, b) {
    if (a === b) return 1;
    if (a.length < 2 || b.length < 2) return 0;
    const bigramsA = new Map();
    for (let i = 0; i < a.length - 1; i++) {
      const bg = a.substring(i, i + 2);
      bigramsA.set(bg, (bigramsA.get(bg) || 0) + 1);
    }
    let matches = 0;
    for (let i = 0; i < b.length - 1; i++) {
      const bg = b.substring(i, i + 2);
      if (bigramsA.get(bg) > 0) { matches++; bigramsA.set(bg, bigramsA.get(bg) - 1); }
    }
    return (2 * matches) / (a.length + b.length - 2);
  }

  function findMatch(input) {
    const n = normalize(input);
    if (!n) return null;
    const nNoFill = removeFillers(n);
    let bestMatch = null, bestScore = 0;

    for (const t of TRIGGERS) {
      for (const p of t.triggers) {
        const pattern = normalize(p);
        const patternNoFill = removeFillers(pattern);
        if (n.includes(pattern)) return t;
        if (nNoFill.includes(patternNoFill) && patternNoFill.length > 3) { if (0.95 > bestScore) { bestScore = 0.95; bestMatch = t; } continue; }
        if (n.includes(patternNoFill) && patternNoFill.length > 3) { if (0.9 > bestScore) { bestScore = 0.9; bestMatch = t; } continue; }
        const patternWords = patternNoFill.split(' ').filter(w => w.length > 2);
        const inputWords = nNoFill.split(' ').filter(w => w.length > 2);
        if (patternWords.length > 0) {
          let wordMatches = 0;
          for (const pw of patternWords) {
            for (const iw of inputWords) {
              if (pw === iw) { wordMatches++; break; }
              if (pw.length > 3 && iw.length > 3 && similarity(pw, iw) > 0.7) { wordMatches += 0.8; break; }
            }
          }
          const score = wordMatches / patternWords.length;
          if (score > bestScore && score >= 0.5) { bestScore = score; bestMatch = t; }
        }
        const sim = similarity(nNoFill, patternNoFill);
        if (sim > bestScore && sim >= 0.6) { bestScore = sim; bestMatch = t; }
      }
    }
    return bestMatch;
  }

  function swapPerspective(text) {
    if (perspective === 'i') {
      return text.replace(/\{We're\}/g, "I'm").replace(/\{we're\}/g, "I'm").replace(/\{We've\}/g, "I've").replace(/\{we've\}/g, "I've").replace(/\{We'll\}/g, "I'll").replace(/\{we'll\}/g, "I'll").replace(/\{We'd\}/g, "I'd").replace(/\{we'd\}/g, "I'd").replace(/\{We\}/g, "I").replace(/\{we\}/g, "I").replace(/\{Our\}/g, "My").replace(/\{our\}/g, "my").replace(/\{us\}/g, "me").replace(/\{Us\}/g, "Me").replace(/\{I\}'m/g, "I'm").replace(/\{I\}'ve/g, "I've").replace(/\{I\}'ll/g, "I'll").replace(/\{I\}'d/g, "I'd").replace(/\{I\}/g, "I").replace(/\{I'm\}/g, "I'm").replace(/\{My\}/g, "My").replace(/\{my\}/g, "my").replace(/\{me\}/g, "me");
    } else {
      return text.replace(/\{We're\}/g, "We're").replace(/\{we're\}/g, "we're").replace(/\{We've\}/g, "We've").replace(/\{we've\}/g, "we've").replace(/\{We'll\}/g, "We'll").replace(/\{we'll\}/g, "we'll").replace(/\{We'd\}/g, "We'd").replace(/\{we'd\}/g, "we'd").replace(/\{We\}/g, "We").replace(/\{we\}/g, "we").replace(/\{Our\}/g, "Our").replace(/\{our\}/g, "our").replace(/\{us\}/g, "us").replace(/\{Us\}/g, "Us").replace(/\{I\}'m/g, "We're").replace(/\{I\}'ve/g, "We've").replace(/\{I\}'ll/g, "We'll").replace(/\{I\}'d/g, "We'd").replace(/\{I\}/g, "We").replace(/\{I'm\}/g, "We're").replace(/\{My\}/g, "Our").replace(/\{my\}/g, "our").replace(/\{me\}/g, "us");
    }
  }

  function getResponseKey(trigger, tone, spiceLevel) { return `${trigger.triggers[0]}-${tone}-${spiceLevel}`; }

  function getRandomResponse(variants, key) {
    if (!usedResponses[key]) usedResponses[key] = [];
    const available = variants.filter((_, i) => !usedResponses[key].includes(i));
    if (available.length === 0) { usedResponses[key] = []; return variants[Math.floor(Math.random() * variants.length)]; }
    const idx = variants.indexOf(available[Math.floor(Math.random() * available.length)]);
    usedResponses[key].push(idx);
    return variants[idx];
  }

  function generateScene(tone) {
    const input = document.getElementById('triggerInput').value.trim();
    if (!input) { document.getElementById('triggerInput').focus(); return; }
    
    currentTone = tone;
    const match = findMatch(input);
    currentMatchedTrigger = match;

    if (match) {
      currentSubtext = match.subtext;
      const toneResponses = match.responses[tone];
      const variants = toneResponses[spice] || toneResponses.medium;
      const key = getResponseKey(match, tone, spice);
      const rawResponse = Array.isArray(variants) ? getRandomResponse(variants, key) : variants;
      currentResponse = swapPerspective(rawResponse);
    } else {
      currentSubtext = "A question that doesn't deserve this much thought.";
      const fallbacks = ["Some questions don't deserve answers. This is one of them.", "Not every question deserves {our} energy.", "That one's not in {our} script. For good reason.", "{We} don't have a rehearsed response for that."];
      currentResponse = swapPerspective(fallbacks[Math.floor(Math.random() * fallbacks.length)]);
    }

    currentTrigger = input;

    // Update card
    const card = document.getElementById('scriptCard');
    
    // Cycle card color
    CARD_COLORS.forEach(c => card.classList.remove(c));
    currentCardColor = CARD_COLORS[colorIndex];
    card.classList.add(currentCardColor);
    colorIndex = (colorIndex + 1) % CARD_COLORS.length;

    document.getElementById('subtextDisplay').textContent = currentSubtext;
    document.getElementById('triggerDisplay').textContent = input;
    document.getElementById('scriptText').textContent = currentResponse;
    document.getElementById('contextDisplay').textContent = CONTEXT_LABELS[context];
    document.getElementById('spiceDisplay').textContent = SPICE_LABELS[spice];
    document.getElementById('toneDisplay').textContent = TONE_LABELS[tone];

    document.getElementById('placeholderCard').style.display = 'none';
    card.classList.remove('active');
    void card.offsetWidth;
    card.classList.add('active');

    document.getElementById('newTakeBtn').disabled = false;
    document.getElementById('copyBtn').disabled = false;
    document.getElementById('animateBtn').disabled = false;
    document.getElementById('exportBtn').disabled = false;

    if (window.innerWidth <= 900) {
      document.getElementById('controlPanel').classList.add('hidden');
      document.getElementById('displayPanel').classList.remove('hidden');
      document.getElementById('backBtn').style.display = 'block';
    }
  }

  // Toggle handlers
  function setupToggles(groupId, callback) {
    document.querySelectorAll(`#${groupId} .toggle-btn, #${groupId} .spice-btn`).forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll(`#${groupId} .toggle-btn, #${groupId} .spice-btn`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        callback(btn.dataset.context || btn.dataset.spice || btn.dataset.perspective);
      });
    });
  }

  setupToggles('contextGroup', v => { context = v; });
  setupToggles('spiceGroup', v => { spice = v; });
  setupToggles('perspectiveGroup', v => { perspective = v; });

  // Chips
  COMMON_TRIGGERS.forEach(t => {
    const c = document.createElement('button');
    c.className = 'trigger-chip';
    c.textContent = t;
    c.onclick = () => { document.getElementById('triggerInput').value = t; };
    document.getElementById('triggersGrid').appendChild(c);
  });

  // Tone buttons
  document.querySelectorAll('.tone-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tone-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      generateScene(btn.dataset.tone);
    });
  });

  // Controls
  document.getElementById('newTakeBtn').addEventListener('click', () => { if (currentTone) generateScene(currentTone); });
  document.getElementById('copyBtn').addEventListener('click', () => {
    if (currentResponse) {
      navigator.clipboard.writeText(currentResponse).then(() => showToast('COPIED'));
    }
  });

  document.getElementById('exportBtn').addEventListener('click', () => {
    generateCaptions();
    document.getElementById('exportOptions').classList.add('active');
  });

  document.getElementById('exportClose').addEventListener('click', () => document.getElementById('exportOptions').classList.remove('active'));
  document.getElementById('exportOptions').addEventListener('click', e => { if (e.target === e.currentTarget) e.currentTarget.classList.remove('active'); });

  // Animation
  let animationTimeout = null;
  let uiTimeout = null;

  function playAnimation() {
    if (animationTimeout) clearTimeout(animationTimeout);
    if (uiTimeout) clearTimeout(uiTimeout);

    const overlay = document.getElementById('animateOverlay');
    overlay.classList.add('clean-mode');

    // Set card color
    const cardTop = document.getElementById('animCardTop');
    cardTop.style.background = CARD_COLOR_VALUES[currentCardColor] || '#FFE14D';

    document.getElementById('animContext').textContent = CONTEXT_LABELS[context];
    document.getElementById('animSpice').textContent = SPICE_LABELS[spice];
    document.getElementById('animTone').textContent = TONE_LABELS[currentTone];
    document.getElementById('animSubtext').textContent = currentSubtext;
    document.getElementById('animTrigger').textContent = currentTrigger;

    const responseEl = document.getElementById('animResponse');
    const words = currentResponse.split(' ');
    const html = words.map(word => {
      const chars = word.split('').map(c => `<span class="char">${c}</span>`).join('');
      return `<span class="word">${chars}</span>`;
    }).join(' ');
    responseEl.innerHTML = html;

    document.getElementById('animSubtext').classList.remove('show');
    document.getElementById('animTrigger').classList.remove('show');
    responseEl.querySelectorAll('.char').forEach(c => c.classList.remove('show'));

    setTimeout(() => document.getElementById('animSubtext').classList.add('show'), 300);
    setTimeout(() => document.getElementById('animTrigger').classList.add('show'), 900);

    const chars = responseEl.querySelectorAll('.char');
    chars.forEach((char, i) => {
      animationTimeout = setTimeout(() => char.classList.add('show'), 1400 + i * 35);
    });

    const totalDuration = 1400 + (chars.length * 35) + 1500;
    uiTimeout = setTimeout(() => { overlay.classList.remove('clean-mode'); }, totalDuration);
  }

  document.getElementById('animateBtn').addEventListener('click', () => {
    document.getElementById('animateOverlay').classList.add('active');
    playAnimation();
  });

  document.getElementById('replayBtn').addEventListener('click', playAnimation);

  document.getElementById('animCloseBtn').addEventListener('click', () => {
    document.getElementById('animateOverlay').classList.remove('active');
    if (animationTimeout) clearTimeout(animationTimeout);
    if (uiTimeout) clearTimeout(uiTimeout);
    document.getElementById('animateOverlay').classList.remove('clean-mode');
  });

  // Surprise button
  document.getElementById('surpriseBtn').addEventListener('click', () => {
    const randomTrigger = TRIGGERS[Math.floor(Math.random() * TRIGGERS.length)];
    const randomPhrase = randomTrigger.triggers[Math.floor(Math.random() * randomTrigger.triggers.length)];
    document.getElementById('triggerInput').value = randomPhrase;

    const contexts = ['stranger', 'family', 'colleague', 'medical'];
    const randomContext = contexts[Math.floor(Math.random() * contexts.length)];
    context = randomContext;
    document.querySelectorAll('#contextGroup .toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.context === randomContext));

    const spices = ['mild', 'medium', 'hot'];
    const randomSpice = spices[Math.floor(Math.random() * spices.length)];
    spice = randomSpice;
    document.querySelectorAll('#spiceGroup .spice-btn').forEach(b => b.classList.toggle('active', b.dataset.spice === randomSpice));

    const perspectives = ['i', 'we'];
    const randomPerspective = perspectives[Math.floor(Math.random() * perspectives.length)];
    perspective = randomPerspective;
    document.querySelectorAll('#perspectiveGroup .toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.perspective === randomPerspective));

    const tones = ['diplomat', 'critic', 'absurdist', 'realist'];
    const randomTone = tones[Math.floor(Math.random() * tones.length)];
    document.querySelectorAll('.tone-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.tone-btn[data-tone="${randomTone}"]`).classList.add('active');
    generateScene(randomTone);
  });

  // Captions
  const CAPTIONS = [
    "Things people actually say to us. Here's what we wish we'd said back.",
    "Filed under: comments that don't help.",
    "For everyone who's heard this one before.",
    "Words we've been saving.",
    "What I wanted to say vs. what I said: finally aligned.",
    "This one's for the well-meaning but clueless.",
    "Boundaries, but make it articulate.",
    "The script I needed years ago.",
    "Not all comments deserve a polite response.",
    "Sharing because someone needs to hear this isn't okay."
  ];

  const CAPTIONS_EDUCATIONAL = [
    "Sharing this to help people understand, not to call anyone out.",
    "For those who want to support someone going through this‚Äîhere's what actually helps.",
    "Swipe to see why this comment hurts more than it helps.",
    "Well-meaning doesn't always mean helpful. Here's what to know.",
    "If you've said this, you're not alone. Here's how to do better."
  ];

  function generateCaptions() {
    const isDual = document.getElementById('toggleDual').checked;
    const captionPool = isDual ? [...CAPTIONS_EDUCATIONAL, ...CAPTIONS.slice(0, 3)] : CAPTIONS;
    const shuffled = [...captionPool].sort(() => Math.random() - 0.5);
    const selected = shuffled.slice(0, 3);

    const container = document.getElementById('captionSuggestions');
    container.innerHTML = selected.map((c, i) => `<div class="caption-item" data-caption-index="${i}">${c}</div>`).join('');
    container.captionData = selected;

    container.querySelectorAll('.caption-item').forEach((el, i) => {
      el.addEventListener('click', () => {
        const text = selected[i] + ' #matterhood';
        navigator.clipboard.writeText(text).then(() => {
          container.querySelectorAll('.caption-item').forEach(c => c.classList.remove('copied'));
          el.classList.add('copied');
          showToast('CAPTION COPIED');
        });
      });
    });
  }

  document.getElementById('toggleDual').addEventListener('change', generateCaptions);

  // Export - Fixed to match site formatting exactly
  document.querySelectorAll('.export-format-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const format = btn.dataset.format;
      const dims = { story: { w: 1080, h: 1920 }, square: { w: 1080, h: 1080 }, wide: { w: 1200, h: 675 } }[format];
      await exportImage(dims.w, dims.h, format);
      document.getElementById('exportOptions').classList.remove('active');
    });
  });

  async function exportImage(w, h, format) {
    const isLight = document.documentElement.dataset.theme !== 'dark';
    const includeQR = document.getElementById('toggleQR').checked;

    // Colors - fixed for exports
    const cardColor = CARD_COLOR_VALUES[currentCardColor] || '#FFE14D';
    const black = '#0A0A0A';
    const white = '#FFFFFF';
    const bgColor = isLight ? white : black;
    const bottomBg = isLight ? white : '#141414';
    const textColor = isLight ? black : '#F5F5F5';
    const textDim = isLight ? '#6B6B6B' : '#999999';
    const borderColor = isLight ? black : '#F5F5F5';
    const borderLight = isLight ? '#E0E0E0' : '#333333';

    const scale = w / 1080;
    const padding = Math.round(45 * scale);
    const qrSize = Math.round(65 * scale);

    let qrDataUrl = null;
    if (includeQR) {
      const qrDiv = document.createElement('div');
      document.body.appendChild(qrDiv);
      new QRCode(qrDiv, { text: window.location.origin, width: qrSize * 3, height: qrSize * 3, colorDark: textColor, colorLight: 'transparent', correctLevel: QRCode.CorrectLevel.M });
      await new Promise(r => setTimeout(r, 150));
      const qrCanvas = qrDiv.querySelector('canvas');
      if (qrCanvas) qrDataUrl = qrCanvas.toDataURL();
      document.body.removeChild(qrDiv);
    }

    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');

    // Background with pattern
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, w, h);

    // Draw subtle dot pattern
    ctx.fillStyle = textColor;
    ctx.globalAlpha = 0.03;
    for (let x = 0; x < w; x += 24 * scale) {
      for (let y = 0; y < h; y += 24 * scale) {
        ctx.beginPath();
        ctx.arc(x, y, 1 * scale, 0, Math.PI * 2);
        ctx.fill();
      }
    }
    ctx.globalAlpha = 1;

    // Font sizes
    const fontSize = {
      stamp: Math.round(10 * scale),
      meta: Math.round(12 * scale),
      triggerLabel: Math.round(12 * scale),
      trigger: Math.round(format === 'wide' ? 26 * scale : 32 * scale),
      subtext: Math.round(13 * scale),
      responseLabel: Math.round(12 * scale),
      response: Math.round(format === 'wide' ? 24 * scale : 28 * scale),
      footer: Math.round(12 * scale)
    };

    const textW = Math.round(format === 'wide' ? w * 0.58 : w * 0.68);

    // Calculate content heights
    ctx.font = `italic ${fontSize.trigger}px 'Playfair Display', serif`;
    const triggerLines = wrapText(ctx, currentTrigger, textW - padding);
    
    ctx.font = `italic ${fontSize.subtext}px 'Space Mono', monospace`;
    const subtextLines = wrapText(ctx, 'SUBTEXT: ' + currentSubtext, textW - padding);

    ctx.font = `${fontSize.response}px 'Playfair Display', serif`;
    const responseLines = wrapText(ctx, currentResponse, textW - padding);

    // Card dimensions
    const topH = padding * 1.2 + fontSize.meta + padding * 0.4 + fontSize.triggerLabel + padding * 0.15 + 
                 triggerLines.length * fontSize.trigger * 1.25 + padding * 0.4 + 
                 subtextLines.length * fontSize.subtext * 1.5 + padding * 0.5;
    
    const bottomH = padding + fontSize.responseLabel + padding * 0.4 + 
                    responseLines.length * fontSize.response * 1.35 + padding * 0.5 +
                    (includeQR ? qrSize + padding * 0.3 : 0) +
                    padding * 0.3 + fontSize.footer + padding * 0.5;

    const frameW = textW + padding * 2;
    const frameH = topH + bottomH;
    const frameX = (w - frameW) / 2;
    const frameY = (h - frameH) / 2;

    // Draw card border
    ctx.strokeStyle = borderColor;
    ctx.lineWidth = 6 * scale;
    ctx.strokeRect(frameX, frameY, frameW, frameH);

    // Draw colored top section
    ctx.fillStyle = cardColor;
    ctx.fillRect(frameX + 3 * scale, frameY + 3 * scale, frameW - 6 * scale, topH - 3 * scale);

    // Draw bottom section
    ctx.fillStyle = bottomBg;
    ctx.fillRect(frameX + 3 * scale, frameY + topH, frameW - 6 * scale, bottomH - 3 * scale);

    // Divider line
    ctx.strokeStyle = borderColor;
    ctx.lineWidth = 3 * scale;
    ctx.beginPath();
    ctx.moveTo(frameX, frameY + topH);
    ctx.lineTo(frameX + frameW, frameY + topH);
    ctx.stroke();

    const contentX = frameX + padding;
    const contentRight = frameX + frameW - padding;
    let y = frameY + padding;

    // === TOP SECTION (all black text) ===
    
    // MATTERHOOD stamp
    ctx.fillStyle = black;
    ctx.globalAlpha = 0.7;
    ctx.font = `700 ${fontSize.stamp}px 'Space Mono', monospace`;
    ctx.textAlign = 'right';
    const stampText = 'MATTERHOOD';
    const stampW = ctx.measureText(stampText).width + 14 * scale;
    ctx.strokeStyle = black;
    ctx.lineWidth = 1.5 * scale;
    ctx.strokeRect(contentRight - stampW, y - 2 * scale, stampW, fontSize.stamp + 6 * scale);
    ctx.fillText(stampText, contentRight - 7 * scale, y + fontSize.stamp * 0.75);
    ctx.globalAlpha = 1;

    // Context
    y += fontSize.stamp + padding * 0.5;
    ctx.font = `700 ${fontSize.meta}px 'Space Mono', monospace`;
    ctx.textAlign = 'left';
    ctx.fillStyle = black;
    ctx.globalAlpha = 0.7;
    ctx.fillText(CONTEXT_LABELS[context], contentX, y);
    ctx.globalAlpha = 1;
    y += fontSize.meta + padding * 0.4;

    // "THEY SAID:" label
    ctx.fillStyle = black;
    ctx.globalAlpha = 0.6;
    ctx.font = `700 ${fontSize.triggerLabel}px 'Space Mono', monospace`;
    ctx.fillText('THEY SAID:', contentX, y);
    ctx.globalAlpha = 1;
    y += fontSize.triggerLabel + padding * 0.15;

    // Trigger text
    ctx.fillStyle = black;
    ctx.font = `italic ${fontSize.trigger}px 'Playfair Display', serif`;
    triggerLines.forEach(line => {
      ctx.fillText(line, contentX, y + fontSize.trigger * 0.85);
      y += fontSize.trigger * 1.25;
    });
    y += padding * 0.25;

    // Subtext divider
    ctx.strokeStyle = black;
    ctx.globalAlpha = 0.15;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(contentX, y);
    ctx.lineTo(contentRight - stampW - padding, y);
    ctx.stroke();
    ctx.globalAlpha = 1;
    y += padding * 0.35;

    // Subtext
    ctx.fillStyle = black;
    ctx.globalAlpha = 0.7;
    ctx.font = `italic ${fontSize.subtext}px 'Space Mono', monospace`;
    subtextLines.forEach(line => {
      ctx.fillText(line, contentX, y + fontSize.subtext);
      y += fontSize.subtext * 1.5;
    });
    ctx.globalAlpha = 1;

    // === BOTTOM SECTION ===
    y = frameY + topH + padding;

    // "RESPONSE" + tone badge
    ctx.fillStyle = textColor;
    ctx.font = `700 ${fontSize.responseLabel}px 'Space Mono', monospace`;
    ctx.textAlign = 'left';
    ctx.fillText('RESPONSE', contentX, y);

    const toneText = TONE_LABELS[currentTone];
    const responseWordW = ctx.measureText('RESPONSE ').width;
    const toneW = ctx.measureText(toneText).width + 10 * scale;
    
    // Tone badge
    ctx.fillStyle = textColor;
    ctx.fillRect(contentX + responseWordW + 6 * scale, y - fontSize.responseLabel * 0.75, toneW, fontSize.responseLabel + 4 * scale);
    ctx.fillStyle = bgColor;
    ctx.font = `700 ${fontSize.responseLabel * 0.85}px 'Space Mono', monospace`;
    ctx.fillText(toneText, contentX + responseWordW + 11 * scale, y);

    // Spice emoji
    ctx.textAlign = 'right';
    ctx.font = `${Math.round(20 * scale)}px Arial`;
    ctx.fillText(SPICE_LABELS[spice], contentRight, y);

    y += fontSize.responseLabel + padding * 0.4;

    // Response text
    ctx.textAlign = 'left';
    ctx.fillStyle = textColor;
    ctx.font = `${fontSize.response}px 'Playfair Display', serif`;
    responseLines.forEach(line => {
      ctx.fillText(line, contentX, y + fontSize.response * 0.85);
      y += fontSize.response * 1.35;
    });
    y += padding * 0.3;

    // QR code
    if (includeQR && qrDataUrl) {
      const qrImg = new Image();
      await new Promise(r => { qrImg.onload = r; qrImg.src = qrDataUrl; });
      ctx.drawImage(qrImg, contentRight - qrSize, y, qrSize, qrSize);
      y += qrSize + padding * 0.3;
    }

    // Footer line
    ctx.strokeStyle = borderLight;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(contentX, y);
    ctx.lineTo(contentRight, y);
    ctx.stroke();
    y += padding * 0.35;

    // Footer text
    ctx.fillStyle = textDim;
    ctx.font = `700 ${fontSize.footer}px 'Space Mono', monospace`;
    ctx.textAlign = 'left';
    ctx.fillText('THE PROTOCOL', contentX, y + fontSize.footer);
    ctx.textAlign = 'right';
    ctx.fillText('MATTERHOOD', contentRight, y + fontSize.footer);

    // Download
    const link = document.createElement('a');
    link.download = `protocol-${format}-${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
    showToast('EXPORTED');
  }

  function wrapText(ctx, text, maxW) {
    const words = text.split(' '), lines = [];
    let line = '';
    for (const word of words) {
      const test = line ? line + ' ' + word : word;
      if (ctx.measureText(test).width > maxW && line) { lines.push(line); line = word; }
      else { line = test; }
    }
    if (line) lines.push(line);
    return lines;
  }

  // Mobile back button
  document.getElementById('backBtn').addEventListener('click', () => {
    document.getElementById('controlPanel').classList.remove('hidden');
    document.getElementById('displayPanel').classList.add('hidden');
    document.getElementById('backBtn').style.display = 'none';
  });

  // Enter key
  document.getElementById('triggerInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const activeTone = document.querySelector('.tone-btn.active');
      if (activeTone) { generateScene(activeTone.dataset.tone); }
      else { document.querySelector('.tone-btn[data-tone="diplomat"]').click(); }
    }
  });
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// Theme toggle
const themeToggle = document.getElementById('themeToggle');
function setTheme(theme) {
  document.documentElement.dataset.theme = theme;
  themeToggle.textContent = theme === 'dark' ? '‚òÄ' : '‚òæ';
  localStorage.setItem('protocol_theme', theme);
}

themeToggle.addEventListener('click', () => {
  const current = document.documentElement.dataset.theme;
  setTheme(current === 'dark' ? 'light' : 'dark');
});

const savedTheme = localStorage.getItem('protocol_theme') || 'light';
setTheme(savedTheme);

// Start
loadTriggers();
</script>
</body>
</html>
