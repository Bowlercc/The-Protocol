<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THE PROTOCOL — Admin Panel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--void:#080808;--charcoal:#121212;--bone:#E8E4DF;--cream:#F5F2ED;--bone-dim:rgba(232,228,223,0.7);--bone-faint:rgba(232,228,223,0.15);--bone-ghost:rgba(232,228,223,0.06);--alert:#C41E1E;--gold:#B8956A;--gold-dim:rgba(184,149,106,0.4);--success:#4A7C59}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Space Mono',monospace;background:var(--void);color:var(--bone);min-height:100vh;-webkit-font-smoothing:antialiased}
.container{max-width:1400px;margin:0 auto;padding:1.5rem}

/* Header */
header{border-bottom:1px solid var(--bone-faint);padding-bottom:1rem;margin-bottom:1.5rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
.logo{font-size:.7rem;font-weight:700;letter-spacing:.3em}
.logo-sub{font-size:.5rem;letter-spacing:.15em;opacity:.3;margin-left:.5rem}
.header-actions{display:flex;gap:.5rem}
.btn{background:var(--bone-ghost);color:var(--bone);border:1px solid var(--bone-faint);padding:.6rem 1rem;font-family:'Space Mono',monospace;font-size:.55rem;letter-spacing:.1em;cursor:pointer;transition:all .2s}
.btn:hover{background:var(--bone-faint);border-color:var(--bone-dim)}
.btn.primary{background:var(--bone);color:var(--void)}
.btn.primary:hover{background:var(--cream)}
.btn.success{background:var(--success);color:var(--cream);border-color:var(--success)}
.btn.danger{border-color:var(--alert);color:var(--alert)}
.btn.danger:hover{background:var(--alert);color:var(--cream)}

/* Stats bar */
.stats-bar{display:flex;gap:2rem;padding:1rem;background:var(--charcoal);border:1px solid var(--bone-faint);margin-bottom:1.5rem;flex-wrap:wrap}
.stat{display:flex;flex-direction:column;gap:.2rem}
.stat-value{font-size:1.5rem;color:var(--gold);font-family:'Playfair Display',serif}
.stat-label{font-size:.5rem;letter-spacing:.15em;opacity:.5}

/* Layout */
.main-layout{display:flex;gap:1.5rem}
.sidebar{width:300px;min-width:250px;display:flex;flex-direction:column;gap:1rem}
.editor-area{flex:1;min-width:0}

/* Trigger list */
.trigger-list{background:var(--charcoal);border:1px solid var(--bone-faint);max-height:calc(100vh - 280px);overflow-y:auto}
.trigger-item{padding:.8rem 1rem;border-bottom:1px solid var(--bone-faint);cursor:pointer;transition:all .2s;display:flex;justify-content:space-between;align-items:center;gap:.5rem}
.trigger-item:hover{background:var(--bone-ghost)}
.trigger-item.active{background:var(--bone);color:var(--void)}
.trigger-item.active .trigger-item-sub{color:var(--void);opacity:.6}
.trigger-item-main{font-size:.65rem;letter-spacing:.05em;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.trigger-item-sub{font-size:.5rem;opacity:.4}
.trigger-item-count{font-size:.5rem;opacity:.5;background:var(--bone-ghost);padding:.2rem .4rem;border-radius:2px}
.trigger-item.active .trigger-item-count{background:rgba(0,0,0,.2)}

/* Search */
.search-box{background:var(--charcoal);border:1px solid var(--bone-faint);padding:.8rem;margin-bottom:0}
.search-input{width:100%;background:transparent;border:none;color:var(--bone);font-family:'Space Mono',monospace;font-size:.65rem;outline:none}
.search-input::placeholder{color:var(--bone-dim);opacity:.4}

/* Editor */
.editor-panel{background:var(--charcoal);border:1px solid var(--bone-faint);padding:1.5rem}
.editor-title{font-family:'Playfair Display',serif;font-size:1.3rem;margin-bottom:1.2rem;display:flex;justify-content:space-between;align-items:center}
.editor-section{margin-bottom:1.5rem}
.editor-label{font-size:.5rem;letter-spacing:.2em;opacity:.5;margin-bottom:.5rem;display:block}
.editor-input{width:100%;background:var(--bone-ghost);border:1px solid var(--bone-faint);color:var(--bone);padding:.7rem;font-family:'Space Mono',monospace;font-size:.6rem;outline:none;transition:border-color .2s}
.editor-input:focus{border-color:var(--gold)}
.editor-input::placeholder{color:var(--bone-dim);opacity:.3}
textarea.editor-input{min-height:80px;resize:vertical;line-height:1.6}

/* Trigger phrases */
.trigger-phrases{display:flex;flex-wrap:wrap;gap:.3rem;margin-bottom:.5rem}
.trigger-phrase{background:var(--bone-ghost);border:1px solid var(--bone-faint);padding:.4rem .6rem;font-size:.55rem;display:flex;align-items:center;gap:.4rem}
.trigger-phrase-remove{background:none;border:none;color:var(--alert);cursor:pointer;font-size:.7rem;line-height:1;opacity:.6}
.trigger-phrase-remove:hover{opacity:1}
.add-phrase-row{display:flex;gap:.3rem}
.add-phrase-row input{flex:1}
.add-phrase-row .btn{padding:.5rem .7rem}

/* Response grid */
.response-grid{display:grid;grid-template-columns:repeat(4, 1fr);gap:1rem;margin-top:1rem}
.response-column{display:flex;flex-direction:column;gap:.5rem}
.response-column-header{font-size:.55rem;letter-spacing:.15em;text-align:center;padding:.5rem;background:var(--bone-ghost);color:var(--gold)}
.response-level{display:flex;flex-direction:column;gap:.3rem}
.response-level-label{font-size:.45rem;letter-spacing:.1em;opacity:.4;padding-left:.3rem}
.response-level-label.hot{color:var(--alert)}
.response-level-label.medium{color:var(--gold)}
.response-textarea{width:100%;background:var(--bone-ghost);border:1px solid var(--bone-faint);color:var(--bone);padding:.5rem;font-family:'Space Mono',monospace;font-size:.5rem;outline:none;min-height:120px;resize:vertical;line-height:1.5}
.response-textarea:focus{border-color:var(--gold)}
.response-textarea::placeholder{opacity:.3}
.response-count{font-size:.45rem;opacity:.4;text-align:right;margin-top:.2rem}

/* Empty state */
.empty-state{text-align:center;padding:4rem 2rem;opacity:.4}
.empty-state-icon{font-size:3rem;margin-bottom:1rem;opacity:.3}
.empty-state-text{font-family:'Playfair Display',serif;font-size:1.1rem;font-style:italic}

/* Toast */
.toast{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%) translateY(150%);background:var(--void);border:1px solid var(--gold);color:var(--bone);padding:.8rem 1.2rem;font-size:.55rem;letter-spacing:.1em;z-index:1000;transition:transform .3s}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.error{border-color:var(--alert)}
.toast.success{border-color:var(--success)}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:1000;display:none;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--charcoal);border:1px solid var(--bone-faint);padding:2rem;max-width:500px;width:90%}
.modal-title{font-family:'Playfair Display',serif;font-size:1.2rem;margin-bottom:1rem}
.modal-text{font-size:.6rem;opacity:.7;margin-bottom:1.5rem;line-height:1.6}
.modal-actions{display:flex;gap:.5rem;justify-content:flex-end}

/* Responsive */
@media(max-width:900px){
  .main-layout{flex-direction:column}
  .sidebar{width:100%}
  .trigger-list{max-height:300px}
  .response-grid{grid-template-columns:repeat(2, 1fr)}
}
@media(max-width:600px){
  .response-grid{grid-template-columns:1fr}
  .stats-bar{gap:1rem}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <span class="logo">THE PROTOCOL</span>
      <span class="logo-sub">ADMIN</span>
    </div>
    <div class="header-actions">
      <button class="btn" onclick="addNewTrigger()">+ NEW TRIGGER</button>
      <button class="btn" onclick="exportJSON()">EXPORT JSON</button>
      <button class="btn primary" onclick="saveAll()">SAVE ALL</button>
      <a href="app.html" class="btn">← BACK TO APP</a>
    </div>
  </header>

  <div class="stats-bar">
    <div class="stat">
      <span class="stat-value" id="statTriggers">0</span>
      <span class="stat-label">TRIGGERS</span>
    </div>
    <div class="stat">
      <span class="stat-value" id="statResponses">0</span>
      <span class="stat-label">RESPONSES</span>
    </div>
    <div class="stat">
      <span class="stat-value" id="statTones">4</span>
      <span class="stat-label">TONES</span>
    </div>
    <div class="stat">
      <span class="stat-value" id="statLevels">3</span>
      <span class="stat-label">SPICE LEVELS</span>
    </div>
  </div>

  <div class="main-layout">
    <div class="sidebar">
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="Search triggers..." oninput="filterTriggers()">
      </div>
      <div class="trigger-list" id="triggerList">
        <!-- Populated by JS -->
      </div>
    </div>
    
    <div class="editor-area">
      <div class="editor-panel" id="editorPanel">
        <div class="empty-state" id="emptyState">
          <div class="empty-state-icon">◇</div>
          <div class="empty-state-text">Select a trigger to edit</div>
        </div>
        
        <div id="editorContent" style="display:none">
          <div class="editor-title">
            <span id="editorTitleText">Edit Trigger</span>
            <button class="btn danger" onclick="deleteTrigger()">DELETE</button>
          </div>
          
          <div class="editor-section">
            <label class="editor-label">TRIGGER PHRASES (what people say)</label>
            <div class="trigger-phrases" id="triggerPhrases"></div>
            <div class="add-phrase-row">
              <input type="text" class="editor-input" id="newPhraseInput" placeholder="Add new phrase...">
              <button class="btn" onclick="addPhrase()">ADD</button>
            </div>
          </div>
          
          <div class="editor-section">
            <label class="editor-label">SUBTEXT (the hidden meaning)</label>
            <input type="text" class="editor-input" id="subtextInput" placeholder="What they really mean...">
          </div>
          
          <div class="editor-section">
            <label class="editor-label">BACKGROUND IMAGE URL</label>
            <input type="text" class="editor-input" id="imageInput" placeholder="https://images.unsplash.com/...">
          </div>
          
          <div class="editor-section">
            <label class="editor-label">RESPONSES</label>
            <div class="response-grid">
              <div class="response-column">
                <div class="response-column-header">DIPLOMAT</div>
                <div class="response-level">
                  <span class="response-level-label">MILD</span>
                  <textarea class="response-textarea" id="resp-diplomat-mild" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-diplomat-mild">0 responses</span>
                </div>
                <div class="response-level">
                  <span class="response-level-label medium">MEDIUM</span>
                  <textarea class="response-textarea" id="resp-diplomat-medium" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-diplomat-medium">0 responses</span>
                </div>
                <div class="response-level">
                  <span class="response-level-label hot">HOT</span>
                  <textarea class="response-textarea" id="resp-diplomat-hot" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-diplomat-hot">0 responses</span>
                </div>
              </div>
              
              <div class="response-column">
                <div class="response-column-header">CRITIC</div>
                <div class="response-level">
                  <span class="response-level-label">MILD</span>
                  <textarea class="response-textarea" id="resp-critic-mild" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-critic-mild">0 responses</span>
                </div>
                <div class="response-level">
                  <span class="response-level-label medium">MEDIUM</span>
                  <textarea class="response-textarea" id="resp-critic-medium" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-critic-medium">0 responses</span>
                </div>
                <div class="response-level">
                  <span class="response-level-label hot">HOT</span>
                  <textarea class="response-textarea" id="resp-critic-hot" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-critic-hot">0 responses</span>
                </div>
              </div>
              
              <div class="response-column">
                <div class="response-column-header">ABSURDIST</div>
                <div class="response-level">
                  <span class="response-level-label">MILD</span>
                  <textarea class="response-textarea" id="resp-absurdist-mild" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-absurdist-mild">0 responses</span>
                </div>
                <div class="response-level">
                  <span class="response-level-label medium">MEDIUM</span>
                  <textarea class="response-textarea" id="resp-absurdist-medium" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-absurdist-medium">0 responses</span>
                </div>
                <div class="response-level">
                  <span class="response-level-label hot">HOT</span>
                  <textarea class="response-textarea" id="resp-absurdist-hot" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-absurdist-hot">0 responses</span>
                </div>
              </div>
              
              <div class="response-column">
                <div class="response-column-header">REALIST</div>
                <div class="response-level">
                  <span class="response-level-label">MILD</span>
                  <textarea class="response-textarea" id="resp-realist-mild" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-realist-mild">0 responses</span>
                </div>
                <div class="response-level">
                  <span class="response-level-label medium">MEDIUM</span>
                  <textarea class="response-textarea" id="resp-realist-medium" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-realist-medium">0 responses</span>
                </div>
                <div class="response-level">
                  <span class="response-level-label hot">HOT</span>
                  <textarea class="response-textarea" id="resp-realist-hot" placeholder="One response per line..."></textarea>
                  <span class="response-count" id="count-realist-hot">0 responses</span>
                </div>
              </div>
            </div>
          </div>
          
          <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:1.5rem">
            <button class="btn" onclick="revertChanges()">REVERT</button>
            <button class="btn primary" onclick="saveCurrentTrigger()">SAVE TRIGGER</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete confirmation modal -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal">
    <div class="modal-title">Delete Trigger?</div>
    <div class="modal-text">This will permanently remove this trigger and all its responses. This action cannot be undone.</div>
    <div class="modal-actions">
      <button class="btn" onclick="closeDeleteModal()">CANCEL</button>
      <button class="btn danger" onclick="confirmDelete()">DELETE</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
let triggers = [];
let currentIndex = -1;
let hasUnsavedChanges = false;

const TONES = ['diplomat', 'critic', 'absurdist', 'realist'];
const LEVELS = ['mild', 'medium', 'hot'];

// Load triggers
async function loadTriggers() {
  try {
    const response = await fetch('triggers.json');
    triggers = await response.json();
    renderTriggerList();
    updateStats();
    showToast(`Loaded ${triggers.length} triggers`, 'success');
  } catch (err) {
    console.error('Failed to load triggers:', err);
    showToast('Failed to load triggers', 'error');
  }
}

// Render trigger list
function renderTriggerList() {
  const list = document.getElementById('triggerList');
  const search = document.getElementById('searchInput').value.toLowerCase();
  
  list.innerHTML = triggers
    .map((t, i) => {
      const mainPhrase = t.triggers[0] || 'Untitled';
      const matchesSearch = !search || 
        t.triggers.some(p => p.toLowerCase().includes(search)) ||
        (t.subtext && t.subtext.toLowerCase().includes(search));
      
      if (!matchesSearch) return '';
      
      const responseCount = countResponses(t);
      return `
        <div class="trigger-item ${i === currentIndex ? 'active' : ''}" onclick="selectTrigger(${i})">
          <span class="trigger-item-main">${escapeHtml(mainPhrase)}</span>
          <span class="trigger-item-count">${responseCount}</span>
        </div>
      `;
    })
    .join('');
}

// Count responses in a trigger
function countResponses(trigger) {
  let count = 0;
  if (trigger.responses) {
    for (const tone of TONES) {
      if (trigger.responses[tone]) {
        for (const level of LEVELS) {
          if (trigger.responses[tone][level]) {
            count += trigger.responses[tone][level].length;
          }
        }
      }
    }
  }
  return count;
}

// Update stats
function updateStats() {
  document.getElementById('statTriggers').textContent = triggers.length;
  
  let totalResponses = 0;
  triggers.forEach(t => totalResponses += countResponses(t));
  document.getElementById('statResponses').textContent = totalResponses;
}

// Select trigger for editing
function selectTrigger(index) {
  if (hasUnsavedChanges && currentIndex !== index) {
    if (!confirm('You have unsaved changes. Discard them?')) return;
  }
  
  currentIndex = index;
  hasUnsavedChanges = false;
  renderTriggerList();
  loadTriggerIntoEditor();
}

// Load trigger into editor
function loadTriggerIntoEditor() {
  const trigger = triggers[currentIndex];
  if (!trigger) return;
  
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('editorContent').style.display = 'block';
  document.getElementById('editorTitleText').textContent = trigger.triggers[0] || 'Edit Trigger';
  
  // Trigger phrases
  renderTriggerPhrases();
  
  // Subtext and image
  document.getElementById('subtextInput').value = trigger.subtext || '';
  document.getElementById('imageInput').value = trigger.image || '';
  
  // Responses
  for (const tone of TONES) {
    for (const level of LEVELS) {
      const textarea = document.getElementById(`resp-${tone}-${level}`);
      const responses = trigger.responses?.[tone]?.[level] || [];
      textarea.value = responses.join('\n');
      updateResponseCount(tone, level);
    }
  }
  
  // Add change listeners
  document.querySelectorAll('.editor-input, .response-textarea').forEach(el => {
    el.onchange = () => hasUnsavedChanges = true;
    el.oninput = () => {
      if (el.classList.contains('response-textarea')) {
        const [_, tone, level] = el.id.split('-');
        updateResponseCount(tone, level);
      }
    };
  });
}

// Render trigger phrases
function renderTriggerPhrases() {
  const container = document.getElementById('triggerPhrases');
  const trigger = triggers[currentIndex];
  
  container.innerHTML = trigger.triggers
    .map((phrase, i) => `
      <div class="trigger-phrase">
        <span>${escapeHtml(phrase)}</span>
        <button class="trigger-phrase-remove" onclick="removePhrase(${i})">×</button>
      </div>
    `)
    .join('');
}

// Add phrase
function addPhrase() {
  const input = document.getElementById('newPhraseInput');
  const phrase = input.value.trim();
  if (!phrase) return;
  
  triggers[currentIndex].triggers.push(phrase);
  input.value = '';
  renderTriggerPhrases();
  hasUnsavedChanges = true;
}

// Remove phrase
function removePhrase(index) {
  if (triggers[currentIndex].triggers.length <= 1) {
    showToast('Must have at least one phrase', 'error');
    return;
  }
  triggers[currentIndex].triggers.splice(index, 1);
  renderTriggerPhrases();
  hasUnsavedChanges = true;
}

// Update response count
function updateResponseCount(tone, level) {
  const textarea = document.getElementById(`resp-${tone}-${level}`);
  const count = textarea.value.split('\n').filter(l => l.trim()).length;
  document.getElementById(`count-${tone}-${level}`).textContent = `${count} response${count !== 1 ? 's' : ''}`;
}

// Save current trigger
function saveCurrentTrigger() {
  const trigger = triggers[currentIndex];
  
  trigger.subtext = document.getElementById('subtextInput').value.trim();
  trigger.image = document.getElementById('imageInput').value.trim();
  
  // Initialize responses if needed
  if (!trigger.responses) trigger.responses = {};
  
  for (const tone of TONES) {
    if (!trigger.responses[tone]) trigger.responses[tone] = {};
    for (const level of LEVELS) {
      const textarea = document.getElementById(`resp-${tone}-${level}`);
      const responses = textarea.value.split('\n').map(l => l.trim()).filter(l => l);
      trigger.responses[tone][level] = responses;
    }
  }
  
  hasUnsavedChanges = false;
  renderTriggerList();
  updateStats();
  showToast('Trigger saved (in memory)', 'success');
}

// Revert changes
function revertChanges() {
  if (!confirm('Revert all changes to this trigger?')) return;
  hasUnsavedChanges = false;
  loadTriggerIntoEditor();
  showToast('Changes reverted');
}

// Add new trigger
function addNewTrigger() {
  const newTrigger = {
    triggers: ['New trigger'],
    subtext: '',
    image: '',
    responses: {
      diplomat: { mild: [], medium: [], hot: [] },
      critic: { mild: [], medium: [], hot: [] },
      absurdist: { mild: [], medium: [], hot: [] },
      realist: { mild: [], medium: [], hot: [] }
    }
  };
  
  triggers.unshift(newTrigger);
  currentIndex = 0;
  hasUnsavedChanges = true;
  renderTriggerList();
  loadTriggerIntoEditor();
  updateStats();
  showToast('New trigger added');
}

// Delete trigger
function deleteTrigger() {
  document.getElementById('deleteModal').classList.add('active');
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('active');
}

function confirmDelete() {
  triggers.splice(currentIndex, 1);
  currentIndex = -1;
  hasUnsavedChanges = false;
  
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('editorContent').style.display = 'none';
  
  renderTriggerList();
  updateStats();
  closeDeleteModal();
  showToast('Trigger deleted');
}

// Filter triggers
function filterTriggers() {
  renderTriggerList();
}

// Export JSON
function exportJSON() {
  const blob = new Blob([JSON.stringify(triggers, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'triggers.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('JSON exported');
}

// Save all (download)
function saveAll() {
  // Save current trigger first if editing
  if (currentIndex >= 0) {
    saveCurrentTrigger();
  }
  exportJSON();
  showToast('All changes exported to JSON', 'success');
}

// Toast
function showToast(message, type = '') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show' + (type ? ` ${type}` : '');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// Escape HTML
function escapeHtml(str) {
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// Enter key for phrase input
document.getElementById('newPhraseInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') addPhrase();
});

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', e => {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// Initialize
loadTriggers();
</script>
</body>
</html>
